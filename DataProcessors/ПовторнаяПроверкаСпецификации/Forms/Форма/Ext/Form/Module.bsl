
&НаСервере
Процедура ПриСозданииНаСервере(Отказ, СтандартнаяОбработка)
	
	Спецификация = Параметры.Спецификация;
	Подразделение = Спецификация.Подразделение;
		
КонецПроцедуры

&НаКлиенте
Процедура ПриОткрытии(Отказ)
	
	ПараметрыФормы = Новый Структура;
	ПараметрыФормы.Вставить("Подразделение", Подразделение);
	ПараметрыФормы.Вставить("ПовторнаяПроверка", Истина);
	
	ОткрытьФорму("Документ.Спецификация.Форма.ФормаДетали", ПараметрыФормы, ЭтаФорма);
	
КонецПроцедуры

&НаКлиенте
Процедура ОбработкаВыбора(ВыбранноеЗначение, ИсточникВыбора)
	
	ЗагрузитьТаблицаДеталей(ВыбранноеЗначение);
	 	
КонецПроцедуры

&НаСервере
Процедура ЗагрузитьТаблицаДеталей(АдресТаблицы)
		
	ТаблицаДеталей.Загрузить(ПолучитьИзВременногоХранилища(АдресТаблицы));
	НоваяТаблица = РеквизитФормыВЗначение("ТаблицаДеталей");
	
	ТаблицаСпецификации = Спецификация.СписокМатериалы.Выгрузить();
	
	Для Каждого Строка Из ТаблицаСпецификации Цикл
				
		СтруктураПоиска = Новый Структура;
		СтруктураПоиска.Вставить("Проверка", Ложь);
		СтруктураПоиска.Вставить("Материал", Строка.Материал);
		СтруктураПоиска.Вставить("ВысотаДетали", Строка.ВысотаДетали);
		СтруктураПоиска.Вставить("ШиринаДетали", Строка.ШиринаДетали);
		СтруктураПоиска.Вставить("Количество", Строка.Количество);
		СтруктураПоиска.Вставить("Номенклатура", Строка.Номенклатура);
		СтруктураПоиска.Вставить("ВыборМебельнойКромкиСверху", Строка.ВыборМебельнойКромкиСверху);
		СтруктураПоиска.Вставить("ВыборМебельнойКромкиСлева", Строка.ВыборМебельнойКромкиСлева);
		СтруктураПоиска.Вставить("ВыборМебельнойКромкиСнизу", Строка.ВыборМебельнойКромкиСнизу); 
		СтруктураПоиска.Вставить("ВыборМебельнойКромкиСправа", Строка.ВыборМебельнойКромкиСправа);
		//СтруктураПоиска.Вставить("Гравировка", Строка.Гравировка);
		//СтруктураПоиска.Вставить("ДанныеДляФлэшПоГравировке", Строка.ДанныеДляФлэшПоГравировке);
		СтруктураПоиска.Вставить("ДетальРедактированная", Строка.ДетальРедактированная);
		СтруктураПоиска.Вставить("ДиаметрПазов", Строка.ДиаметрПазов);
		//СтруктураПоиска.Вставить("ДлинаКривогоПила", Строка.ДлинаКривогоПила);
		//СтруктураПоиска.Вставить("Идентификатор", Строка.Идентификатор);
		//СтруктураПоиска.Вставить("Кант", Строка.Кант);
		//СтруктураПоиска.Вставить("КантыИзРедактора", Строка.КантыИзРедактора);
		СтруктураПоиска.Вставить("КоличествоПетель", Строка.КоличествоПетель);
		СтруктураПоиска.Вставить("КривойПилСверху", Строка.КривойПилСверху);
		СтруктураПоиска.Вставить("КривойПилСлева", Строка.КривойПилСлева);
		СтруктураПоиска.Вставить("КривойПилСнизу", Строка.КривойПилСнизу);
		СтруктураПоиска.Вставить("КривойПилСправа", Строка.КривойПилСправа);
		//СтруктураПоиска.Вставить("Кромка045мм", Строка.Кромка045мм);
		//СтруктураПоиска.Вставить("Кромка2мм", Строка.Кромка2мм);
		СтруктураПоиска.Вставить("НеТорцевать", Строка.НеТорцевать);
		СтруктураПоиска.Вставить("НоменклатураДляСклеивания", Строка.НоменклатураДляСклеивания);
		СтруктураПоиска.Вставить("Обтачивать", Строка.Обтачивать);
		СтруктураПоиска.Вставить("ОтверстийПодРучку", Строка.ОтверстийПодРучку);
		СтруктураПоиска.Вставить("Периметр", Строка.Периметр);
		СтруктураПоиска.Вставить("Петли", Строка.Петли);
		СтруктураПоиска.Вставить("ПоложениеРучки", Строка.ПоложениеРучки);
		//СтруктураПоиска.Вставить("ПоложениеТекстуры", Строка.ПоложениеТекстуры);
		СтруктураПоиска.Вставить("РадиусЛевоВерх", Строка.РадиусЛевоВерх);
		СтруктураПоиска.Вставить("РадиусЛевоНиз", Строка.РадиусЛевоНиз);
		СтруктураПоиска.Вставить("РадиусПравоВерх", Строка.РадиусПравоВерх);
		СтруктураПоиска.Вставить("РадиусПравоНиз", Строка.РадиусПравоНиз);
		СтруктураПоиска.Вставить("РадиусФасада", Строка.РадиусФасада);
		//СтруктураПоиска.Вставить("РазмерГравировки", Строка.РазмерГравировки);
		СтруктураПоиска.Вставить("РасположениеПазов", Строка.РасположениеПазов);
		СтруктураПоиска.Вставить("СоблюдениеТекстуры", Строка.СоблюдениеТекстуры);
		СтруктураПоиска.Вставить("Срез", Строка.Срез);
		//СтруктураПоиска.Вставить("ТекстураГравировки", Строка.ТекстураГравировки);
		//СтруктураПоиска.Вставить("УниверсальнаяКромка", Строка.УниверсальнаяКромка);
		//СтруктураОтверстий
		
		
		МассивПоиска = НоваяТаблица.НайтиСтроки(СтруктураПоиска);
		Если МассивПоиска.Количество() > 0 Тогда
			НоваяСтрока = МассивПоиска[0];
		Иначе
			НоваяСтрока = НоваяТаблица.Добавить();
		КонецЕсли;
		
		НоваяСтрока.НоменклатураСпецификации = Строка.Номенклатура;
		НоваяСтрока.МатериалСпецификации = Строка.Материал;
		НоваяСтрока.ШиринаДеталиСпецификации = Строка.ШиринаДетали;
		НоваяСтрока.ВысотаДеталиСпецификации = Строка.ВысотаДетали;
		НоваяСтрока.КоличествоСпецификации = Строка.Количество;
		НоваяСтрока.НомерСтрокиСпецификации = Строка.НомерСтроки;
		НоваяСтрока.Проверка = Истина;
	КонецЦикла;
	
	НоваяТаблица.ЗаполнитьЗначения(Ложь, "Проверка");
	ЗначениеВРеквизитФормы(НоваяТаблица, "ТаблицаДеталей");
		
КонецПроцедуры

&НаКлиенте
Процедура ПроверитьДетали(Команда)
	
	ТаблицаДляФормы = ТаблицаДеталей;
	
	ПустыеСтроки = ТаблицаДляФормы.НайтиСтроки(Новый Структура("Материал", ""));
	Для Каждого Строка Из ПустыеСтроки Цикл
		ТаблицаДляФормы.Удалить(Строка);
	КонецЦикла;
	
	ЗагрузитьТаблицаДеталей(ВыгрузитьНужнуюТаблицуВХранилище(ТаблицаДляФормы));
	
КонецПроцедуры

&НаКлиенте
Процедура ТаблицаДеталейВыбор(Элемент, ВыбраннаяСтрока, Поле, СтандартнаяОбработка)
	
	Если Поле.Родитель = Элементы.ТаблицаДеталейГруппаСпецификации Тогда
		
		ПараметрыФормы = Новый Структура;
		ПараметрыФормы.Вставить("Ключ", Спецификация);
		ПараметрыФормы.Вставить("ПовторнаяПроверка", Истина);
		ПараметрыФормы.Вставить("НомерСтроки", Элементы.ТаблицаДеталей.ТекущиеДанные.НомерСтрокиСпецификации);
		
		ОткрытьФорму("Документ.Спецификация.ФормаОбъекта", ПараметрыФормы, ЭтаФорма);
		
	ИначеЕсли Поле.Родитель = Элементы.ТаблицаДеталейГруппаПроверки Тогда
		
		ТаблицаДляФормы = ТаблицаДеталей;
		
		ПустыеСтроки = ТаблицаДляФормы.НайтиСтроки(Новый Структура("Материал", ""));
		Для Каждого Строка Из ПустыеСтроки Цикл
			ТаблицаДляФормы.Удалить(Строка);
		КонецЦикла;
		
		АдресТаблицы = ВыгрузитьНужнуюТаблицуВХранилище(ТаблицаДляФормы);
		
		ПараметрыФормы = Новый Структура;
		ПараметрыФормы.Вставить("АдресТаблицы", АдресТаблицы);
		ПараметрыФормы.Вставить("Подразделение", Подразделение);
		ПараметрыФормы.Вставить("ПовторнаяПроверка", Истина);
		ПараметрыФормы.Вставить("Идентификатор", Элементы.ТаблицаДеталей.ТекущиеДанные.НомерСтроки - 1);
		
		ОткрытьФорму("Документ.Спецификация.Форма.ФормаДетали", ПараметрыФормы, ЭтаФорма);
		
	КонецЕсли;
	
КонецПроцедуры

&НаСервере
Функция ВыгрузитьНужнуюТаблицуВХранилище(Таблица)
	
	Возврат ПоместитьВоВременноеХранилище(Таблица.Выгрузить());
	
КонецФункции 