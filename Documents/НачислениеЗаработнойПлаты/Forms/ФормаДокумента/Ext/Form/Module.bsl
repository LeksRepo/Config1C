
&НаКлиенте
Процедура Заполнить(Команда)
	
	Если Объект.СписокФизлиц.Количество() > 0 Тогда
		
		Режим = РежимДиалогаВопрос.ДаНет;
		Текст = "Таблица будет перезаполнена" + Символы.ПС + "Продолжить?" ;
		
		Если Вопрос(Текст, Режим, 0) = КодВозвратаДиалога.Нет Тогда
			Возврат;
		КонецЕсли;
		
		Объект.СписокФизлиц.Очистить();
		ЗаполнитьНаСервере();
		
	Иначе
		
		ЗаполнитьНаСервере();
		
	КонецЕсли;
	
КонецПроцедуры

&НаСервере
Процедура ЗаполнитьНаСервере()
	
	Если Объект.ВидНачисления = Перечисления.ВидыНачисленийЗаработнойПлаты.Монтажники Тогда
		
		Запрос = Новый Запрос;
		Запрос.УстановитьПараметр("Подразделение", Объект.Подразделение);
		Запрос.УстановитьПараметр("НачалоПериода", Объект.НачалоПериода);
		Запрос.УстановитьПараметр("ОкончаниеПериода", КонецДня(Объект.ОкончаниеПериода));
		Запрос.УстановитьПараметр("Счет", ПланыСчетов.Управленческий.ПоказателиСотрудника);
		Запрос.УстановитьПараметр("Регион", Объект.Подразделение.Регион);
		
		Запрос.Текст =
		"ВЫБРАТЬ
		|	УправленческийОбороты.Субконто2 КАК Монтажник,
		|	УправленческийОбороты.Субконто1 КАК Статья,
		|	УправленческийОбороты.СуммаОборот КАК Количество,
		|	ЦеныЗаКилометры.ПлановаяЗакупочная КАК ЦенаЗаКилометр,
		|	ЦеныЗаКвадратныеМетры.ПлановаяЗакупочная КАК ЦенаЗаКвадратныйМетр
		|ИЗ
		|	РегистрБухгалтерии.Управленческий.Обороты(
		|			&НачалоПериода,
		|			&ОкончаниеПериода,
		|			,
		|			Счет = &Счет,
		|			,
		|			Подразделение = &Подразделение
		|				И Субконто2.ОсновнаяДолжность = ЗНАЧЕНИЕ(Справочник.Должности.Монтажник)
		|				И (Субконто1 = ЗНАЧЕНИЕ(Перечисление.ВидыПоказателейСотрудников.КилометровУдаленныхМонтажей)
		|					ИЛИ Субконто1 = ЗНАЧЕНИЕ(Перечисление.ВидыПоказателейСотрудников.КоличествоМетровУстановленныхИзделий)),
		|			,
		|			) КАК УправленческийОбороты
		|		ЛЕВОЕ СОЕДИНЕНИЕ РегистрСведений.ЦеныНоменклатуры.СрезПоследних(
		|				&ОкончаниеПериода,
		|				Номенклатура = ЗНАЧЕНИЕ(Справочник.Номенклатура.ПроездМонтажникаЗаГородом)
		|					ИЛИ Номенклатура = ЗНАЧЕНИЕ(Справочник.Номенклатура.СборкаИзделия)
		|						И Регион = &Регион) КАК ЦеныЗаКилометры
		|		ПО (ЦеныЗаКилометры.Номенклатура = ЗНАЧЕНИЕ(Справочник.Номенклатура.ПроездМонтажникаЗаГородом))
		|			И (УправленческийОбороты.Субконто1 = ЗНАЧЕНИЕ(Перечисление.ВидыПоказателейСотрудников.КилометровУдаленныхМонтажей))
		|		ЛЕВОЕ СОЕДИНЕНИЕ РегистрСведений.ЦеныНоменклатуры.СрезПоследних(
		|				&ОкончаниеПериода,
		|				Номенклатура = ЗНАЧЕНИЕ(Справочник.Номенклатура.ПроездМонтажникаЗаГородом)
		|					ИЛИ Номенклатура = ЗНАЧЕНИЕ(Справочник.Номенклатура.СборкаИзделия)
		|						И Регион = &Регион) КАК ЦеныЗаКвадратныеМетры
		|		ПО (УправленческийОбороты.Субконто1 = ЗНАЧЕНИЕ(Перечисление.ВидыПоказателейСотрудников.КоличествоМетровУстановленныхИзделий))
		|			И (ЦеныЗаКвадратныеМетры.Номенклатура = ЗНАЧЕНИЕ(Справочник.Номенклатура.СборкаИзделия))
		|
		|УПОРЯДОЧИТЬ ПО
		|	Монтажник";
		
		Выборка = Запрос.Выполнить().Выбрать();
		
		Пока Выборка.Следующий() Цикл
			
			Сумма 							= 0;
			Комментарий 					= "";
			НоваяСтрока 					= Объект.СписокФизлиц.Добавить();
			НоваяСтрока.ФизЛицо 	= Выборка.Монтажник;
			НоваяСтрока.Статья 		= Справочники.СтатьиДоходовРасходов.РасходыЗарплатаМонтаж;
			
			Если Выборка.Статья = Перечисления.ВидыПоказателейСотрудников.КилометровУдаленныхМонтажей Тогда
				
				Сумма 			= Выборка.Количество * Выборка.ЦенаЗаКилометр;
				Комментарий 	= "За удаленные монтажи - " + Выборка.Количество + "км.";
				
			ИначеЕсли Выборка.Статья = Перечисления.ВидыПоказателейСотрудников.КоличествоМетровУстановленныхИзделий Тогда
				
				Сумма = Выборка.Количество * Выборка.ЦенаЗаКвадратныйМетр;
				Комментарий 	= "За объем выполненных работ - " + Выборка.Количество + "кв.м.";
				
			КонецЕсли;
				
			НоваяСтрока.Сумма 			= Сумма;
			НоваяСтрока.Комментарий 	= Комментарий;
			
		КонецЦикла;
		
	КонецЕсли;
	
КонецПроцедуры


