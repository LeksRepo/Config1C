&НаСервере
Перем ТаблицаДеталиЯщиков;

#Область Заполнение_документа_при_записи

&НаСервере
Функция УбратьПроверкуПриМодифицированности()
	
	Если ЗначениеЗаполнено(Объект.Ссылка) Тогда
		
		ТекущийСтатус = Документы.Спецификация.ПолучитьСтатусСпецификации(Объект.Ссылка);
		
		Если Модифицированность
			И (ТекущийСтатус = Перечисления.СтатусыСпецификации.ПроверенТехнологом ИЛИ ТекущийСтатус = Перечисления.СтатусыСпецификации.ПроверенЛогистом)
			И НЕ Объект.Изделие.ЗапретРедактирования Тогда
			Документы.Спецификация.УстановитьСтатусСпецификации(Объект.Ссылка, Перечисления.СтатусыСпецификации.Сохранен);
		КонецЕсли;
		
	КонецЕсли;
	
КонецФункции

&НаСервере
Функция ЗаполнитьОсновныеЦвета(ТекущийОбъект)
	
	ЦветВертикальногоПрофиля = Неопределено;
	ЦветЛДСПОсновной = Неопределено;
	ЦветЛДСПДополнительный = Неопределено;
	
	Запрос = Новый Запрос;
	
	НоменклатурныеГруппы = Новый Массив;
	НоменклатурныеГруппы.Добавить(Справочники.НоменклатурныеГруппы.ВертикальныйПрофиль);
	НоменклатурныеГруппы.Добавить(Справочники.НоменклатурныеГруппы.ЛДСП16);
	
	Запрос.УстановитьПараметр("СписокНоменклатуры", ТекущийОбъект.СписокНоменклатуры);
	Запрос.УстановитьПараметр("НоменклатурныеГруппы", НоменклатурныеГруппы);
	
	Запрос.Текст =
	"ВЫБРАТЬ
	|	СписокНоменклатуры.Номенклатура КАК Номенклатура,
	|	СписокНоменклатуры.Количество КАК Количество
	|ПОМЕСТИТЬ ВТ
	|ИЗ
	|	&СписокНоменклатуры КАК СписокНоменклатуры
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	ВТ.Номенклатура КАК Номенклатура,
	|	СУММА(ВТ.Количество) КАК Количество,
	|	ВЫРАЗИТЬ(ВТ.Номенклатура КАК Справочник.Номенклатура).НоменклатурнаяГруппа КАК НоменклатурнаяГруппа
	|ИЗ
	|	ВТ КАК ВТ
	|ГДЕ
	|	ВЫРАЗИТЬ(ВТ.Номенклатура КАК Справочник.Номенклатура).НоменклатурнаяГруппа В (&НоменклатурныеГруппы)
	|
	|СГРУППИРОВАТЬ ПО
	|	ВТ.Номенклатура,
	|	ВЫРАЗИТЬ(ВТ.Номенклатура КАК Справочник.Номенклатура).НоменклатурнаяГруппа
	|
	|УПОРЯДОЧИТЬ ПО
	|	НоменклатурнаяГруппа,
	|	Количество УБЫВ";
	
	РезультатЗапроса = Запрос.Выполнить();
	
	Если НЕ РезультатЗапроса.Пустой() Тогда
		
		Выборка = РезультатЗапроса.Выбрать();
		
		Пока Выборка.Следующий() Цикл
			
			Если Выборка.НоменклатурнаяГруппа = Справочники.НоменклатурныеГруппы.ВертикальныйПрофиль Тогда
				
				ТекущийОбъект.ЦветВертикальногоПрофиля = Выборка.Номенклатура;
				
			ИначеЕсли Выборка.НоменклатурнаяГруппа = Справочники.НоменклатурныеГруппы.ЛДСП16 Тогда
				
				Если НЕ ЗначениеЗаполнено(ЦветЛДСПОсновной) Тогда
					
					ТекущийОбъект.ЦветЛДСПОсновной = Выборка.Номенклатура;
					
				ИначеЕсли НЕ ЗначениеЗаполнено(ЦветЛДСПДополнительный) Тогда
					
					ТекущийОбъект.ЦветЛДСПДополнительный = Выборка.Номенклатура;
					
				КонецЕсли;
				
			КонецЕсли;
			
		КонецЦикла;
		
	КонецЕсли; // НЕ РезультатЗапроса.Пустой()
	
КонецФункции

&НаСервере
Функция ЗаполнитьКоличествоКоробов(ТекущийОбъект)
	
	Если ТекущийОбъект.СписокИзделийПоКаталогу.Количество() = 0 Тогда
		ТекущийОбъект.КоличествоКоробов = 0;
		Возврат 0;
	КонецЕсли;
	
	Запрос = Новый Запрос;
	
	ВидыИзделий = Новый Массив;
	ВидыИзделий.Добавить(Справочники.ВидыИзделийПоКаталогу.КорпуснаяМебель);
	ВидыИзделий.Добавить(Справочники.ВидыИзделийПоКаталогу.КухняВерхний);
	ВидыИзделий.Добавить(Справочники.ВидыИзделийПоКаталогу.КухняНижний);
	ВидыИзделий.Добавить(Справочники.ВидыИзделийПоКаталогу.Комод);
	
	Запрос.УстановитьПараметр("СписокИзделийПоКаталогу", ТекущийОбъект.СписокИзделийПоКаталогу);
	Запрос.УстановитьПараметр("ВидыИзделий", ВидыИзделий);
	
	Запрос.Текст =
	"ВЫБРАТЬ
	|	СписокИзделийПоКаталогу.Изделие КАК Изделие,
	|	1 КАК Количество
	|ПОМЕСТИТЬ ВТ
	|ИЗ
	|	&СписокИзделийПоКаталогу КАК СписокИзделийПоКаталогу
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	ВТ.Изделие,
	|	ВТ.Количество КАК Количество
	|ИЗ
	|	ВТ КАК ВТ
	|ГДЕ
	|	ВЫРАЗИТЬ(ВТ.Изделие КАК Справочник.КаталогИзделий).ВидИзделияПоКаталогу В (&ВидыИзделий)
	|ИТОГИ
	|	СУММА(Количество)
	|ПО
	|	ОБЩИЕ";
	
	Выборка = Запрос.Выполнить().Выбрать(ОбходРезультатаЗапроса.ПоГруппировкам);
	Выборка.Следующий();
	ТекущийОбъект.КоличествоКоробов = Выборка.Количество;
	
КонецФункции

&НаСервере
Функция ПроверитьЗаменитьКратность(ТекущийОбъект, Отказ)
	
	// { Васильев Александр Леонидович [07.05.2015]
	// Похоже тут ошибка передачи таблицы на клиент. :(
	// } Васильев Александр Леонидович [07.05.2015]
	
	СтрокаСообщенияОКратности = "";
	СтруктураПроверки = Новый Структура();
	//СтруктураПроверки.Вставить("СтрокаСообщенияОКратности", СтрокаСообщенияОКратности);
	Ошибки = Неопределено;
	
	Для каждого Строка Из ТекущийОбъект.Комплектация Цикл
		
		Если Строка.Номенклатура.НоменклатурнаяГруппа.ЛистовойМатериал Тогда
			
			ОбщегоНазначенияКлиентСервер.ДобавитьОшибкуПользователю(Ошибки,
			"Объект.Комплектация["+Строка(Строка.НомерСтроки-1)+"].Номенклатура","Для заказа " + Строка.Номенклатура + " используйте вкладку ""Детали""" );
			
		КонецЕсли; 
		
		СтруктураКратности = ЛексСервер.ПосчитатьКратность(Строка.Номенклатура, Строка.Количество);
		
		Если СтруктураКратности.КоличествоМатериала <> Строка.Количество Тогда
			
			Строка.Количество = СтруктураКратности.КоличествоМатериала;
			
			//ТекстСообщения = "'%1' поставляется только размером, кратным %2. Количество материала было изменено на %3";
			//ТекстСообщения = СтроковыеФункцииКлиентСервер.ПодставитьПараметрыВСтроку(ТекстСообщения, Строка.Номенклатура, СтруктураКратности.Кратность, СтруктураКратности.КоличествоМатериала);
			//
			//Если ЗначениеЗаполнено(СтрокаСообщенияОКратности) Тогда
			//	
			//	СтрокаСообщенияОКратности = СтрокаСообщенияОКратности + Символы.ПС + ТекстСообщения;
			//	
			//Иначе
			//	
			//	СтрокаСообщенияОКратности = ТекстСообщения;
			//	
			//КонецЕсли;
			
		КонецЕсли;
		
	КонецЦикла;
	
	СтруктураПроверки.Вставить("СтрокаСообщенияОКратности", СтрокаСообщенияОКратности);
	
	ОбщегоНазначенияКлиентСервер.СообщитьОшибкиПользователю(Ошибки, Отказ);
	
	Возврат СтруктураПроверки;
	
КонецФункции

&НаСервере
Функция ЗаполненыПоставщики(ТаблицаСписокМатериаловПодЗаказ, ЭтоДилер)
	
	ПоставщикиЗаполнены = Истина;
	
	Для Каждого Элемент Из ТаблицаСписокМатериаловПодЗаказ Цикл
		
		Если НЕ ЗначениеЗаполнено(Элемент.Поставщик) Тогда
			
			ПоставщикиЗаполнены = Ложь;
			
			Если НЕ ЭтоДилер Тогда
				
				ОбщегоНазначенияКлиентСервер.СообщитьПользователю("Заполните поставщиков", ,"Объект.СписокМатериаловПодЗаказ");
				
			КонецЕсли;
			
			Прервать;
			
		КонецЕсли;
		
	КонецЦикла;
	
	Возврат ПоставщикиЗаполнены;
	
КонецФункции 

&НаКлиенте
Функция ЗаполненыПоставщикиНаКлиенте()
	
	ПоставщикиЗаполнены = Истина;
	
	Для Каждого Элемент Из Объект.СписокМатериаловПодЗаказ Цикл
		
		Если НЕ ЗначениеЗаполнено(Элемент.Поставщик) Тогда
			
			ПоставщикиЗаполнены = Ложь;
			Прервать;
			
		КонецЕсли;
		
	КонецЦикла;
	
	Возврат ПоставщикиЗаполнены;
	
КонецФункции

&НаКлиенте
Процедура ЗаписатьПустуюСпецификацию()
	
	//Предварительная запись ПУСТОЙ спецификации при добавлении дверей или открытия формы ШкафПоКаталогу
	
	Если НЕ ЗначениеЗаполнено(Объект.Ссылка) Тогда
		Записать();
	КонецЕсли;
	
КонецПроцедуры

&НаСервере
Функция ДобавитьУслугуДляМебельнойКромки(ТекущийОбъект, Строка, ИмяПоля, МалоразмернаяДеталь)
	
	МебельнаяКромка = Строка[ИмяПоля];
	Услуга = Неопределено;
	НоменклатурныеГруппы = Справочники.НоменклатурныеГруппы;
	ГруппаКромки = МебельнаяКромка.НоменклатурнаяГруппа;
	
	Если НЕ ЗначениеЗаполнено(МебельнаяКромка) Тогда
		Возврат Неопределено;
	КонецЕсли;
	
	ИмяПоля = ВРег(ИмяПоля);
	Если Найти(ИмяПоля,"ВЕРХ") <> 0 Тогда
		Радиус1 = "РадиусПравоВерх";
		Радиус2 = "РадиусЛевоВерх";
		Сторона = "ШиринаДетали";
	ИначеЕсли Найти(ИмяПоля, "НИЗ") <> 0 Тогда
		Радиус1 = "РадиусПравоНиз";
		Радиус2 = "РадиусЛевоНиз";
		Сторона = "ШиринаДетали";
	ИначеЕсли Найти(ИмяПоля, "ЛЕВ") <> 0 Тогда
		Радиус1 = "РадиусЛевоНиз";
		Радиус2 = "РадиусЛевоВерх";
		Сторона = "ВысотаДетали";
	ИначеЕсли Найти(ИмяПоля, "ПРАВ") <> 0 Тогда
		Радиус1 = "РадиусПравоНиз";
		Радиус2 = "РадиусПравоВерх";
		Сторона = "ВысотаДетали";
	КонецЕсли;
	
	Если ГруппаКромки = НоменклатурныеГруппы.КантАлюминиевый ИЛИ МалоразмернаяДеталь или ГруппаКромки = НоменклатурныеГруппы.ТорцеваяРучка16мм или ГруппаКромки = НоменклатурныеГруппы.ТорцеваяРучка18мм Тогда
		КоличествоУслуги = Строка.Количество; // по единице за сторону
	Иначе
		КоличествоУслуги = Строка[Сторона] * Строка.Количество / 1000;
	КонецЕсли;
	
	Радиус = Строка[Радиус1] + Строка[Радиус2];
	
	Если МалоразмернаяДеталь Тогда
		
		Услуга = Справочники.Номенклатура.КромлениеМалоразмернойДетали;
		
	ИначеЕсли Радиус = 0 Тогда
		
		Услуга = ПолучитьУслугуКромления(МебельнаяКромка);
		
	Иначе
		
		Услуга = Справочники.Номенклатура.КриволинейноеКромление;
		
	КонецЕсли;
	
	ДобавитьСтроку(ТекущийОбъект, Услуга, КоличествоУслуги, Строка.НомерИзделия);
	
КонецФункции

&НаСервере
Функция ЗаполнитьУслугиМебельнойКромки(ТекущийОбъект, Строка)
	
	Массив = Новый Массив;
	Массив.Добавить("ВыборМебельнойКромкиСверху");
	Массив.Добавить("ВыборМебельнойКромкиСнизу");
	Массив.Добавить("ВыборМебельнойКромкиСлева");
	Массив.Добавить("ВыборМебельнойКромкиСправа");
	МалоразмернаяДеталь = Строка.ШиринаДетали < 80 или Строка.ВысотаДетали < 80;
	
	Для каждого ъ Из Массив Цикл
		ДобавитьУслугуДляМебельнойКромки(ТекущийОбъект, Строка, ъ, МалоразмернаяДеталь);
	КонецЦикла;
	
КонецФункции

&НаСервере
Функция ЗаполнитьТаблицуСкладГотовойПродукции(ТекущийОбъект)
	
	ТекущийОбъект.СкладГотовойПродукции.Очистить();
	ТекущийОбъект.ТребуетсяКомплектация = Ложь;
	
	Для каждого Строка Из ТекущийОбъект.СписокНоменклатуры Цикл
		
		Номенклатура = Строка.Номенклатура;
		СтруктураРеквизитов = ОбщегоНазначения.ЗначенияРеквизитовОбъекта(Номенклатура, "РезМаталлическогоПогонажа, ВидНоменклатуры, ПроцентОтхода, МестоОбработки, ЕдиницаИзмерения");
		
		Если НЕ Строка.ЧерезСклад ИЛИ СтруктураРеквизитов.ВидНоменклатуры <> Перечисления.ВидыНоменклатуры.Материал Тогда
			
			Продолжить;
			
		КонецЕсли;
		
		ТекущийОбъект.ТребуетсяКомплектация = Истина;
		
		КоличествоБезОтхода = Строка.Количество * 100 / (100 + СтруктураРеквизитов.ПроцентОтхода); // стыдно за такую хуйню :(
		
		Если СтруктураРеквизитов.МестоОбработки = Перечисления.МестоОбработки.Отгрузка ИЛИ Строка.НомерИзделия = 0 Тогда
			
			КоличествоЦех = 0;
			КоличествоСклад = КоличествоБезОтхода;
			
		ИначеЕсли СтруктураРеквизитов.МестоОбработки = Перечисления.МестоОбработки.ПоКаталогуВЦех И Строка.НомерИзделия <> 0 Тогда
			
			КоличествоСклад = 0;
			КоличествоЦех = КоличествоБезОтхода;
			
		Иначе
			
			КоличествоЦех = 0;
			КоличествоСклад = 0;
			
		КонецЕсли;
		
		СтрокаТЗ = ТекущийОбъект.СкладГотовойПродукции.Найти(Номенклатура, "Номенклатура");
		НуженРез = СтруктураРеквизитов.РезМаталлическогоПогонажа;
		
		Если СтрокаТЗ = Неопределено или НуженРез Тогда
			
			НоваяСтрока = ТекущийОбъект.СкладГотовойПродукции.Добавить();
			НоваяСтрока.Номенклатура = Номенклатура;
			НоваяСтрока.ЕдиницаИзмерения = СтруктураРеквизитов.ЕдиницаИзмерения;
			НоваяСтрока.КоличествоСклад = КоличествоСклад;
			НоваяСтрока.КоличествоЦех = КоличествоЦех;
			
		Иначе
			
			Если КоличествоСклад > 0 Тогда
				
				СтрокаТЗ.КоличествоСклад = СтрокаТЗ.КоличествоСклад + КоличествоСклад;
				
			ИначеЕсли КоличествоЦех > 0 Тогда
				
				СтрокаТЗ.КоличествоЦех = СтрокаТЗ.КоличествоЦех + КоличествоЦех;
				
			КонецЕсли;
			
		КонецЕсли;
		
	КонецЦикла;
	
	// Ручка для ящиков с фасадами из ЛДСП передается в цех
	Для каждого Ящик Из ТекущийОбъект.СписокЯщики Цикл
		
		Если Ящик.ФасадНоменклатура.НоменклатурнаяГруппа = Справочники.НоменклатурныеГруппы.ЛДСП16 И ЗначениеЗаполнено(Ящик.РучкаНоменклатура) И Ящик.НомерИзделия = 0 Тогда
			
			Ручка = Ящик.РучкаНоменклатура;
			КоличествоРучек = Ящик.КоличествоРучек * Ящик.КоличествоЯщиков;
			
			Отбор = Новый Структура("Номенклатура", Ручка);
			СтрокаРучка = ТекущийОбъект.СкладГотовойПродукции.НайтиСтроки(Отбор)[0];
			СтрокаРучка.КоличествоСклад = СтрокаРучка.КоличествоСклад - КоличествоРучек;
			СтрокаРучка.КоличествоЦех = СтрокаРучка.КоличествоЦех + КоличествоРучек;
			
		КонецЕсли;
		
	КонецЦикла;
	
	// тут думать как отличать, что можно сворачивать, а что нет
	
	//ТекущийОбъект.СкладГотовойПродукции.Свернуть("Номенклатура", "КоличествоСклад, КоличествоЦех");
	ТекущийОбъект.СкладГотовойПродукции.Сортировать("Номенклатура Возр");
	
КонецФункции

&НаСервере
Функция ЗаписатьСтрокуРаскроя(ПараметрыЗаписи)
	
	НаборЗаписей = РегистрыСведений.РаскройДеталей.СоздатьНаборЗаписей();
	НаборЗаписей.Отбор.Объект.Установить(Объект.Ссылка);
	
	НаборЗаписей.Прочитать();
	
	Если НаборЗаписей.Количество() = 0 Тогда
		Запись = НаборЗаписей.Добавить();
	Иначе
		Запись = НаборЗаписей[0];
	КонецЕсли;
	
	Запись.РисунокРаскроя = ?(ПараметрыЗаписи.РисунокРаскроя = "save☻", "", ПараметрыЗаписи.РисунокРаскроя);
	Запись.РисунокКривогоПила = ?(ПараметрыЗаписи.РисунокКривогоПила = "save☻", "", ПараметрыЗаписи.РисунокКривогоПила);
	Запись.СтрокаРаскрой = ПараметрыЗаписи.ДанныеДляРаскроя;
	Запись.СтрокаЭтикеток = "";
	Запись.ТекущаяСтрокаРаскроя = ПараметрыЗаписи.ДанныеДляРаскроя;
	Запись.ТаблицаДеталей = ПараметрыЗаписи.ТаблицаДеталей;
	Запись.Объект = Объект.Ссылка;
	Запись.АлгоритмРаскроя = ПараметрыЗаписи.АлгоритмРаскроя;
	
	НаборЗаписей.Записать();
	
	Возврат Истина;
	
КонецФункции

&НаКлиенте 
Функция ЗаписатьРисункиРаскроя(ПараметрыЗаписи)
	
	Если ЗначениеЗаполнено(ПараметрыЗаписи.СтрокаКривогоПила) Тогда
		
		ПараметрыФормы = Новый Структура;
		ПараметрыФормы.Вставить("Спецификация", Объект.Ссылка);
		ПараметрыФормы.Вставить("ХранимыйФайл", "КривойПил");
		ПараметрыФормы.Вставить("СтрокаКривогоПила", ПараметрыЗаписи.СтрокаКривогоПила);
		
		Значение = ОткрытьФормуМодально("Документ.Спецификация.Форма.ФормаФлэш", ПараметрыФормы);
		
		ПараметрыЗаписи.Вставить("РисунокКривогоПила", Значение);
		
	КонецЕсли;
	
	Если ЗначениеЗаполнено(ПараметрыЗаписи.ДанныеДляРаскроя) Тогда
		
		ПараметрыФормы = Новый Структура;
		ПараметрыФормы.Вставить("Спецификация", Объект.Ссылка);
		ПараметрыФормы.Вставить("ХранимыйФайл", "НовыйРаскрой");
		ПараметрыФормы.Вставить("СтрокаНовогоРаскрояЛДСП", ПараметрыЗаписи.ДанныеДляРаскроя);
		ПараметрыФормы.Вставить("ВидОтображения", "1");
		
		Значение = ОткрытьФормуМодально("Документ.Спецификация.Форма.ФормаФлэш", ПараметрыФормы);
		
		ПараметрыЗаписи.Вставить("РисунокРаскроя", Значение);
		
	КонецЕсли;
	
	Возврат ПараметрыЗаписи;
	
КонецФункции

&НаСервере
Функция ПосчитатьПрисадкиКриволинейнаяДеталь(СтрокаФлэш)
	
	ВсегоОтверстий = 0;
	ВсегоЕвропазов = 0;
	МассивПодстрок = СтроковыеФункцииКлиентСервер.РазложитьСтрокуВМассивПодстрок(СтрокаФлэш, "#");
	СтруктураОтверстий = Новый Структура;
	
	Если МассивПодстрок.Количество() > 0 Тогда
		
		НужнаяСтрока = МассивПодстрок[2];
		ВторойМассив = СтроковыеФункцииКлиентСервер.РазложитьСтрокуВМассивПодстрок(НужнаяСтрока, "*");
		
		Если ВторойМассив.Количество() > 0 Тогда
			
			Для каждого Массив Из ВторойМассив Цикл
				
				Подмассив = СтроковыеФункцииКлиентСервер.РазложитьСтрокуВМассивПодстрок(Массив, "_");
				
				Если Подмассив.Количество() > 0 Тогда
					
					Определитель = Подмассив[0];
					КоличествоОтверстийВРяду = 0;
					КоличествоРядовОтверстий = 0;
					КоличествоЕвропазов = 0;
					
					Если Определитель = "10" или Определитель = "11" или Определитель = "14" Тогда
						
						КоличествоОтверстийВРяду =Число(Подмассив[4]);
						КоличествоРядовОтверстий = Число(Подмассив[5]);
						
					ИначеЕсли Определитель = "12" Тогда
						
						КоличествоОтверстийВРяду = Число(Подмассив[3]);
						КоличествоРядовОтверстий = Число(Подмассив[5]);
						
					ИначеЕсли Определитель = "13" Тогда
						
						КоличествоЕвропазов = 1;
						
					ИначеЕсли (Определитель = "18" ИЛИ Определитель = "19" ИЛИ Определитель = "20" ИЛИ Определитель = "22") Тогда
						
						КоличествоОтверстийВРяду = 1;
						
					ИначеЕсли Определитель = "21" Тогда
						
						КоличествоОтверстийВРяду = 2;
						
					КонецЕсли;
					//КоличествоРядовОтверстий нельзя выносить, хоть и одинаковая строка. "Определитель" может быть не только эти цифры
					Попытка
						
						Если КоличествоОтверстийВРяду > 0 и КоличествоРядовОтверстий > 0 Тогда
							
							ВсегоОтверстий = ВсегоОтверстий + КоличествоОтверстийВРяду * КоличествоРядовОтверстий;
							
						ИначеЕсли КоличествоОтверстийВРяду > 0 Тогда
							
							ВсегоОтверстий = ВсегоОтверстий + КоличествоОтверстийВРяду;
							
						КонецЕсли;
						
						Если КоличествоЕвропазов > 0 Тогда
							
							ВсегоЕвропазов = ВсегоЕвропазов + КоличествоЕвропазов;
							
						КонецЕсли;
						
					Исключение
						
						ОбщегоНазначенияКлиентСервер.СообщитьПользователю("В криволинейной детали выбрали ПРИСАДКУ ПОД ЕВРОВИНТ ТОРЦЕВУЮ");
						
					КонецПопытки;
					
				КонецЕсли;
				
			КонецЦикла;
			
		КонецЕсли;
		
	КонецЕсли;
	
	СтруктураОтверстий.Вставить("КоличествоПрисадок", ВсегоОтверстий);
	СтруктураОтверстий.Вставить("КоличествоЕвропазов", ВсегоЕвропазов);
	
	Возврат СтруктураОтверстий;
	
КонецФункции // ПосчитатьПрисадкиКриволинейнаяДеталь()

&НаКлиентеНаСервереБезКонтекста
Функция Клееная(Материал)
	
	Возврат Найти(Материал, "+") <> 0;
	
КонецФункции

&НаКлиенте
Функция СохранитьИИзменитьСтатус(НовыйСтатус)
	
	ПараметрыЗаписи = Новый Структура;
	
	ПараметрыЗаписи.Вставить("НовыйСтатус", НовыйСтатус);
	Записать(ПараметрыЗаписи);
	
	СтатусСпецификации = НовыйСтатус;
	ОбновитьОтображениеДанных();
	
КонецФункции

&НаСервере
Функция ЗаполнитьУслуги(ТекущийОбъект, СтруктураРаскроя)
	
	Номенклатура = Справочники.Номенклатура;
	СправочникиНоменклатурнаяГруппа = Справочники.НоменклатурныеГруппы;
	ПлощадьУпаковываемыхМатериалов = 0;
	ПлощадьИзготавливаемыхМатериалов = 0;
	ПлощадьГравировок = 0;
	
	#ОБЛАСТЬ ОСНОВНОЙ_ЦИКЛ
	//ОСНОВНОЙ ЦИКЛ ЗАПОЛНЕНИЯ ТАБЛИЦЫ УСЛУГАМИ
	Для каждого Строка Из ТекущийОбъект.СписокМатериалы Цикл
		
		КантыИзРедактора = Строка.КантыИзРедактора;
		СтрокаНоменклатура = Строка.Номенклатура;
		
		Если ЗначениеЗаполнено(КантыИзРедактора) Тогда
			
			КантыИзРедактора = ЗначениеИзСтрокиВнутр(КантыИзРедактора);
			МассивКантов = СтроковыеФункцииКлиентСервер.РазложитьСтрокуВМассивПодстрок(КантыИзРедактора, "|");
			
			Для Каждого Строчка Из МассивКантов Цикл
				
				ПараметрыКанта = СтроковыеФункцииКлиентСервер.РазложитьСтрокуВМассивПодстрок(Строчка , "_");
				НоменклатурныйНомер = ПараметрыКанта[0];
				ДлинаКанта = Число(ПараметрыКанта[1]);
				ТипКромления = Число(ПараметрыКанта[2]);
				
				НоменклатураКанта = Номенклатура.НайтиПоКоду(НоменклатурныйНомер);
				
				Если ТипКромления = 0 Тогда
					
					Услуга = ПолучитьУслугуКромления(НоменклатураКанта);
					
				Иначе
					Услуга = Номенклатура.КриволинейноеКромление;
				КонецЕсли;
				
				ДобавитьСтроку(ТекущийОбъект, Услуга, (ДлинаКанта / 1000) * Строка.Количество, Строка.НомерИзделия);
				
			КонецЦикла;
			
		КонецЕсли;
		
		Материал = Строка.Материал;
		НоменклатурнаяГруппа = СтрокаНоменклатура.НоменклатурнаяГруппа;
		
		Фасад = Найти(Материал, "Фасад") <> 0;
		ЛДСП = Найти(Материал, "ЛДСП") <> 0 И НЕ Фасад;
		Столешница = Материал = "Столешница" ИЛИ Материал = "Пристенок";
		Пуфик = Материал = "Пуфик";
		Клееная = Клееная(Материал);
		
		//Детали ЛДСП и ДВП и МДФ и Столешниц с кромочным материалом
		Если ЛДСП ИЛИ Материал = "ДВП" ИЛИ Материал = "МДФ" ИЛИ Столешница ИЛИ Пуфик Или Материал = "АГТПанель" Или Материал = "АГТ+АГТ" Тогда
			
			КоличествоУслуги = ?(Клееная, Строка.Количество * 2, Строка.Количество);
			
			Если Материал = "16 ЛДСП" ИЛИ Клееная ИЛИ Столешница или Материал = "АГТПанель" Тогда
				ПлощадьИзготавливаемыхМатериалов = ПлощадьИзготавливаемыхМатериалов + Строка.ВысотаДетали * Строка.ШиринаДетали * Строка.Количество / 1000000;
			КонецЕсли;
			
			Если Материал = "ДВП" Тогда
				Услуга = Номенклатура.ИзготовлениеДеревяннойДеталиСтекольнаяЗона;
			Иначе
				Услуга = Номенклатура.РаспилЗаДеталь;
			КонецЕсли;
			
			ДобавитьСтроку(ТекущийОбъект, Услуга, КоличествоУслуги, Строка.НомерИзделия);
			
			Если Клееная Тогда
				ДобавитьСтроку(ТекущийОбъект, Номенклатура.СклеиваниеЛДСПЗонаКромки, Строка.Количество, Строка.НомерИзделия);
				ДобавитьСтроку(ТекущийОбъект, Номенклатура.ТорцовкаСклеенойДеталиЗонаФРС, Строка.Количество, Строка.НомерИзделия);
			КонецЕсли;
			
			Если Пуфик Тогда
				ДобавитьСтроку(ТекущийОбъект, Номенклатура.ИзготовлениеПуфика, Строка.Количество, Строка.НомерИзделия);
			КонецЕсли;
			
			//Радиусы
			РадиусЛевоВерх = Строка.РадиусЛевоВерх;
			РадиусЛевоНиз = Строка.РадиусЛевоНиз;
			РадиусПравоВерх = Строка.РадиусПравоВерх;
			РадиусПравоНиз = Строка.РадиусПравоНиз;
			
			//Кривой пил
			ДлинаКривогоПила = Число(Строка.ДлинаКривогоПила);
			
			Если ДлинаКривогоПила > 0 Тогда
				ДобавитьСтроку(ТекущийОбъект, Номенклатура.КриволинейныйПилЗонаКромки, ДлинаКривогоПила / 1000 * Строка.Количество, Строка.НомерИзделия);
			КонецЕсли;
			
			ВысотаДетали = Строка.ВысотаДетали;
			ШиринаДетали = Строка.ШиринаДетали;
			
			ЗаполнитьУслугиМебельнойКромки(ТекущийОбъект, Строка);
			
			/////////////////////////////////////////////
			// СТЕКЛА
		ИначеЕсли Материал = "Стекло" Тогда
			
			ДобавитьСтроку(ТекущийОбъект, Номенклатура.ИзготовлениеДеталиСтекло, Строка.Количество, Строка.НомерИзделия);
			
			Если Строка.Обтачивать Тогда
				
				ДобавитьСтроку(ТекущийОбъект, Номенклатура.Обточка, Строка.Периметр / 1000 * Строка.Количество, Строка.НомерИзделия);
				
			КонецЕсли;
			
			//Кривой рез
			ДлинаКривогоПила = 0;
			
			ДлинаКривогоПила = Число(Строка.ДлинаКривогоПила);
			
			Если ДлинаКривогоПила > 0 Тогда
				
				ДобавитьСтроку(ТекущийОбъект, Номенклатура.КриволинейныйРез, ДлинаКривогоПила / 1000 * Строка.Количество, Строка.НомерИзделия);
				
			КонецЕсли;
			
			// ГРАВИРОВКИ
			СтрокаФлэш = Строка.СтрокаДляФлэш;
			Если ЗначениеЗаполнено(СтрокаФлэш) Тогда
				
				МассивСтроки = СтроковыеФункцииКлиентСервер.РазложитьСтрокуВМассивПодстрок(СтрокаФлэш, "#");
				
				Если МассивСтроки.Количество() > 3 Тогда
					
					ПлощадьГравировки = Число(МассивСтроки[3]) / 1000000 * Строка.Количество;
					
					Если ПлощадьГравировки > 0 Тогда
						
						ДобавитьСтроку(ТекущийОбъект, Номенклатура.Гравировка, ПлощадьГравировки, Строка.НомерИзделия);
						
					КонецЕсли;
					
				КонецЕсли;
				
			КонецЕсли;
			
			/////////////////////////////////////////////
			// ФАСАДЫ
		ИначеЕсли Фасад Тогда
			
			ШиринаВставки = СтрокаНоменклатура.ГлубинаДетали;
			ШиринаПаза = Строка.УниверсальнаяКромка.ШиринаПаза;
			
			Если Материал = "ФасадАГТ" Тогда
				
				Если ШиринаПаза < ШиринаВставки Тогда
					
					ДобавитьСтроку(ТекущийОбъект, Номенклатура.ФрезеровкаДеталиЗонаКухонь, Строка.Количество, Строка.НомерИзделия);
					
				КонецЕсли;
				
				ДобавитьСтроку(ТекущийОбъект, Номенклатура.СборкаАГТФасада, Строка.Количество, Строка.НомерИзделия);
				
			ИначеЕсли Материал = "ФасадМДФ" ИЛИ Материал = "ФасадЛДСП" Тогда
				
				ЗаполнитьУслугиМебельнойКромки(ТекущийОбъект, Строка);
				
			ИначеЕсли Материал = "ФасадАлюминиевый" Тогда
				
				ДобавитьСтроку(ТекущийОбъект, Номенклатура.СборкаАлюминевогоФасада, Строка.Количество, Строка.НомерИзделия);
				
			КонецЕсли;
			
			Если Строка.Обтачивать Тогда
				ДобавитьСтроку(ТекущийОбъект, Номенклатура.Обточка, Строка.Периметр / 1000 * Строка.Количество, Строка.НомерИзделия);
			КонецЕсли;
			
			// { Васильев Александр Леонидович [03.03.2014]
			// что то мне тут не нравится...
			// может как-нить по цеховой зоне,
			// но как тогда деревянная деталь в стекольной зоне...
			// } Васильев Александр Леонидович [03.03.2014]
			Если НоменклатурнаяГруппа = СправочникиНоменклатурнаяГруппа.Стекло ИЛИ НоменклатурнаяГруппа = СправочникиНоменклатурнаяГруппа.Зеркало
				ИЛИ НоменклатурнаяГруппа = СправочникиНоменклатурнаяГруппа.СтеклоДляСкругляемогоФасада Тогда
				Услуга = Номенклатура.ИзготовлениеДеталиСтекло;
			ИначеЕсли НоменклатурнаяГруппа.ПринадлежитЭлементу(СправочникиНоменклатурнаяГруппа.МДФ)
				ИЛИ НоменклатурнаяГруппа.ПринадлежитЭлементу(СправочникиНоменклатурнаяГруппа.ЛДСП) Тогда
				Услуга = Номенклатура.РаспилЗаДеталь;
			Иначе
				Услуга = Номенклатура.ИзготовлениеДеревяннойДеталиСтекольнаяЗона;
			КонецЕсли;
			ДобавитьСтроку(ТекущийОбъект, Услуга, Строка.Количество, Строка.НомерИзделия);
			
			Если Строка.ОтверстийподРучку > 0 Тогда
				
				Если Материал = "ФасадСтеклянный" ИЛИ Материал = "ФасадСтеклянныйЗакругленный" Тогда
					Услуга = Номенклатура.СверлениеВСтеклеДо5мм;
				Иначе
					Услуга = Номенклатура.УслугаПрисадка;
				КонецЕсли;
				
				ДобавитьСтроку(ТекущийОбъект, Услуга, Строка.ОтверстийподРучку * Строка.Количество, Строка.НомерИзделия);
				
			КонецЕсли;
			
			Если Строка.КоличествоПетель * Строка.Количество > 0 Тогда
				
				Если Материал = "ФасадСтеклянный" Тогда
					
					ДобавитьСтроку(ТекущийОбъект, Номенклатура.СверлениеВСтеклеДо5мм, Строка.КоличествоПетель * Строка.Количество, Строка.НомерИзделия);
					
				Иначе
					
					ДобавитьСтроку(ТекущийОбъект, Номенклатура.ПрисадкаПодПетли, Строка.КоличествоПетель * Строка.Количество, Строка.НомерИзделия);
					
				КонецЕсли;
				
			КонецЕсли;
			
			Если Материал = "ФасадСтеклянныйЗакругленный" Тогда
				
				ДобавитьСтроку(ТекущийОбъект, Номенклатура.ЗагибСтеклянногоФасада, Строка.Количество, Строка.НомерИзделия);
				
			КонецЕсли;
			
		КонецЕсли; // ФАСАДЫ
		
		//Услуги из криволинейной детали (ТОЛЬКО ПРИСАДКИ)
		Если ЗначениеЗаполнено(Строка.СтрокаДляФлэш) Тогда
			СтруктураПрисадок = ПосчитатьПрисадкиКриволинейнаяДеталь(Строка.СтрокаДляФлэш);
			КоличествоПрисадок = СтруктураПрисадок.КоличествоПрисадок;
			КоличествоЕвропазов = СтруктураПрисадок.КоличествоЕвропазов;
			
			Если КоличествоПрисадок > 0 Тогда
				
				Если Материал = "ФасадСтеклянныйЗакругленный" или Материал = "ФасадСтеклянный" или Материал = "Стекло" Тогда
					
					ДобавитьСтроку(ТекущийОбъект, Номенклатура.СверлениеВСтеклеДо5мм, КоличествоПрисадок * Строка.Количество, Строка.НомерИзделия);
					
				Иначе
					
					ДобавитьСтроку(ТекущийОбъект, Номенклатура.ПрисадкаИндивидуальная, КоличествоПрисадок * Строка.Количество, Строка.НомерИзделия);
					
				КонецЕсли;
				
			КонецЕсли;
			
			Если КоличествоЕвропазов > 0 Тогда
				
				ДобавитьСтроку(ТекущийОбъект, Номенклатура.УслугаЕвропаз, КоличествоЕвропазов * Строка.Количество, Строка.НомерИзделия);
				
			КонецЕсли;
			
		КонецЕсли;
		
		СтруктураОтверстий = Строка.СтруктураОтверстий;
		
		Если ЗначениеЗаполнено(СтруктураОтверстий) Тогда
			
			ТаблицаОтверстий = ЗначениеИзСтрокиВнутр(СтруктураОтверстий);
			
			Для Каждого Элемент Из ТаблицаОтверстий Цикл
				
				Если Элемент.ВидОтверстий = Перечисления.ВидыОтверстий.Европаз Тогда
					Услуга = Номенклатура.УслугаЕвропаз;
				Иначе
					Услуга = Номенклатура.УслугаПрисадка;
				КонецЕсли;
				
				Если Элемент.ВидОтверстий=Перечисления.ВидыОтверстий.ОбратнаяПрисадка Тогда
					Услуга = Номенклатура.ОбратнаяПрисадка; 
				КонецЕсли;
				
				Если Элемент.ВидОтверстий=Перечисления.ВидыОтверстий.ПрисадкаПодСтяжки Тогда
					Услуга = Номенклатура.ПрисадкаПодСтяжки;
				КонецЕсли;
				
				ДобавитьСтроку(ТекущийОбъект, Услуга, Элемент.Количество * Строка.Количество, Строка.НомерИзделия);
				
			КонецЦикла;
			
		КонецЕсли;
		
		Если Строка.НомерИзделия = 0 Тогда
			ПлощадьУпаковываемыхМатериалов = ПлощадьУпаковываемыхМатериалов + Строка.ВысотаДетали * Строка.ШиринаДетали * (Клееная + 1) * Строка.Количество / 1000000;
		КонецЕсли;
		
	КонецЦикла; // Для каждого Строка Из Объект.СписокМатериалы Цикл
	
	#КОНЕЦОБЛАСТИ
	
	#ОБЛАСТЬ ЯЩИКИ
	Для каждого Строка Из Объект.СписокЯщики Цикл
		
		Если НовыеЯщики Тогда
			
					ДобавитьСтроку(ТекущийОбъект, Номенклатура.ИзготовлениеЯщика, Строка.КоличествоЯщиков, Строка.НомерИзделия);
					ДобавитьСтроку(ТекущийОбъект, Номенклатура.НакручиваниеРучкиНаЛДСПФасадЯщика, Строка.КоличествоЯщиков * Строка.КоличествоРучек, Строка.НомерИзделия);
					
					НомерСтрокиЯщика = Строка.НомерСтроки;
								
					Для Каждого ДетальЯщика Из ТаблицаДеталиЯщиков Цикл
						
						Если ДетальЯщика.НомерСтроки = НомерСтрокиЯщика Тогда

								//Фасад распил
								Если (ДетальЯщика.Тип = Перечисления.ВидыДеталейЯщиков.Фасад) Тогда
									
									Если ДетальЯщика.КромкаНоменклатура.НоменклатурнаяГруппа = Справочники.НоменклатурныеГруппы.АГТПрофиль Тогда
			
										ДобавитьСтроку(ТекущийОбъект, Номенклатура.СборкаАГТФасада, ДетальЯщика.Количество, ДетальЯщика.НомерИзделия);
										ДобавитьСтроку(ТекущийОбъект, Номенклатура.ИзготовлениеДеревяннойДеталиСтекольнаяЗона, ДетальЯщика.Количество, ДетальЯщика.НомерИзделия);
										
										ШиринаВставки = ДетальЯщика.Номенклатура.ГлубинаДетали;
										ШиринаПаза = ДетальЯщика.КромкаНоменклатура.ШиринаПаза;
										
										Если ШиринаПаза < ШиринаВставки Тогда
											
											ДобавитьСтроку(ТекущийОбъект, Номенклатура.ФрезеровкаДеталиЗонаКухонь, ДетальЯщика.Количество, ДетальЯщика.НомерИзделия);
											
										КонецЕсли;
										
									Иначе
										
										ДобавитьСтроку(ТекущийОбъект, Номенклатура.РаспилЗаДеталь, ДетальЯщика.Количество, ДетальЯщика.НомерИзделия);

									КонецЕсли;

									
					            КонецЕсли;
								
								//Дно распил
								Если (ДетальЯщика.Тип = Перечисления.ВидыДеталейЯщиков.Дно) Тогда
									    ДобавитьСтроку(ТекущийОбъект, Номенклатура.ИзготовлениеДеревяннойДеталиСтекольнаяЗона, ДетальЯщика.Количество, ДетальЯщика.НомерИзделия); 		
								КонецЕсли;
								
								//Корпус распил
								Если (ДетальЯщика.НомерСтроки = НомерСтрокиЯщика) И (ДетальЯщика.Тип = Перечисления.ВидыДеталейЯщиков.Корпус) Тогда
									    ДобавитьСтроку(ТекущийОбъект, Номенклатура.РаспилЗаДеталь, ДетальЯщика.Количество, ДетальЯщика.НомерИзделия); 		
								КонецЕсли;
								
								
								//Кромление
								
								Если ДетальЯщика.КромкаНоменклатура.ГлубинаДетали >= 1 Тогда
									УслугаКромки = Номенклатура.КромлениеТолстойКромки;
								Иначе
									УслугаКромки = Номенклатура.КромлениеТонкойКромки;
								КонецЕсли;
								
								ДлинаКромки = ?(ЗначениеЗаполнено(ДетальЯщика.ВыборМебельнойКромкиСверху),ДетальЯщика.ШиринаДетали,0) +
								  			  ?(ЗначениеЗаполнено(ДетальЯщика.ВыборМебельнойКромкиСнизу),ДетальЯщика.ШиринаДетали,0) +
											  ?(ЗначениеЗаполнено(ДетальЯщика.ВыборМебельнойКромкиСлева),ДетальЯщика.ВысотаДетали,0) +
											  ?(ЗначениеЗаполнено(ДетальЯщика.ВыборМебельнойКромкиСправа),ДетальЯщика.ВысотаДетали,0);
							
								ДобавитьСтроку(ТекущийОбъект, УслугаКромки, ДетальЯщика.Количество * ДлинаКромки / 1000, ДетальЯщика.НомерИзделия);
								
								ПлощадьИзготавливаемыхМатериалов = ПлощадьИзготавливаемыхМатериалов + ДетальЯщика.Количество * (ДетальЯщика.ШиринаДетали * ДетальЯщика.ВысотаДетали) / 1000000;
						
											  
						КонецЕсли;
	
					КонецЦикла;
			
		Иначе
			
			
					ДобавитьСтроку(ТекущийОбъект, Номенклатура.ИзготовлениеЯщика, Строка.КоличествоЯщиков, Строка.НомерИзделия);
					НоменклатурнаяГруппаФасада = Строка.ФасадНоменклатура.НоменклатурнаяГруппа;
					НоменклатурнаяГруппаОбрамлениеФасада = Строка.КромкаФасадНоменклатура.НоменклатурнаяГруппа;
					СправочникНоменклатурнаяГруппа = Справочники.НоменклатурныеГруппы;
					
					ДобавитьСтроку(ТекущийОбъект, Номенклатура.НакручиваниеРучкиНаЛДСПФасадЯщика, Строка.КоличествоЯщиков * Строка.КоличествоРучек, Строка.НомерИзделия);
					
					Если Строка.КромкаНоменклатура.ГлубинаДетали >= 1 Тогда
						УслугаКромки = Номенклатура.КромлениеТолстойКромки;
					Иначе
						УслугаКромки = Номенклатура.КромлениеТонкойКромки;
					КонецЕсли;
					
					Если Строка.КромкаФасадНоменклатура.ГлубинаДетали >= 1 Тогда
						УслугаКромкиФасада = Номенклатура.КромлениеТолстойКромки;
					Иначе
						УслугаКромкиФасада = Номенклатура.КромлениеТонкойКромки;
					КонецЕсли;
					
					Если НоменклатурнаяГруппаОбрамлениеФасада = СправочникНоменклатурнаяГруппа.АГТПрофиль Тогда
						
						ДобавитьСтроку(ТекущийОбъект, Номенклатура.СборкаАГТФасада, Строка.КоличествоЯщиков, Строка.НомерИзделия);
						ДобавитьСтроку(ТекущийОбъект, Номенклатура.ИзготовлениеДеревяннойДеталиСтекольнаяЗона, Строка.КоличествоЯщиков, Строка.НомерИзделия);
						
						ШиринаВставки = Строка.ФасадНоменклатура.ГлубинаДетали;
						ШиринаПаза = Строка.КромкаФасадНоменклатура.ШиринаПаза;
						
						Если ШиринаПаза < ШиринаВставки Тогда
							
							ДобавитьСтроку(ТекущийОбъект, Номенклатура.ФрезеровкаДеталиЗонаКухонь, Строка.КоличествоЯщиков, Строка.НомерИзделия);
							
						КонецЕсли;
						
					Иначе
						
						ДобавитьСтроку(ТекущийОбъект, Номенклатура.РаспилЗаДеталь, Строка.КоличествоЯщиков, Строка.НомерИзделия);
						ДобавитьСтроку(ТекущийОбъект, УслугаКромкиФасада, Строка.КоличествоЯщиков * 2 * (Строка.ШиринаФасад + Строка.ВысотаФасад) / 1000, Строка.НомерИзделия);
						
					КонецЕсли;
					
					Если ЗначениеЗаполнено(Строка.ДноНоменклатура) Тогда
						
						ДобавитьСтроку(ТекущийОбъект, Номенклатура.ИзготовлениеДеревяннойДеталиСтекольнаяЗона, Строка.КоличествоЯщиков, Строка.НомерИзделия);
						
						Если Строка.ДноНоменклатура.НоменклатурнаяГруппа = Справочники.НоменклатурныеГруппы.ЛДСП10 Тогда
							
							Площадь = (Строка.ДлинаДно + Строка.ШиринаДно)* 2  * Строка.КоличествоЯщиков / 1000;
							ДобавитьСтроку(ТекущийОбъект, Номенклатура.КромлениеТонкойКромки, Площадь, Строка.НомерИзделия);
							
						КонецЕсли;
						
					КонецЕсли;
					
					Если Строка.ДлинаРебро > 0 Тогда
						
						ДобавитьСтроку(ТекущийОбъект, Номенклатура.РаспилЗаДеталь, Строка.КоличествоЯщиков, Строка.НомерИзделия);
						
					КонецЕсли;
					
					Если Строка.ВидЯщика = Перечисления.ВидыЯщика.Обычный Тогда
						
						ДобавитьСтроку(ТекущийОбъект, Номенклатура.РаспилЗаДеталь, Строка.КоличествоЯщиков * 4, Строка.НомерИзделия); // было 5 деталей, Дима сказал только 4
						ДобавитьСтроку(ТекущийОбъект, УслугаКромки, Строка.КоличествоЯщиков *  (2 * (Строка.ШиринаБоковойСтороны + Строка.ДлинаБоковойСтороны)) / 1000, Строка.НомерИзделия);
						ПлощадьИзготавливаемыхМатериалов = ПлощадьИзготавливаемыхМатериалов + (Строка.ШиринаБоковойСтороны * Строка.ВысотаБоковойСтороны * 2 + Строка.ДлинаБоковойСтороны * Строка.ВысотаБоковойСтороны * 2) * Строка.КоличествоЯщиков / 1000000;
						
					Иначе
						
						ДобавитьСтроку(ТекущийОбъект, Номенклатура.РаспилЗаДеталь, Строка.КоличествоЯщиков * 2, Строка.НомерИзделия);
						ДобавитьСтроку(ТекущийОбъект, УслугаКромки, Строка.КоличествоЯщиков * (2 *( Строка.ШиринаБоковойСтороны + Строка.ВысотаБоковойСтороны)) / 1000, Строка.НомерИзделия);
						ПлощадьИзготавливаемыхМатериалов = ПлощадьИзготавливаемыхМатериалов + Строка.ШиринаБоковойСтороны * Строка.ВысотаБоковойСтороны * Строка.КоличествоЯщиков / 1000000;
						
					КонецЕсли;
			
			
			
		КонецЕсли;
		
	КонецЦикла;
	
	#КОНЕЦОБЛАСТИ
	
	Если ТекущийОбъект.ПакетУслуг = Перечисления.ПакетыУслуг.ДоставкаДоКлиентаИМонтаж Тогда
		
		ДобавитьСтроку(ТекущийОбъект, Номенклатура.СборкаИзделия, ПлощадьИзготавливаемыхМатериалов, 0);
		
		Если НЕ ТекущийОбъект.Изделие.ВидИзделия = Перечисления.ВидыИзделий.Кухня Тогда
			
			УслугаВыездМастера = Номенклатура.ВыездМастера;
			
			БольшоеИзделие = Ложь;
			
			КоличествоМетров = ЛексСервер.ПолучитьНастройкуПодразделения(ТекущийОбъект.Подразделение, Перечисления.ВидыНастроекПодразделений.БольшойШкаф, ТекущийОбъект.Дата);
			
			Если ЗначениеЗаполнено(КоличествоМетров) Тогда
				
				БольшоеИзделие = ПлощадьИзготавливаемыхМатериалов > КоличествоМетров;
				
			КонецЕсли;
			
			Если БольшоеИзделие Тогда 
				ДобавитьСтроку(ТекущийОбъект, УслугаВыездМастера, 1, 0);
			КонецЕсли;
			
		Иначе
			
			УслугаВыездМастера = Номенклатура.ВыездМастераНаСборкуКухни;
			
		КонецЕсли;
		
		ДобавитьСтроку(ТекущийОбъект, УслугаВыездМастера, 1, 0);
		
		Если ТекущийОбъект.Километраж > 0 Тогда
			ДобавитьСтроку(ТекущийОбъект, Номенклатура.ПроездМонтажникаЗаГородом, Объект.Километраж, 0);
		КонецЕсли;
		
	КонецЕсли;
	
	//////////////////////////
	//???????????????????????????
	
	Если ТекущийОбъект.Упаковка Тогда
		
		ДобавитьСтроку(ТекущийОбъект, Номенклатура.УпаковкаДеталей, ПлощадьУпаковываемыхМатериалов, 0);
		
		// Упаковка дверей
		КоличествоДверей = 0;
		Для каждого Дверь ИЗ ТекущийОбъект.СписокДверей Цикл
			КоличествоДверей = КоличествоДверей + ЛексСервер.ЗначениеРеквизитаОбъекта(Дверь.Двери, "Количество");
		КонецЦикла;
		
		Если КоличествоДверей > 0 Тогда
			
			КоличествоУпаковок = Окр(КоличествоДверей / 2 + 0.5, 0, РежимОкругления.Окр15как10);
			ДобавитьСтроку(ТекущийОбъект, Номенклатура.УпаковкаДверей, КоличествоУпаковок, 0);
			
		КонецЕсли;
		
		// Упаковка кухонных коробов.
		КоличествоКоробовДляУпаковки = 0;
		Для каждого Строка Из ТекущийОбъект.СписокИзделийПоКаталогу Цикл
			КоличествоКоробовДляУпаковки = КоличествоКоробовДляУпаковки + Строка.Изделие.ВидИзделияПоКаталогу.УпаковкаВСборе;
		КонецЦикла;
		
		Если КоличествоКоробовДляУпаковки > 0 Тогда
			ДобавитьСтроку(ТекущийОбъект, Номенклатура.УпаковкаКороба, КоличествоКоробовДляУпаковки, 0);
		КонецЕсли;
		
	КонецЕсли;
	
	Если ТекущийОбъект.ПакетУслуг <> Перечисления.ПакетыУслуг.СамовывозОтПроизводителя Тогда
		
		Если ТекущийОбъект.ПакетУслуг = Перечисления.ПакетыУслуг.ДоставкаДоТранспортнойКомпании Тогда
			Этаж = 1;
		Иначе
			
			АдресСтруктурой = ЛексСервер.ПолучитьСтруктуруИзАдреса(ТекущийОбъект.АдресМонтажа);
			
			Если ЗначениеЗаполнено(АдресСтруктурой.Этаж) Тогда
				Этаж = Число(АдресСтруктурой.Этаж);
			Иначе 
				Этаж = 1;
			КонецЕсли;
			
		КонецЕсли;
		
		ДобавитьСтроку(ТекущийОбъект, Номенклатура.ПодъемИзделияНаЭтаж, Этаж, 0);
		ДобавитьСтроку(ТекущийОбъект, Номенклатура.ДоставкаПоГороду, 1, 0);
		
		РастояниеДоЗавода = ТекущийОбъект.Офис.РастояниеДоЗавода;
		
		Если ТекущийОбъект.ПакетУслуг <> Перечисления.ПакетыУслуг.ДоставкаДоТранспортнойКомпании 
			И (ТекущийОбъект.Километраж > 0 ИЛИ РастояниеДоЗавода > 0) Тогда
			ДобавитьСтроку(ТекущийОбъект, Номенклатура.ДоставкаЗаГородом, ТекущийОбъект.Километраж + РастояниеДоЗавода, 0);
		КонецЕсли;
		
	КонецЕсли;
	
	//RonEXI edit: Сборка коробов
	
	Для каждого Строка Из ТекущийОбъект.СписокИзделийПоКаталогу Цикл
		Если Строка.Сборка И (НЕ (Строка.Изделие.УслугаСборки = Справочники.Номенклатура.ПустаяСсылка())) Тогда
			ДобавитьСтроку(ТекущийОбъект, Строка.Изделие.УслугаСборки, 1, Строка.НомерСтроки);
		КонецЕсли;
	КонецЦикла;
	
	//////////////////////////////
	// материал под заказ
	МассивНашейНоменклатурыПодЗаказ = Новый Массив;
	
	Для Каждого Строка Из ТекущийОбъект.СписокНоменклатуры Цикл
		
		Если НЕ Строка.ПредоставитЗаказчик Тогда
			
			МассивНашейНоменклатурыПодЗаказ.Добавить(Строка.Номенклатура);
			
		КонецЕсли;
		
	КонецЦикла;
	
	Запрос = Новый Запрос;
	Запрос.УстановитьПараметр("Подразделение", ТекущийОбъект.Подразделение);
	Запрос.УстановитьПараметр("МассивНоменклатуры", МассивНашейНоменклатурыПодЗаказ);
	Запрос.Текст =
	"ВЫБРАТЬ
	|	Номенклатура.Ссылка КАК Ссылка
	|ПОМЕСТИТЬ втНоменклатура
	|ИЗ
	|	Справочник.Номенклатура КАК Номенклатура
	|ГДЕ
	|	Номенклатура.Ссылка В(&МассивНоменклатуры)
	|
	|ИНДЕКСИРОВАТЬ ПО
	|	Ссылка
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	НоменклатураПодразделений.Номенклатура КАК Номенклатура,
	|	НоменклатураПодразделений.Подразделение,
	|	НоменклатураПодразделений.ПодЗаказ
	|ИЗ
	|	РегистрСведений.НоменклатураПодразделений КАК НоменклатураПодразделений
	|ГДЕ
	|	НоменклатураПодразделений.Подразделение = &Подразделение
	|	И НоменклатураПодразделений.Номенклатура В
	|			(ВЫБРАТЬ
	|				втНоменклатура.Ссылка
	|			ИЗ
	|				втНоменклатура)
	|	И НоменклатураПодразделений.ПодЗаказ";
	
	РезультатЗапроса = Запрос.Выполнить();
	
	ТекущийОбъект.ЕстьМатериалПодЗаказ = НЕ РезультатЗапроса.Пустой();
	
	Если ТекущийОбъект.ЕстьМатериалПодЗаказ Тогда
		ДобавитьСтроку(ТекущийОбъект, Номенклатура.ДоставкаМатериала, 1, 0);
	КонецЕсли;
	
	ТекущийОбъект.КоличествоМетровЛДСП = ПлощадьИзготавливаемыхМатериалов;
	
	// Добавление услуги Распил за лист
	
	СуммаЛистовНоменклатуры = 0;
	
	Если (ТипЗнч(СтруктураРаскроя) = Тип("Структура")) И СтруктураРаскроя.Свойство("ТаблицаЛистовНоменклатуры") Тогда
		Для Каждого СтрокаТабЛистов Из СтруктураРаскроя.ТаблицаЛистовНоменклатуры Цикл
			
			СуммаЛистовНоменклатуры = СуммаЛистовНоменклатуры + СтрокаТабЛистов.Количество;
			
		КонецЦикла;
		
		Если СуммаЛистовНоменклатуры > 0 Тогда
			ДобавитьСтроку(ТекущийОбъект, Номенклатура.ПодготовкаЛистовогоМатериала, СуммаЛистовНоменклатуры, 0);
		КонецЕсли;
	КонецЕсли;
	
КонецФункции // ЗаполнитьУслуги()

&НаСервере
Функция ЗаполнитьФотопечать(ТекущийОбъект)
	
	// { Васильев Александр Леонидович [31.07.2014]
	// Пиздец конечно, что приходится так делать
	// но другого пути в одном месте это писать я не вижу
	// } Васильев Александр Леонидович [31.07.2014]
	
	МассивФотопечати = Новый Массив;
	МассивФотопечати.Добавить(Справочники.Номенклатура.СтеклоСФотопечатью4мм);
	МассивФотопечати.Добавить(Справочники.Номенклатура.СтеклоСФотопечатью6мм);
	
	Для каждого Фотопечать Из МассивФотопечати Цикл
		
		ПараметрыОтбора = Новый Структура();
		ПараметрыОтбора.Вставить("Номенклатура", Фотопечать);
		НайденныеСтроки = ТекущийОбъект.СписокНоменклатуры.НайтиСтроки(ПараметрыОтбора);
		
		Для каждого СтрокаФотопечати Из НайденныеСтроки Цикл
			
			ДобавитьСтроку(ТекущийОбъект, Фотопечать.ДополнительнаяУслуга, СтрокаФотопечати.Количество, СтрокаФотопечати.НомерИзделия);
			ДобавитьСтроку(ТекущийОбъект, Фотопечать.ДополнительныйЭлемент, СтрокаФотопечати.Количество, СтрокаФотопечати.НомерИзделия);
			ДобавитьСтроку(ТекущийОбъект, Справочники.Номенклатура.ПленкаОракал, СтрокаФотопечати.Количество, СтрокаФотопечати.НомерИзделия);
			
			ИндексСтроки = ТекущийОбъект.СписокНоменклатуры.Индекс(СтрокаФотопечати);
			ТекущийОбъект.СписокНоменклатуры.Удалить(ИндексСтроки);
			
		КонецЦикла;
		
	КонецЦикла;
	
	Возврат Неопределено;
	
КонецФункции

&НаСервере
Функция ЗаполнитьОсобыеУслуги(ТекущийОбъект)
	
	//Заполнить ОсобыеУслуги
	МассивОсобыхУслуг = Новый Массив;
	
	Для Каждого Строка Из ТекущийОбъект.СписокНоменклатуры Цикл
		Если Строка.Номенклатура.ВыделитьВНаряде Тогда
			МассивОсобыхУслуг.Добавить(Строка.Номенклатура.Наименование);	
		КонецЕсли;
	КонецЦикла;
	
	Если МассивОсобыхУслуг.Количество() > 0 Тогда
		ТекущийОбъект.ОсобыеУслуги = СтроковыеФункцииКлиентСервер.ПолучитьСтрокуИзМассиваПодстрок(МассивОсобыхУслуг, ", ");
	Иначе
		ТекущийОбъект.ОсобыеУслуги = "";
	КонецЕсли;
	
КонецФункции

&НаСервере
Функция УвеличитьМатериалыДоЦелыхЛистов(ТекущийОбъект)
	
	// { Васильев Александр Леонидович [07.05.2015]
	// Здесь же проставляем флаг ПодЗаказ
	// } Васильев Александр Леонидович [07.05.2015]
	
	ТаблицаСпискаНоменклатуры = ТекущийОбъект.СписокНоменклатуры.Выгрузить();
	
	Запрос = Новый Запрос;
	Запрос.УстановитьПараметр("ТаблицаСпискаНоменклатуры", ТаблицаСпискаНоменклатуры);
	Запрос.УстановитьПараметр("Подразделение", ТекущийОбъект.Подразделение);
	Запрос.УстановитьПараметр("ТаблицаСпискаМатериаловЗаказчика", ТекущийОбъект.СписокМатериаловЗаказчика.ВыгрузитьКолонку("Номенклатура"));
	Запрос.Текст =
	"ВЫБРАТЬ
	|	Номенклатура.Ссылка КАК Номенклатура,
	|	ИСТИНА КАК ПредоставитЗаказчик
	|ПОМЕСТИТЬ ТаблицаСпискаМатериаловЗаказчика
	|ИЗ
	|	Справочник.Номенклатура КАК Номенклатура
	|ГДЕ
	|	Номенклатура.Ссылка В(&ТаблицаСпискаМатериаловЗаказчика)
	|
	|ИНДЕКСИРОВАТЬ ПО
	|	Номенклатура
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	ВЫРАЗИТЬ(ТаблицаСпискаНоменклатуры.Номенклатура КАК Справочник.Номенклатура) КАК Номенклатура,
	|	ТаблицаСпискаНоменклатуры.Количество,
	|	ТаблицаСпискаНоменклатуры.ЕдиницаИзмерения,
	|	ТаблицаСпискаНоменклатуры.Цена,
	|	ТаблицаСпискаНоменклатуры.ЗарплатаЦеха,
	|	ТаблицаСпискаНоменклатуры.НомерИзделия,
	|	ТаблицаСпискаНоменклатуры.НомерСтроки,
	|	ТаблицаСпискаНоменклатуры.ПредоставитЗаказчик,
	|	ТаблицаСпискаНоменклатуры.ЧерезСклад,
	|	ТаблицаСпискаНоменклатуры.РозничнаяСтоимость
	|ПОМЕСТИТЬ ТаблицаСпискаНоменклатуры
	|ИЗ
	|	&ТаблицаСпискаНоменклатуры КАК ТаблицаСпискаНоменклатуры
	|
	|ИНДЕКСИРОВАТЬ ПО
	|	Номенклатура
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	ТаблицаСпискаНоменклатуры.Номенклатура,
	|	ТаблицаСпискаНоменклатуры.НомерИзделия,
	|	ТаблицаСпискаНоменклатуры.Количество КАК Количество,
	|	ТаблицаСпискаНоменклатуры.ЧерезСклад КАК ЧерезСклад,
	|	ТаблицаСпискаНоменклатуры.ЕдиницаИзмерения КАК ЕдиницаИзмерения,
	|	ВЫБОР
	|		КОГДА ЕСТЬNULL(НоменклатураПодразделений.ПодЗаказ, ЛОЖЬ)
	|				И НЕ ЕСТЬNULL(ТаблицаСпискаМатериаловЗаказчика.ПредоставитЗаказчик, ЛОЖЬ)
	|			ТОГДА ИСТИНА
	|		ИНАЧЕ ЛОЖЬ
	|	КОНЕЦ КАК ПодЗаказ,
	|	ЕСТЬNULL(НоменклатураПодразделений.Доступность, ЛОЖЬ) КАК Доступность,
	|	ТаблицаСпискаНоменклатуры.Номенклатура.ШиринаДетали КАК ШиринаДетали,
	|	ТаблицаСпискаНоменклатуры.Номенклатура.ДлинаДетали КАК ДлинаДетали,
	|	ЕСТЬNULL(ТаблицаСпискаМатериаловЗаказчика.ПредоставитЗаказчик, ЛОЖЬ) КАК ПредоставитЗаказчик,
	|	ЕСТЬNULL(НоменклатураПодразделений.ОкруглятьДоЛистов, ЛОЖЬ) КАК ОкруглятьДоЛистов
	|ИЗ
	|	ТаблицаСпискаНоменклатуры КАК ТаблицаСпискаНоменклатуры
	|		ЛЕВОЕ СОЕДИНЕНИЕ РегистрСведений.НоменклатураПодразделений КАК НоменклатураПодразделений
	|		ПО (НоменклатураПодразделений.Подразделение = &Подразделение)
	|			И ТаблицаСпискаНоменклатуры.Номенклатура = НоменклатураПодразделений.Номенклатура
	|		ЛЕВОЕ СОЕДИНЕНИЕ ТаблицаСпискаМатериаловЗаказчика КАК ТаблицаСпискаМатериаловЗаказчика
	|		ПО ТаблицаСпискаНоменклатуры.Номенклатура = ТаблицаСпискаМатериаловЗаказчика.Номенклатура";
	
	// Конструкция с реквизитом "ПодЗаказ" для проставления одноименного реквизита в тч "список номенклатуры", зависит
	//от галочки в "номенклатуре подразделений" и наличия этой номенклатуры в тч "материал заказчика".
	
	Таблица = Запрос.Выполнить().Выгрузить();
	
	ТаблицаОкруглятьДоЛистов = Таблица.Скопировать(Новый Структура("ОкруглятьДоЛистов", Истина));
	ТаблицаОкруглятьДоЛистов.Свернуть("Номенклатура, ШиринаДетали, ДлинаДетали, ОкруглятьДоЛистов", "Количество");
	
	Для Каждого Строка Из ТаблицаОкруглятьДоЛистов Цикл
		
		СтрокаМатериала = ТекущийОбъект.СписокЛистовНоменклатуры.Найти(Строка.Номенклатура);
		
		Если СтрокаМатериала = Неопределено Тогда
			Продолжить; // не должны сюда попадать
		КонецЕсли;
		
		// Столешницы и пристенки считаем в погонных метрах.
		Если СтрокаМатериала.Номенклатура.НоменклатурнаяГруппа = Справочники.НоменклатурныеГруппы.Столешница 
			ИЛИ СтрокаМатериала.Номенклатура.НоменклатурнаяГруппа = Справочники.НоменклатурныеГруппы.Пристенок Тогда
			
			КоличествоМатериала = (Строка.Номенклатура.ДлинаДетали / 1000);
			
		Иначе
			
			// { Васильев Александр Леонидович [07.05.2015]
			// Здесь определяем размер листа.
			// Если есть корректная"Основная единица", то берём её коэффициент.
			// } Васильев Александр Леонидович [07.05.2015]
			
			// Будет запрос в цикле, но в среднем 2.6 строки в документе.
			// Т.е. не страшно, да и запрос простой
			КоличествоМатериала = ОпределитьПлощадьЛиста(Строка.Номенклатура) / 1000000;
			
		КонецЕсли;
		
		// { Васильев Александр Леонидович [07.05.2015]
		// Сделать.
		// Вот тут опасно определяем количество материала в спецификации.
		// Что если материал не сгруппирован и есть несколько строк?
		// } Васильев Александр Леонидович [07.05.2015]
		ОстатокМатериала = СтрокаМатериала.Количество * КоличествоМатериала - Строка.Количество;
		
		Если ОстатокМатериала > 0 Тогда
			
			НоваяСтрока = Таблица.Добавить();
			НоваяСтрока.Номенклатура = Строка.Номенклатура;
			НоваяСтрока.ЕдиницаИзмерения = НоваяСтрока.Номенклатура.ЕдиницаИзмерения;
			НоваяСтрока.Количество = ОстатокМатериала;
			
		КонецЕсли;
		
	КонецЦикла;
	
	ТекущийОбъект.СписокНоменклатуры.Загрузить(Таблица);
	
КонецФункции

&НаСервере
Функция ОкруглитьКоличествоМатериалов(ТекущийОбъект)
	
	ТаблицаСпискаНоменклатуры = ТекущийОбъект.СписокНоменклатуры.Выгрузить();
	ТаблицаСпискаНоменклатуры.Свернуть("Номенклатура, ПредоставитЗаказчик", "Количество");
	
	Запрос = Новый Запрос;
	Запрос.УстановитьПараметр("ТаблицаСпискаНоменклатуры", ТаблицаСпискаНоменклатуры);
	Запрос.Текст =
	"ВЫБРАТЬ
	|	ВЫРАЗИТЬ(ТаблицаСпискаНоменклатуры.Номенклатура КАК Справочник.Номенклатура) КАК Номенклатура,
	|	ТаблицаСпискаНоменклатуры.Количество,
	|	ТаблицаСпискаНоменклатуры.ПредоставитЗаказчик
	|ПОМЕСТИТЬ ТаблицаСпискаНоменклатуры
	|ИЗ
	|	&ТаблицаСпискаНоменклатуры КАК ТаблицаСпискаНоменклатуры
	|
	|ИНДЕКСИРОВАТЬ ПО
	|	Номенклатура
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	ТаблицаСпискаНоменклатуры.Номенклатура,
	|	ТаблицаСпискаНоменклатуры.Количество,
	|	ТаблицаСпискаНоменклатуры.ПредоставитЗаказчик,
	|	НоменклатурныеГруппы.ОкруглятьДо
	|ИЗ
	|	ТаблицаСпискаНоменклатуры КАК ТаблицаСпискаНоменклатуры
	|		ЛЕВОЕ СОЕДИНЕНИЕ Справочник.НоменклатурныеГруппы КАК НоменклатурныеГруппы
	|		ПО ТаблицаСпискаНоменклатуры.Номенклатура.НоменклатурнаяГруппа = НоменклатурныеГруппы.Ссылка";
	
	Выборка = Запрос.Выполнить().Выбрать();
	
	Пока Выборка.Следующий() Цикл
		
		Если ЗначениеЗаполнено(Выборка.ОкруглятьДо) и Выборка.ОкруглятьДо > 0 Тогда
			
			Ы = Цел(Выборка.Количество / Выборка.ОкруглятьДо);
			
			Если Ы <> Выборка.Количество / Выборка.ОкруглятьДо Тогда
				
				Ы = Ы * Выборка.ОкруглятьДо;
				
				Пока Ы < Выборка.Количество Цикл
					
					Ы = Ы + Выборка.ОкруглятьДо;
					
				КонецЦикла;
				
				КоличествоДобавляемогоМатериала = Ы - Выборка.Количество;
				ДобавитьСтроку(ТекущийОбъект, Выборка.Номенклатура, КоличествоДобавляемогоМатериала, 0);
				
			КонецЕсли;
			
		КонецЕсли;
		
	КонецЦикла;
	
КонецФункции // ОкруглитьКоличествоМатериалов()

&НаСервере
Функция УвеличитьКоличествоМатериаловНаПроцентОтхода(ТекущийОбъект)
	
	ТаблицаСпискаНоменклатуры = ТекущийОбъект.СписокНоменклатуры.Выгрузить();
	
	Запрос = Новый Запрос;
	Запрос.УстановитьПараметр("ТаблицаСпискаНоменклатуры", ТаблицаСпискаНоменклатуры);
	Запрос.УстановитьПараметр("Подразделение", ТекущийОбъект.Подразделение);
	Запрос.Текст =
	"ВЫБРАТЬ
	|	ВЫРАЗИТЬ(ТаблицаСпискаНоменклатуры.Номенклатура КАК Справочник.Номенклатура) КАК Номенклатура,
	|	ТаблицаСпискаНоменклатуры.Количество,
	|	ТаблицаСпискаНоменклатуры.ЕдиницаИзмерения,
	|	ТаблицаСпискаНоменклатуры.Цена,
	|	ТаблицаСпискаНоменклатуры.ЗарплатаЦеха,
	|	ТаблицаСпискаНоменклатуры.НомерИзделия,
	|	ТаблицаСпискаНоменклатуры.НомерСтроки,
	|	ТаблицаСпискаНоменклатуры.ПредоставитЗаказчик,
	|	ТаблицаСпискаНоменклатуры.ЧерезСклад,
	|	ТаблицаСпискаНоменклатуры.РозничнаяСтоимость
	|ПОМЕСТИТЬ ТаблицаСпискаНоменклатуры
	|ИЗ
	|	&ТаблицаСпискаНоменклатуры КАК ТаблицаСпискаНоменклатуры
	|
	|ИНДЕКСИРОВАТЬ ПО
	|	Номенклатура
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	ТаблицаСпискаНоменклатуры.Номенклатура,
	|	ТаблицаСпискаНоменклатуры.Количество + ТаблицаСпискаНоменклатуры.Количество * ЕСТЬNULL(НоменклатураПодразделений.ПроцентОтхода, 0) / 100 КАК Количество,
	|	ТаблицаСпискаНоменклатуры.ЕдиницаИзмерения,
	|	ТаблицаСпискаНоменклатуры.Цена,
	|	ТаблицаСпискаНоменклатуры.ЗарплатаЦеха,
	|	ТаблицаСпискаНоменклатуры.НомерИзделия,
	|	ТаблицаСпискаНоменклатуры.НомерСтроки,
	|	ТаблицаСпискаНоменклатуры.ПредоставитЗаказчик,
	|	ТаблицаСпискаНоменклатуры.ЧерезСклад,
	|	ТаблицаСпискаНоменклатуры.РозничнаяСтоимость
	|ИЗ
	|	ТаблицаСпискаНоменклатуры КАК ТаблицаСпискаНоменклатуры
	|		ЛЕВОЕ СОЕДИНЕНИЕ РегистрСведений.НоменклатураПодразделений КАК НоменклатураПодразделений
	|		ПО ТаблицаСпискаНоменклатуры.Номенклатура = НоменклатураПодразделений.Номенклатура
	|ГДЕ
	|	(НоменклатураПодразделений.Подразделение = &Подразделение
	|			ИЛИ НоменклатураПодразделений.Подразделение ЕСТЬ NULL )";
	
	Таблица = Запрос.Выполнить().Выгрузить();
	
	ТекущийОбъект.СписокНоменклатуры.Загрузить(Таблица);
	
КонецФункции // УвеличитьКоличествоМатериалаНаПроцентОтхода()

&НаСервере
Функция ЗаполнитьМатериалы(ТекущийОбъект, Ошибки)
	
	ТекущийОбъект.СписокНоменклатуры.Очистить();
	ТекущийОбъект.МерныйМатериал.Очистить();
	
	Изделие = ТекущийОбъект.Изделие;
	
	// Табличная часть справочника Изделия
	МассивУслугСЗарплатойДизайнера = Новый Массив;
	
	Для каждого Строка Из Изделие.СписокНоменклатуры Цикл
		
		Если НЕ ТекущийОбъект.Дилерский ИЛИ Строка.ДобавлятьДилеру Тогда
			
			ДобавитьСтроку(ТекущийОбъект, Строка.Номенклатура, Строка.Количество, 0, Ошибки, "у изделия " + Изделие);
			
			Если Строка.ЗарплатаДизайнеру Тогда
				
				МассивУслугСЗарплатойДизайнера.Добавить(Строка.Номенклатура);
				
			КонецЕсли;
			
		КонецЕсли;
		
	КонецЦикла;
	
	Если МассивУслугСЗарплатойДизайнера.Количество() > 0 Тогда
		
		Запрос = Новый Запрос;
		Запрос.Текст =
		"ВЫБРАТЬ
		|	СУММА(ЦеныНоменклатурыПоПодразделениямСрезПоследних.ПлановаяЗакупочная) КАК ЗарплатаДизайнера
		|ИЗ
		|	РегистрСведений.ЦеныНоменклатурыПоПодразделениям.СрезПоследних(
		|			&МоментВремени,
		|			Подразделение = &Подразделение
		|				И Номенклатура В (&МассивУслугСЗарплатойДизайнера)) КАК ЦеныНоменклатурыПоПодразделениямСрезПоследних";
		
		Запрос.УстановитьПараметр("МассивУслугСЗарплатойДизайнера", МассивУслугСЗарплатойДизайнера);
		Запрос.УстановитьПараметр("МоментВремени", ТекущийОбъект.Дата);
		Запрос.УстановитьПараметр("Подразделение", ТекущийОбъект.Подразделение);
		
		РезультатЗапроса = Запрос.Выполнить();
		ВыборкаДетальныеЗаписи = РезультатЗапроса.Выбрать();
		ВыборкаДетальныеЗаписи.Следующий();
		ТекущийОбъект.ЗарплатаДизайнера = ВыборкаДетальныеЗаписи.ЗарплатаДизайнера;
		
	КонецЕсли;
	
	ТаблицаКантовПоместу = Новый ТаблицаЗначений;
	ТаблицаКантовПоместу.Колонки.Добавить("Номенклатура");
	ТаблицаКантовПоместу.Колонки.Добавить("ЕдиницаИзмерения");
	ТаблицаКантовПоместу.Колонки.Добавить("Количество");
	ТаблицаКантовПоместу.Колонки.Добавить("НомерИзделия");
	
	#ОБЛАСТЬ Основной_цикл_заполнения_материалов
	
	Для Каждого Строка Из ТекущийОбъект.СписокМатериалы Цикл
		
		// Заполним реквизит ВидДетали
		Материал = Строка.Материал;
		Справочник = Справочники.ВидыДеталей;
		РезультатПоискаПоНаименованию = Справочник.НайтиПоНаименованию(Материал);
		Строка.ВидДетали = ?(РезультатПоискаПоНаименованию = Неопределено, Справочник.ПустаяСсылка(), РезультатПоискаПоНаименованию);
		
		// Добавляем номенклатуру из ТЧ Материалы
		
		Клееная = Клееная(Материал);
		ФасадСПрофилем = Материал = "ФасадАГТ" ИЛИ Материал = "ФасадАлюминиевый";
		ФасадМДФ = Материал = "ФасадМДФ";
		Пуфик = Материал = "Пуфик";
		Номенклатура = Справочники.Номенклатура;
		ЛДСП = Найти(Материал, "ЛДСП") <> 0;
		КоличествоДеталей = Строка.Количество;
		ВысотаДетали = Строка.ВысотаДетали;
		ШиринаДетали = Строка.ШиринаДетали;
		
		//Ручки
		
		Если НЕ Клееная И НЕ Пуфик И ЗначениеЗаполнено(Строка.НоменклатураДляСклеивания) Тогда
			
			ДобавитьСтроку(ТекущийОбъект, Строка.НоменклатураДляСклеивания, Строка.Количество, Строка.НомерИзделия, Ошибки);
			
		КонецЕсли;
		
		Если ФасадСПрофилем Тогда
			
			ВместимостьНаЛисте(Строка.Номенклатура, ВысотаДетали, ШиринаДетали, Ошибки, "фасада у детали № " + Строка.НомерСтроки, "СписокМатериалы", Строка.НомерСтроки);
			
			Если ВысотаДетали > 0 И ШиринаДетали > 0 Тогда
				Площадь = ((ВысотаДетали + 2 * Строка.УниверсальнаяКромка.ШиринаПаза) * (ШиринаДетали + 2 * Строка.УниверсальнаяКромка.ШиринаПаза) / 1000000) * КоличествоДеталей;
			Иначе
				Площадь = 0;
			КонецЕсли;
			
			ДобавитьСтроку(ТекущийОбъект, Строка.Номенклатура, Площадь, Строка.НомерИзделия, Ошибки, "фасада у детали № " + Строка.НомерСтроки, "СписокМатериалы", Строка.НомерСтроки);
			
			Периметр = (ШиринаДетали + ВысотаДетали + 4 * Строка.УниверсальнаяКромка.ГлубинаДетали) * 2;
			ДлинаПрофиля = Периметр * КоличествоДеталей / 1000;
			ДобавитьСтроку(ТекущийОбъект, Строка.УниверсальнаяКромка, ДлинаПрофиля, Строка.НомерИзделия, Ошибки, "универсальной кромки у детали № " + Строка.НомерСтроки, "СписокМатериалы", Строка.НомерСтроки);
			ШиринаВставки = Строка.Номенклатура.ГлубинаДетали;
			ШиринаПаза = Строка.УниверсальнаяКромка.ШиринаПаза;
			ПериметрВставки = (ВысотаДетали + ШиринаДетали) * 2 / 1000;
			
			Если Материал = "ФасадАГТ" Тогда
				
				ДобавитьСтроку(ТекущийОбъект, Номенклатура.Шпонка, КоличествоДеталей * 8, Строка.НомерИзделия, Ошибки);
				УплотнительДляПрофиля = Номенклатура.АГТУплотнитель;
				
			ИначеЕсли Материал = "ФасадАлюминиевый" Тогда
				
				УплотнительДляПрофиля = Номенклатура.УплотнительДляАлюминиевогоПрофиля;
				
				ДобавитьСтроку(ТекущийОбъект, Номенклатура.УголСоединительныйКАлюминевомуПрофилю, КоличествоДеталей * 4, Строка.НомерИзделия, Ошибки);
				
				КоличествоВтулок = КоличествоДеталей * 2;
				ДобавитьСтроку(ТекущийОбъект, Номенклатура.ВтулкаДистанционнаяАлюминиевая, КоличествоВтулок, Строка.НомерИзделия, Ошибки);
				ДопЭлемент = Номенклатура.ВтулкаДистанционнаяАлюминиевая.ДополнительныйЭлемент;
				Если ЗначениеЗаполнено(ДопЭлемент) Тогда
					ДобавитьСтроку(ТекущийОбъект, ДопЭлемент, КоличествоВтулок, Строка.НомерИзделия, Ошибки);
				КонецЕсли;
				
			КонецЕсли; // Материал = "ФасадАГТ"
			
			Если ШиринаПаза > ШиринаВставки Тогда
				
				ДобавитьСтроку(ТекущийОбъект, УплотнительДляПрофиля, ПериметрВставки * КоличествоДеталей, Строка.НомерИзделия, Ошибки);
				
			ИначеЕсли ШиринаПаза < ШиринаВставки Тогда
				
				ДобавитьСтроку(ТекущийОбъект, Номенклатура.ФрезеровкаДеталиЗонаКухонь, ПериметрВставки * КоличествоДеталей, Строка.НомерИзделия, Ошибки);
				
			КонецЕсли;
			
		Иначе // НЕ ФасадСПрофилем
			
			Если Материал = "Столешница" ИЛИ Материал = "Пристенок" Тогда // по хорошему бы от единицы измерения отталкиваться
				
				ПодЗаказ = ЛексСервер.НоменклатураПодЗаказ(Строка.Номенклатура, Объект.Подразделение);
				
				Если ПодЗаказ Тогда
					
					Площадь = (ВысотаДетали / 1000) * КоличествоДеталей;
					
				Иначе
					
					СтруктураКратности = ЛексСервер.ПосчитатьКратность(Строка.Номенклатура, ВысотаДетали);
					
					Если СтруктураКратности.КоличествоМатериала = ВысотаДетали Тогда
						
						Площадь = (ВысотаДетали / 1000) * КоличествоДеталей;
						
					Иначе
						
						Площадь = СтруктураКратности.КоличествоМатериала / 1000 * КоличествоДеталей;
						
					КонецЕсли;
					
				КонецЕсли;
				
			Иначе
				
				Если Пуфик Тогда
					
					Периметр = (ВысотаДетали + ШиринаДетали) * 2;
					КоличествоШурупов = Окр(Периметр / 150);
					КоличествоШурупов = Макс(6, КоличествоШурупов);
					ДобавитьСтроку(ТекущийОбъект, Справочники.Номенклатура.Шуруп16х35черный, КоличествоШурупов, Строка.НомерИзделия, Ошибки, "у детали № " + Строка.НомерСтроки, "СписокМатериалы", Строка.НомерСтроки);
					
					ПлощадьКожи = ((ВысотаДетали + 300) * (ШиринаДетали +300) / 1000000) * КоличествоДеталей;
					ДобавитьСтроку(ТекущийОбъект, Строка.НоменклатураДляСклеивания, ПлощадьКожи, Строка.НомерИзделия, Ошибки, "у детали № " + Строка.НомерСтроки, "СписокМатериалы", Строка.НомерСтроки);
					ДобавитьСтроку(ТекущийОбъект, Справочники.Номенклатура.Поролон, ПлощадьКожи, Строка.НомерИзделия, Ошибки, "у детали № " + Строка.НомерСтроки, "СписокМатериалы", Строка.НомерСтроки);
					
				КонецЕсли;
				
				Площадь = (ВысотаДетали * ШиринаДетали / 1000000) * КоличествоДеталей;
				
			КонецЕсли;
			
			ВместимостьНаЛисте(Строка.Номенклатура, ВысотаДетали, ШиринаДетали, Ошибки, "у детали № " + Строка.НомерСтроки, "СписокМатериалы", Строка.НомерСтроки);
			
			ДобавитьСтроку(ТекущийОбъект, Строка.Номенклатура, Площадь, Строка.НомерИзделия, Ошибки, "у детали № " + Строка.НомерСтроки, "СписокМатериалы", Строка.НомерСтроки);
			
		КонецЕсли; // ФасадСПрофилем
		
		Если ЗначениеЗаполнено(Строка.Петли) Тогда
			
			ДобавитьСтроку(ТекущийОбъект, Строка.Петли, Строка.КоличествоПетель * КоличествоДеталей, Строка.НомерИзделия, Ошибки);
			
		КонецЕсли;
		
		//Если ФасадМДФ Тогда
		//	
		//	Площадь = ШиринаДетали * КоличествоДеталей / 1000;
		//	
		//	Если Строка.УниверсальнаяКромка.НоменклатурнаяГруппа = Справочники.НоменклатурныеГруппы.ТорцеваяРучка18мм Тогда
		//		
		//		ДобавитьСтроку(ТекущийОбъект, Строка.УниверсальнаяКромка, КоличествоДеталей, Строка.НомерИзделия, Ошибки, "универсальной кромки у детали № " + Строка.НомерСтроки, "СписокМатериалы", Строка.НомерСтроки);
		//		
		//	Иначе
		//		
		//		ДобавитьСтроку(ТекущийОбъект, Строка.УниверсальнаяКромка, Площадь, Строка.НомерИзделия, Ошибки, "универсальной кромки у детали № " + Строка.НомерСтроки, "СписокМатериалы", Строка.НомерСтроки);
		//		
		//	КонецЕсли;
		//		
		//КонецЕсли;
		
		Если Клееная Тогда
			
			ДобавитьСтроку(ТекущийОбъект, Строка.НоменклатураДляСклеивания, Площадь, Строка.НомерИзделия, Ошибки, "клееной у детали № " + Строка.НомерСтроки, "СписокМатериалы", Строка.НомерСтроки);
			
		КонецЕсли;
		
		//Считаем кромку. Для Фасадов с Профилем уже посчитана
		Если НЕ ФасадСПрофилем Тогда
			
			КромкиСлеваСправа = Новый Массив;
			КромкиСверхуСнизу = Новый Массив;
			
			Если ЗначениеЗаполнено(Строка.ВыборМебельнойКромкиСверху) Тогда
				Если Строка.ПереключательКромкаСверху = "По месту" Тогда
					НоваяСтрока = ТаблицаКантовПоместу.Добавить();
					ДобавитьКантПоМесту(НоваяСтрока, Строка.ВыборМебельнойКромкиСверху, Строка.ШиринаДетали * Строка.Количество / 1000, Строка.НомерИзделия);
				Иначе
					КромкиСверхуСнизу.Добавить(Строка.ВыборМебельнойКромкиСверху);
				КонецЕсли;
				
			КонецЕсли;
			
			Если ЗначениеЗаполнено(Строка.ВыборМебельнойКромкиСнизу) Тогда
				Если Строка.ПереключательКромкаСнизу = "По месту" Тогда
					НоваяСтрока = ТаблицаКантовПоместу.Добавить();
					ДобавитьКантПоМесту(НоваяСтрока, Строка.ВыборМебельнойКромкиСнизу, Строка.ШиринаДетали * Строка.Количество / 1000, Строка.НомерИзделия);
				Иначе
					КромкиСверхуСнизу.Добавить(Строка.ВыборМебельнойКромкиСнизу);
				КонецЕсли;
			КонецЕсли;
			
			Если ЗначениеЗаполнено(Строка.ВыборМебельнойКромкиСлева) Тогда
				Если Строка.ПереключательКромкаСлева = "По месту" Тогда
					НоваяСтрока = ТаблицаКантовПоместу.Добавить();
					ДобавитьКантПоМесту(НоваяСтрока, Строка.ВыборМебельнойКромкиСлева, Строка.ВысотаДетали * Строка.Количество / 1000, Строка.НомерИзделия);
				Иначе
					КромкиСлеваСправа.Добавить(Строка.ВыборМебельнойКромкиСлева);
				КонецЕсли;
			КонецЕсли;
			
			Если ЗначениеЗаполнено(Строка.ВыборМебельнойКромкиСправа) Тогда
				Если Строка.ПереключательКромкаСправа = "По месту" Тогда
					НоваяСтрока = ТаблицаКантовПоместу.Добавить();
					ДобавитьКантПоМесту(НоваяСтрока, Строка.ВыборМебельнойКромкиСправа, Строка.ВысотаДетали * Строка.Количество / 1000, Строка.НомерИзделия);
				Иначе
					КромкиСлеваСправа.Добавить(Строка.ВыборМебельнойКромкиСправа);
				КонецЕсли;
			КонецЕсли;
			
			Для Каждого Строчка Из КромкиСверхуСнизу Цикл
				
				Если Строчка.НоменклатурнаяГруппа = Справочники.НоменклатурныеГруппы.ТорцеваяРучка16мм или Строчка.НоменклатурнаяГруппа = Справочники.НоменклатурныеГруппы.ТорцеваяРучка18мм Тогда
					
					Площадь = КоличествоДеталей;
					
				Иначе
					
					Площадь = ШиринаДетали * КоличествоДеталей / 1000;
					
				КонецЕсли;
				
				ДобавитьСтроку(ТекущийОбъект, Строчка, Площадь, Строка.НомерИзделия, Ошибки, "кромки у детали № " + Строка.НомерСтроки, "СписокМатериалы", Строка.НомерСтроки);
				
			КонецЦикла;
			
			Для Каждого Строчка Из КромкиСлеваСправа Цикл
				
				Если Строчка.НоменклатурнаяГруппа = Справочники.НоменклатурныеГруппы.ТорцеваяРучка16мм или Строчка.НоменклатурнаяГруппа = Справочники.НоменклатурныеГруппы.ТорцеваяРучка18мм Тогда
					
					Площадь = КоличествоДеталей;
					
				Иначе
					
					Площадь = ВысотаДетали * КоличествоДеталей / 1000;
					
				КонецЕсли;
				
				ДобавитьСтроку(ТекущийОбъект, Строчка, Площадь, Строка.НомерИзделия, Ошибки, "кромки у детали № " + Строка.НомерСтроки, "СписокМатериалы", Строка.НомерСтроки);
				
			КонецЦикла;
			
			//Если деталь криволинейная и у нее есть кромка - считаем ее
			КантыИзРедактора = Строка.КантыИзРедактора;
			
			Если ЗначениеЗаполнено(КантыИзРедактора) Тогда 
				
				КантыИзРедактора = ЗначениеИзСтрокиВнутр(КантыИзРедактора);
				МассивКантов = СтроковыеФункцииКлиентСервер.РазложитьСтрокуВМассивПодстрок(КантыИзРедактора, "|");
				//МассивКантов.Удалить(МассивКантов.Количество()-1);
				
				Для Каждого Кромка Из МассивКантов Цикл
					
					ПараметрыКанта = СтроковыеФункцииКлиентСервер.РазложитьСтрокуВМассивПодстрок(Кромка, "_");
					НоменклатурныйНомер = ПараметрыКанта[0];
					ДлинаКанта = Число(ПараметрыКанта[1]);
					НоменклатураКанта = Номенклатура.НайтиПоКоду(НоменклатурныйНомер);
					ДлинаКромления = ДлинаКанта * КоличествоДеталей / 1000;
					
					Если Клееная Тогда
						
						ДлинаКромления = ДлинаКромления * 2;
						
					КонецЕсли;
					
					ДобавитьСтроку(ТекущийОбъект, НоменклатураКанта, ДлинаКромления, Строка.НомерИзделия, Ошибки, "канта из редактора у детали № " + Строка.НомерСтроки, "СписокМатериалы", Строка.НомерСтроки);
					
				КонецЦикла;
				
			КонецЕсли;
			
		КонецЕсли; // Если НЕ ФасадСПрофилем Тогда
		
	КонецЦикла;
	
	#КОНЕЦОБЛАСТИ
	
	#ОБЛАСТЬ Ящики
	
	Если НовыеЯщики Тогда
		
			ТаблицаМатериалыЯщиков = Документы.Спецификация.ПолучитьТаблицуМатериаловЯщики(ТаблицаДеталиЯщиков, ТекущийОбъект);
			
			Для Каждого МатериалЯщика Из ТаблицаМатериалыЯщиков Цикл
				
				ДобавитьСтроку(ТекущийОбъект, МатериалЯщика.Номенклатура, МатериалЯщика.Количество, МатериалЯщика.НомерИзделия);
				
			КонецЦикла;
				
	Иначе	
		
			Для каждого Строка Из ТекущийОбъект.СписокЯщики Цикл
				
				ОшибкаРазмеров = НЕ ЗначениеЗаполнено(Строка.ПроемЯщика) ИЛИ НЕ ЗначениеЗаполнено(Строка.ВысотаЯщика) ИЛИ НЕ ЗначениеЗаполнено(Строка.ГлубинаЯщика);
				
				Если НЕ ЗначениеЗаполнено(Строка.ПроемЯщика) Тогда
					ОбщегоНазначенияКлиентСервер.ДобавитьОшибкуПользователю(Ошибки, "Объект.СписокЯщики[" + (Строка.НомерСтроки - 1) + "].Номенклатура", "Не заполнен проем у ящика № " + Строка.НомерСтроки);	
				КонецЕсли;
				
				Если НЕ ЗначениеЗаполнено(Строка.ВысотаЯщика) Тогда
					ОбщегоНазначенияКлиентСервер.ДобавитьОшибкуПользователю(Ошибки, "Объект.СписокЯщики[" + (Строка.НомерСтроки - 1) + "].Номенклатура", "Не заполнена высота у ящика № " + Строка.НомерСтроки);
				КонецЕсли;
				
				Если НЕ ЗначениеЗаполнено(Строка.ГлубинаЯщика) Тогда
					ОбщегоНазначенияКлиентСервер.ДобавитьОшибкуПользователю(Ошибки, "Объект.СписокЯщики[" + (Строка.НомерСтроки - 1) + "].Номенклатура", "Не заполнена глубина у ящика № " + Строка.НомерСтроки);
				КонецЕсли;
				
				КоличествоЯщиков = Строка.КоличествоЯщиков;
				//Направляющие для ящика
				Если НЕ Строка.БезНаправляющих Тогда
					ДобавитьСтроку(ТекущийОбъект, Строка.НаправляющиеНоменклатура, КоличествоЯщиков, Строка.НомерИзделия, Ошибки, "направляющей у ящика № " + Строка.НомерСтроки, "СписокЯщики", Строка.НомерСтроки, ОшибкаРазмеров);
				КонецЕсли;
				
				//Считаем материал стенок, ребер и кромку
				Если Строка.ВидЯщика = Перечисления.ВидыЯщика.Обычный Тогда
					
					ПлощадьКромки = (2 * Строка.ШиринаБоковойСтороны + 2 * Строка.ГлубинаЯщика + Строка.ДлинаРебро) * Строка.КоличествоЯщиков / 1000;
					//Площадь = ((Строка.ШиринаБоковойСтороны * Строка.ВысотаЯщика * 2 + Строка.ГлубинаЯщика * Строка.ВысотаЯщика * 2 +
					//Строка.ДлинаРебро * Строка.ВысотаЯщика) / 1000000) * КоличествоЯщиков;
					
					ВместимостьНаЛисте(Строка.Номенклатура, Строка.ШиринаБоковойСтороны, Строка.ВысотаБоковойСтороны, Ошибки, "боковой стороны у ящика № " + Строка.НомерСтроки, "СписокЯщики", Строка.НомерСтроки);
					ДобавитьСтроку(ТекущийОбъект, Строка.Номенклатура, ((Строка.ШиринаБоковойСтороны * Строка.ВысотаБоковойСтороны * 2) / 1000000) * КоличествоЯщиков, Строка.НомерИзделия, Ошибки, "боковой стороны у ящика № " + Строка.НомерСтроки, "СписокЯщики", Строка.НомерСтроки, ОшибкаРазмеров);
					
					ВместимостьНаЛисте(Строка.Номенклатура, Строка.ДлинаБоковойСтороны, Строка.ВысотаБоковойСтороны, Ошибки, "боковой стороны у ящика № " + Строка.НомерСтроки, "СписокЯщики", Строка.НомерСтроки);
					ДобавитьСтроку(ТекущийОбъект, Строка.Номенклатура, ((Строка.ДлинаБоковойСтороны * Строка.ВысотаБоковойСтороны * 2) / 1000000) * КоличествоЯщиков, Строка.НомерИзделия, Ошибки, "боковой стороны у ящика № " + Строка.НомерСтроки, "СписокЯщики", Строка.НомерСтроки, ОшибкаРазмеров);
					
					Если ЗначениеЗаполнено(Строка.ДлинаРебро) Тогда
						
						ВместимостьНаЛисте(Строка.Номенклатура, Строка.ДлинаРебро, Строка.ВысотаЯщика, Ошибки, "ребра у ящика № " + Строка.НомерСтроки, "СписокЯщики", Строка.НомерСтроки);
						ДобавитьСтроку(ТекущийОбъект, Строка.Номенклатура, ((Строка.ДлинаРебро * Строка.ВысотаЯщика) / 1000000) * КоличествоЯщиков, Строка.НомерИзделия, Ошибки, "ребра у ящика № " + Строка.НомерСтроки, "СписокЯщики", Строка.НомерСтроки, ОшибкаРазмеров);
						
					КонецЕсли;
					
				Иначе
					
					ПлощадьКромки = 2 * (Строка.ШиринаБоковойСтороны + Строка.ВысотаБоковойСтороны + Строка.ДлинаДно + Строка.ШиринаДно) * Строка.КоличествоЯщиков/1000;
					Площадь = (Строка.ШиринаБоковойСтороны * Строка.ВысотаБоковойСтороны) / 1000000 * КоличествоЯщиков;
					ВместимостьНаЛисте(Строка.Номенклатура, Строка.ШиринаБоковойСтороны, Строка.ВысотаБоковойСтороны, Ошибки, "боковой стороны у ящика № " + Строка.НомерСтроки, "СписокЯщики", Строка.НомерСтроки);
					ДобавитьСтроку(ТекущийОбъект, Строка.Номенклатура, Площадь, Строка.НомерИзделия, Ошибки, "боковой стороны у ящика № " + Строка.НомерСтроки, "СписокЯщики", Строка.НомерСтроки, ОшибкаРазмеров);
					
					Если Строка.ВысотаЯщика > 150 Тогда
						//Рейлинги для МТ и ТБ
						ГруппаРейлингов = ?(Строка.НаправляющиеНоменклатура.НоменклатурнаяГруппа = Справочники.НоменклатурныеГруппы.Метабокс, 
						Справочники.НоменклатурныеГруппы.РейлингПодМетабокс, Справочники.НоменклатурныеГруппы.РейлингПодТандембокс);
						
						РейлингКНаправляющим = НайтиНаправляющиеНоменклатура(ГруппаРейлингов, Строка.НаправляющиеНоменклатура.ДлинаДетали, Истина);
						
						Если ЗначениеЗаполнено(РейлингКНаправляющим) Тогда
							ДобавитьСтроку(ТекущийОбъект, РейлингКНаправляющим, ?(Строка.ВысотаЯщика < 201, КоличествоЯщиков, КоличествоЯщиков * 2), Строка.НомерИзделия, Ошибки);
						КонецЕсли;
						
						//Соединители для ТБ
						Если Строка.ВидЯщика = Перечисления.ВидыЯщика.Тандембокс Тогда
							Соединитель = ?(Строка.ВысотаЯщика < 201, Справочники.Номенклатура.СоединительДляТандембокс1шт, Справочники.Номенклатура.СоединительДляТандембокс2шт);
							ДобавитьСтроку(ТекущийОбъект, Соединитель, КоличествоЯщиков, Строка.НомерИзделия, Ошибки);
						КонецЕсли;
					КонецЕсли;
				КонецЕсли;
				
				ДобавитьСтроку(ТекущийОбъект, Строка.КромкаНоменклатура, ПлощадьКромки, Строка.НомерИзделия, Ошибки, "кромки у ящика № " + Строка.НомерСтроки, "СписокЯщики", Строка.НомерСтроки, ОшибкаРазмеров);
				
				Площадь = Строка.ДлинаДно * Строка.ШиринаДно * КоличествоЯщиков / 1000000;
				ВместимостьНаЛисте(Строка.ДноНоменклатура, Строка.ДлинаДно, Строка.ШиринаДно, Ошибки, "дно у ящика № " + Строка.НомерСтроки, "СписокЯщики", Строка.НомерСтроки);
				ДобавитьСтроку(ТекущийОбъект, Строка.ДноНоменклатура, Площадь, Строка.НомерИзделия, Ошибки, "дно у ящика № " + Строка.НомерСтроки, "СписокЯщики", Строка.НомерСтроки, ОшибкаРазмеров);
				
				//Кромим дно если 10ЛДСП
				Если ЗначениеЗаполнено(Строка.ДноНоменклатура) Тогда
					
					Если Строка.ДноНоменклатура.НоменклатурнаяГруппа = Справочники.НоменклатурныеГруппы.ЛДСП10 Тогда
						
						Площадь = (Строка.ДлинаДно + Строка.ШиринаДно)* 2  * Строка.КоличествоЯщиков / 1000;
						ДобавитьСтроку(ТекущийОбъект, Строка.КромкаНоменклатура, Площадь, Строка.НомерИзделия, Ошибки);
						
					КонецЕсли;
					
				КонецЕсли;
				
				
				//Добавляем фасады: материал, кромку и ручки
				Если Строка.ВидФасада <> "Нет" Тогда
					
					Если Строка.КромкаФасадНоменклатура.НоменклатурнаяГруппа = Справочники.НоменклатурныеГруппы.АГТПрофиль Тогда
						ДобавитьСтроку(ТекущийОбъект, Справочники.Номенклатура.Шпонка, КоличествоЯщиков * 8, Строка.НомерИзделия, Ошибки);
					КонецЕсли;
					
					ШиринаФасадБезКромки = (Строка.ШиринаФасад - 2 * Строка.КромкаФасадНоменклатура.ГлубинаДетали);
					ВысотаФасадБезКромки = (Строка.ВысотаФасад - 2 * Строка.КромкаФасадНоменклатура.ГлубинаДетали);
					
					Если ШиринаФасадБезКромки > 0 И ВысотаФасадБезКромки > 0 Тогда
						Площадь = ШиринаФасадБезКромки * ВысотаФасадБезКромки * КоличествоЯщиков / 1000000;
					Иначе
						Площадь = 0;
					КонецЕсли;
					
					ВместимостьНаЛисте(Строка.ФасадНоменклатура, ВысотаФасадБезКромки, ШиринаФасадБезКромки, Ошибки, "фасада у ящика № " + Строка.НомерСтроки, "СписокЯщики", Строка.НомерСтроки);
					ДобавитьСтроку(ТекущийОбъект, Строка.ФасадНоменклатура, Площадь, Строка.НомерИзделия, Ошибки, "фасада у ящика № " + Строка.НомерСтроки, "СписокЯщики", Строка.НомерСтроки);
					
					//Ручки для ящиков
					Если Строка.КоличествоРучек > 0 Тогда
						
						КоличествоРучек = Строка.КоличествоРучек * КоличествоЯщиков;
						ДобавитьСтроку(ТекущийОбъект, Строка.РучкаНоменклатура, КоличествоРучек, Строка.НомерИзделия, Ошибки, "ручки у ящика № " + Строка.НомерСтроки, "СписокЯщики", Строка.НомерСтроки);
						
					КонецЕсли;
					
					Площадь = (2 * Строка.ШиринаФасад + 2 * Строка.ВысотаФасад) * Строка.КоличествоЯщиков / 1000; 
					ДобавитьСтроку(ТекущийОбъект, Строка.КромкаФасадНоменклатура, Площадь, Строка.НомерИзделия, Ошибки, "кромки фасада у ящика № " + Строка.НомерСтроки, "СписокЯщики", Строка.НомерСтроки);
					
				КонецЕсли;
				
			КонецЦикла;
	
	КонецЕсли;
	
	#КОНЕЦОБЛАСТИ
	
	//Добавляем номенклатуру из комплектации
	Для каждого Строка Из ТекущийОбъект.Комплектация Цикл
		
		ДобавитьСтроку(ТекущийОбъект, Строка.Номенклатура, Строка.Количество, Строка.НомерИзделия, Ошибки, "строки  комплектации № " + Строка.НомерСтроки, "Комплектация", Строка.НомерСтроки);
		
	КонецЦикла;
	
	// ключ шестигранный
	Если ТекущийОбъект.СписокДверей.Количество() > 0 Тогда
		ДобавитьСтроку(ТекущийОбъект, Справочники.Номенклатура.КлючШестигранный, 1, 0, Ошибки);
	КонецЕсли;
	
	//Добавляем номенклатуру из дверей
	Для каждого Строка Из ТекущийОбъект.СписокДверей Цикл
		
		ТаблицаНоменклатурыДверей = Строка.Двери.СписокНоменклатуры;
		
		Для каждого СтрокаНоменклатуры Из ТаблицаНоменклатурыДверей Цикл
			
			СтруктураКратности = ЛексСервер.ПосчитатьКратность(СтрокаНоменклатуры.Номенклатура, СтрокаНоменклатуры.КоличествоСОтходом);
			ДобавитьСтроку(ТекущийОбъект, СтрокаНоменклатуры.Номенклатура, СтруктураКратности.КоличествоМатериала, 0, Ошибки, "строки № " + СтрокаНоменклатуры.НомерСтроки + " у двери № " + Строка.НомерСтроки, "СписокДверей", Строка.НомерСтроки);
			
		КонецЦикла;
		
	КонецЦикла;
	
	Если ТаблицаКантовПоместу.Количество() > 0 Тогда
		
		ТаблицаКантовПоместу.Свернуть("Номенклатура", "Количество");
		
		Для каждого Строчка Из ТаблицаКантовПоместу Цикл
			
			КоличествоКанта = Строчка.Количество + Строчка.Количество * 0.01 * 15; //Дима сказал добавить к канту по месту 15 процентов
			
			НоваяСтрока = ТекущийОбъект.СписокНоменклатуры.Добавить();
			НоваяСтрока.Номенклатура = Строчка.Номенклатура;
			НоваяСтрока.ЕдиницаИзмерения = НоваяСтрока.Номенклатура.ЕдиницаИзмерения;
			НоваяСтрока.Количество = КоличествоКанта;
			НоваяСтрока.НомерИзделия = 0;
			НоваяСтрока.ЧерезСклад = Ложь;
			
			// { Васильев Александр Леонидович [10.12.2013]
			// мерный материал
			НоваяСтрока = ТекущийОбъект.МерныйМатериал.Добавить();
			НоваяСтрока.Номенклатура = Строчка.Номенклатура;
			НоваяСтрока.Количество = КоличествоКанта;
			НоваяСтрока.НомерИзделия = 0;
			// } Васильев Александр Леонидович [10.12.2013]
			
		КонецЦикла;
		
	КонецЕсли;
	
КонецФункции // ЗаполнитьМатериалы()

&НаСервере
Процедура ЗаполнитьСтоимость(ТекущийОбъект)
	
	ТаблицаСпискаНоменклатуры = ТекущийОбъект.СписокНоменклатуры.Выгрузить();
	ТаблицаСпискаМатериаловПодЗаказ = ТекущийОбъект.СписокМатериаловПодЗаказ.Выгрузить();
	
	КоэффициентУслуги = 1;
	КоэффициентМатериалы = 1;
	
	Если НЕ ТекущийОбъект.Дилерский Тогда
		
		//КоэффициентУслуги = Макс(ТекущийОбъект.Офис.КоэффициентУслуги, 1); // А если коэффициент меньше единицы?
		
		КоэффициентУслуги = ТекущийОбъект.Офис.КоэффициентУслуги;
		Если НЕ ЗначениеЗаполнено(КоэффициентУслуги) Тогда
			КоэффициентУслуги = 1;
		КонецЕсли;
		
		КоэффициентМатериалы = ТекущийОбъект.Офис.КоэффициентМатериалы;
		Если НЕ ЗначениеЗаполнено(КоэффициентМатериалы) Тогда
			КоэффициентМатериалы = 1;
		КонецЕсли;
		
	КонецЕсли;
	
	СписокМатериаловЗаказчика = ТекущийОбъект.СписокМатериаловЗаказчика.Выгрузить();
	
	Запрос = Новый Запрос;
	Запрос.УстановитьПараметр("ТаблицаСпискаНоменклатуры", ТаблицаСпискаНоменклатуры);
	Запрос.УстановитьПараметр("ТаблицаСпискаМатериаловПодЗаказ", ТаблицаСпискаМатериаловПодЗаказ);
	Запрос.УстановитьПараметр("ТаблицаСпискаМатериаловЗаказчика", СписокМатериаловЗаказчика);
	Запрос.УстановитьПараметр("Подразделение", ТекущийОбъект.Подразделение);
	Запрос.УстановитьПараметр("КоэффициентМатериалы", КоэффициентМатериалы);
	Запрос.УстановитьПараметр("КоэффициентУслуги", КоэффициентУслуги);
	Запрос.УстановитьПараметр("Период", ТекущийОбъект.Дата);
	
	Запрос.Текст =
	"ВЫБРАТЬ
	|	ВЫРАЗИТЬ(ТаблицаСпискаНоменклатуры.Номенклатура КАК Справочник.Номенклатура) КАК Номенклатура,
	|	ТаблицаСпискаНоменклатуры.Количество,
	|	ТаблицаСпискаНоменклатуры.ЕдиницаИзмерения,
	|	ТаблицаСпискаНоменклатуры.Цена,
	|	ТаблицаСпискаНоменклатуры.ЗарплатаЦеха,
	|	ТаблицаСпискаНоменклатуры.НомерИзделия,
	|	ТаблицаСпискаНоменклатуры.НомерСтроки,
	|	ТаблицаСпискаНоменклатуры.ЧерезСклад,
	|	ТаблицаСпискаНоменклатуры.ПредоставитЗаказчик,
	|	ТаблицаСпискаНоменклатуры.РозничнаяСтоимость,
	|	ТаблицаСпискаНоменклатуры.ПодЗаказ
	|ПОМЕСТИТЬ ТаблицаСпискаНоменклатуры
	|ИЗ
	|	&ТаблицаСпискаНоменклатуры КАК ТаблицаСпискаНоменклатуры
	|
	|ИНДЕКСИРОВАТЬ ПО
	|	Номенклатура
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	ВЫРАЗИТЬ(ТаблицаСпискаМатериаловЗаказчика.Номенклатура КАК Справочник.Номенклатура) КАК Номенклатура,
	|	ТаблицаСпискаМатериаловЗаказчика.Комментарий
	|ПОМЕСТИТЬ ТаблицаСпискаМатериаловЗаказчика
	|ИЗ
	|	&ТаблицаСпискаМатериаловЗаказчика КАК ТаблицаСпискаМатериаловЗаказчика
	|
	|ИНДЕКСИРОВАТЬ ПО
	|	Номенклатура
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	ВЫРАЗИТЬ(ТаблицаСпискаМатериаловПодЗаказ.Номенклатура КАК Справочник.Номенклатура) КАК Номенклатура,
	|	ТаблицаСпискаМатериаловПодЗаказ.Поставщик,
	|	ТаблицаСпискаМатериаловПодЗаказ.Комментарий
	|ПОМЕСТИТЬ ТаблицаСпискаМатериаловПодЗаказ
	|ИЗ
	|	&ТаблицаСпискаМатериаловПодЗаказ КАК ТаблицаСпискаМатериаловПодЗаказ
	|
	|ИНДЕКСИРОВАТЬ ПО
	|	Номенклатура
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ РАЗРЕШЕННЫЕ
	|	ТаблицаСпискаНоменклатуры.Номенклатура,
	|	ВЫБОР
	|		КОГДА ТаблицаСпискаНоменклатуры.НомерИзделия = 0
	|			ТОГДА 0
	|		ИНАЧЕ 1
	|	КОНЕЦ КАК НомерИзделия,
	|	СУММА(ТаблицаСпискаНоменклатуры.Количество) КАК Количество,
	|	ТаблицаСпискаНоменклатуры.ЧерезСклад КАК ЧерезСклад,
	|	МИНИМУМ(ВЫБОР
	|			КОГДА ТаблицаСпискаНоменклатуры.Номенклатура = ТаблицаСпискаМатериаловЗаказчика.Номенклатура
	|				ТОГДА 0
	|			ИНАЧЕ ВЫБОР
	|					КОГДА ТаблицаСпискаНоменклатуры.Номенклатура.ВидНоменклатуры = ЗНАЧЕНИЕ(Перечисление.ВидыНоменклатуры.Материал)
	|							ИЛИ ТаблицаСпискаНоменклатуры.Номенклатура.ВидНоменклатуры = ЗНАЧЕНИЕ(Перечисление.ВидыНоменклатуры.Комплект)
	|						ТОГДА ЕСТЬNULL(РозничныеЦеныСрез.Розничная, 0) * &КоэффициентМатериалы
	|					ИНАЧЕ ЕСТЬNULL(РозничныеЦеныСрез.Розничная, 0) * &КоэффициентУслуги
	|				КОНЕЦ
	|		КОНЕЦ) КАК Цена,
	|	СУММА(ВЫБОР
	|			КОГДА ТаблицаСпискаНоменклатуры.Номенклатура = ТаблицаСпискаМатериаловЗаказчика.Номенклатура
	|				ТОГДА 0
	|			ИНАЧЕ ВЫБОР
	|					КОГДА ТаблицаСпискаНоменклатуры.Номенклатура.ВидНоменклатуры = ЗНАЧЕНИЕ(Перечисление.ВидыНоменклатуры.Материал)
	|							ИЛИ ТаблицаСпискаНоменклатуры.Номенклатура.ВидНоменклатуры = ЗНАЧЕНИЕ(Перечисление.ВидыНоменклатуры.Комплект)
	|						ТОГДА ЕСТЬNULL(РозничныеЦеныСрез.Розничная, 0) * &КоэффициентМатериалы * ТаблицаСпискаНоменклатуры.Количество
	|					ИНАЧЕ ЕСТЬNULL(РозничныеЦеныСрез.Розничная, 0) * &КоэффициентУслуги * ТаблицаСпискаНоменклатуры.Количество
	|				КОНЕЦ
	|		КОНЕЦ) КАК РозничнаяСтоимость,
	|	МИНИМУМ(ТаблицаСпискаНоменклатуры.ЕдиницаИзмерения) КАК ЕдиницаИзмерения,
	|	СУММА(ВЫБОР
	|			КОГДА ТаблицаСпискаНоменклатуры.Номенклатура = ТаблицаСпискаМатериаловЗаказчика.Номенклатура
	|				ТОГДА 0
	|			ИНАЧЕ ЕСТЬNULL(РозничныеЦеныСрез.Внутренняя, 0) * ТаблицаСпискаНоменклатуры.Количество
	|		КОНЕЦ) КАК ВнутренняяСтоимость,
	|	СУММА(ВЫБОР
	|			КОГДА ТаблицаСпискаНоменклатуры.Номенклатура.ВидНоменклатуры = ЗНАЧЕНИЕ(Перечисление.ВидыНоменклатуры.Услуга)
	|				ТОГДА ЕСТЬNULL(РозничныеЦеныСрез.ПлановаяЗакупочная, 0) * ТаблицаСпискаНоменклатуры.Количество
	|			ИНАЧЕ 0
	|		КОНЕЦ) КАК ЗарплатаЦеха,
	|	МАКСИМУМ(НоменклатураПодразделений.ПодЗаказ) КАК ПодЗаказ,
	|	ТаблицаСпискаМатериаловПодЗаказ.Поставщик,
	|	ТаблицаСпискаМатериаловПодЗаказ.Комментарий,
	|	ВЫБОР
	|		КОГДА ТаблицаСпискаНоменклатуры.Номенклатура.РезМаталлическогоПогонажа
	|			ТОГДА ТаблицаСпискаНоменклатуры.НомерСтроки
	|		ИНАЧЕ 0
	|	КОНЕЦ КАК РезМаталлическогоПогонажа,
	|	МАКСИМУМ(ТаблицаСпискаНоменклатуры.ПредоставитЗаказчик) КАК ПредоставитЗаказчик,
	|	СУММА(ВЫБОР
	|			КОГДА ТаблицаСпискаНоменклатуры.Номенклатура = ТаблицаСпискаМатериаловЗаказчика.Номенклатура
	|				ТОГДА 0
	|			ИНАЧЕ ВЫБОР
	|					КОГДА ТаблицаСпискаНоменклатуры.Номенклатура.ВидНоменклатуры = ЗНАЧЕНИЕ(Перечисление.ВидыНоменклатуры.Материал)
	|							ИЛИ ТаблицаСпискаНоменклатуры.Номенклатура.ВидНоменклатуры = ЗНАЧЕНИЕ(Перечисление.ВидыНоменклатуры.Комплект)
	|						ТОГДА ЕСТЬNULL(РозничныеЦеныСрез.Розничная, 0) * ТаблицаСпискаНоменклатуры.Количество
	|					ИНАЧЕ ЕСТЬNULL(РозничныеЦеныСрез.Розничная, 0) * ТаблицаСпискаНоменклатуры.Количество
	|				КОНЕЦ
	|		КОНЕЦ) КАК СуммаБезНаценкиОфиса
	|ИЗ
	|	ТаблицаСпискаНоменклатуры КАК ТаблицаСпискаНоменклатуры
	|		ЛЕВОЕ СОЕДИНЕНИЕ РегистрСведений.ЦеныНоменклатурыПоПодразделениям.СрезПоследних(
	|				&Период,
	|				Подразделение = &Подразделение
	|					И Номенклатура В
	|						(ВЫБРАТЬ
	|							ТаблицаСпискаНоменклатуры.Номенклатура
	|						ИЗ
	|							ТаблицаСпискаНоменклатуры КАК ТаблицаСпискаНоменклатуры)) КАК РозничныеЦеныСрез
	|		ПО ТаблицаСпискаНоменклатуры.Номенклатура = РозничныеЦеныСрез.Номенклатура
	|		ЛЕВОЕ СОЕДИНЕНИЕ ТаблицаСпискаМатериаловПодЗаказ КАК ТаблицаСпискаМатериаловПодЗаказ
	|		ПО ТаблицаСпискаНоменклатуры.Номенклатура = ТаблицаСпискаМатериаловПодЗаказ.Номенклатура
	|		ЛЕВОЕ СОЕДИНЕНИЕ РегистрСведений.НоменклатураПодразделений КАК НоменклатураПодразделений
	|		ПО ТаблицаСпискаНоменклатуры.Номенклатура = НоменклатураПодразделений.Номенклатура
	|		ЛЕВОЕ СОЕДИНЕНИЕ ТаблицаСпискаМатериаловЗаказчика КАК ТаблицаСпискаМатериаловЗаказчика
	|		ПО ТаблицаСпискаНоменклатуры.Номенклатура = ТаблицаСпискаМатериаловЗаказчика.Номенклатура
	|ГДЕ
	|	(НоменклатураПодразделений.Подразделение = &Подразделение
	|			ИЛИ НоменклатураПодразделений.Подразделение ЕСТЬ NULL )
	|
	|СГРУППИРОВАТЬ ПО
	|	ТаблицаСпискаНоменклатуры.Номенклатура,
	|	ТаблицаСпискаНоменклатуры.ЧерезСклад,
	|	ТаблицаСпискаМатериаловПодЗаказ.Поставщик,
	|	ТаблицаСпискаМатериаловПодЗаказ.Комментарий,
	|	ВЫБОР
	|		КОГДА ТаблицаСпискаНоменклатуры.Номенклатура.РезМаталлическогоПогонажа
	|			ТОГДА ТаблицаСпискаНоменклатуры.НомерСтроки
	|		ИНАЧЕ 0
	|	КОНЕЦ,
	|	ВЫБОР
	|		КОГДА ТаблицаСпискаНоменклатуры.НомерИзделия = 0
	|			ТОГДА 0
	|		ИНАЧЕ 1
	|	КОНЕЦ";
	
	Таблица = Запрос.Выполнить().Выгрузить();
	
	Если ТекущийОбъект.Срочный Тогда
		
		КоэффициентЗаСрочность = ТекущийОбъект.Подразделение.КоэффициентЗаСрочность;
		Если КоэффициентЗаСрочность = 0 Тогда
			КоэффициентЗаСрочность = 1;
		КонецЕсли;
		
		Структура = Документы.Спецификация.ПолучитьСтоимостьУслугБезВнешних(Таблица);
		
		НоваяСтрока = Таблица.Добавить();
		НоваяСтрока.Номенклатура = Справочники.Номенклатура.СрочностьЗаказа;
		НоваяСтрока.ЕдиницаИзмерения = НоваяСтрока.Номенклатура.ЕдиницаИзмерения;
		НоваяСтрока.Количество = 1;
		НоваяСтрока.ЗарплатаЦеха = Структура.ЗарплатаЦеха; 
		НоваяСтрока.РозничнаяСтоимость = Структура.РозничнаяСтоимость;
		НоваяСтрока.Цена = Структура.РозничнаяСтоимость * КоэффициентЗаСрочность;
		НоваяСтрока.ЧерезСклад = Ложь;
		
	КонецЕсли;
	
	ТекущийОбъект.СписокНоменклатуры.Загрузить(Таблица);
	
	ТаблицаПодЗаказ = Таблица.Скопировать(Новый Структура("ПодЗаказ", Истина));
	ТаблицаПодЗаказ.Свернуть("Номенклатура, Поставщик, Комментарий", "Количество");
	ТекущийОбъект.СписокМатериаловПодЗаказ.Загрузить(ТаблицаПодЗаказ);
	
	// { Васильев Александр Леонидович [27.02.2015]
	// Вот эта строка нахера нужна?
	//ТекущийОбъект.СписокМатериаловЗаказчика.Загрузить(СписокМатериаловЗаказчика);
	// } Васильев Александр Леонидович [27.02.2015]
	
КонецПроцедуры

#КонецОбласти

#Область ОбщегоНазначения

&НаСервере
Функция ОпределитьПлощадьЛиста(фНоменклатура)
	
	Запрос = Новый Запрос;
	Запрос.УстановитьПараметр("Ссылка", фНоменклатура);
	Запрос.Текст = 
	"ВЫБРАТЬ
	|	спрНоменклатура.Ссылка КАК Номенклатура,
	|	спрНоменклатура.ШиринаДетали КАК ШиринаДетали,
	|	спрНоменклатура.ДлинаДетали КАК ДлинаДетали,
	|	ЕСТЬNULL(оснНоменклатура.КоэффициентБазовых, 0) КАК КоэффициентБазовых
	|ИЗ
	|	Справочник.Номенклатура КАК спрНоменклатура
	|		ЛЕВОЕ СОЕДИНЕНИЕ Справочник.Номенклатура КАК оснНоменклатура
	|		ПО спрНоменклатура.Ссылка = оснНоменклатура.БазоваяНоменклатура
	|			И (оснНоменклатура.ОсновнаяПоСкладу)
	|ГДЕ
	|	спрНоменклатура.Ссылка = &Ссылка";
	
	РезультатЗапроса = Запрос.Выполнить();
	
	Если РезультатЗапроса.Пустой() Тогда
		Возврат 100500000000; // На всякий случай :)
	КонецЕсли;
	
	Выборка = РезультатЗапроса.Выбрать();
	Выборка.Следующий();
	Если Выборка.Количество() = 1 И ЗначениеЗаполнено(Выборка.КоэффициентБазовых) Тогда
		Площадь = Выборка.КоэффициентБазовых * 1000000; // Глупо получается, тут умножаем, дальше делим.
	Иначе
		Площадь = Выборка.ШиринаДетали * Выборка.ДлинаДетали; // Не нашли единственную основную. Перемножаем по старинке.
	КонецЕсли;
	
	Возврат Площадь;
	
КонецФункции

&НаСервереБезКонтекста
Функция ПолучитьДилерскуюСумма(СпецификацияСсылка)
	
	Возврат Документы.Спецификация.ПолучитьСуммаСДилерскимиНаценками(СпецификацияСсылка);
	
КонецФункции

&НаКлиенте
Процедура ПересчитатьСуммы()
	
	СтруктураСкидка = ЛексСервер.ПолучитьСкидкуДоговора(Объект.Подразделение, Объект.Дата, Объект.СуммаДокумента, ВидОплаты, Объект.Офис, Объект.Контрагент);
	ПроцентСкидки = СтруктураСкидка.РазмерСкидки;
	СуммаДокументаСоСкидкой = Объект.СуммаДокумента * (1 - ПроцентСкидки / 100);
	Элементы.СкидкаПостоянномуКлиенту.Заголовок = "Постоянному клиенту скидка + " + СтруктураСкидка.РазмерСкидкиПостоянногоКлиента + "%";
	Элементы.СкидкаПостоянномуКлиенту.Видимость = СтруктураСкидка.ЭтоПостоянныйКлиент;
	
	Если Объект.Дилерский Тогда
		фСуммаДокумента = ПолучитьДилерскуюСумма(Объект.Ссылка);
	Иначе
		фСуммаДокумента = Объект.СуммаДокумента;
	КонецЕсли;
	
КонецПроцедуры

&НаКлиенте
Функция ОбновитьСкидки()
	
	// { Васильев Александр Леонидович [27.08.2014]
	// Когда удалим реквизиты, убрать код.
	Объект.СкидкаНаУслуги = 0;
	Объект.СкидкаНаМатериалы = 0;
	// } Васильев Александр Леонидович [27.08.2014]
	
КонецФункции // ОбновитьСкидки()

&НаСервере
Функция ВыгрузитьНужнуюТаблицуВХранилище(ТабличнаяЧасть)
	
	Если ТипЗнч(ТабличнаяЧасть) = Тип("ДанныеФормыКоллекция") Тогда
		
		Адрес = ПоместитьВоВременноеХранилище(ТабличнаяЧасть.Выгрузить());
		Возврат Адрес;
		
	ИначеЕсли ТипЗнч(ТабличнаяЧасть) = Тип("Структура") Тогда
		
		Возврат ПоместитьВоВременноеХранилище(ТабличнаяЧасть);
		
	КонецЕсли;
	
КонецФункции 

&НаСервере
Процедура ЗагрузитьТабличнуюЧасть(АдресТаблицы, ИмяТабличнойЧасти)
	
	ТЗ_Структура = ПолучитьИзВременногоХранилища(АдресТаблицы);
	
	Если ТипЗнч(ТЗ_Структура) = Тип("ТаблицаЗначений") Тогда
		
		Модифицированность = Истина;
		Объект[ИмяТабличнойЧасти].Загрузить(ТЗ_Структура);
		
	ИначеЕсли ТипЗнч(ТЗ_Структура) = Тип("Структура") Тогда
		
		Если ТЗ_Структура.Свойство("Детали") И ТЗ_Структура.Свойство("Двери") Тогда
			
			Модифицированность = Истина;
			Объект[ИмяТабличнойЧасти].Загрузить(ТЗ_Структура.Детали);
			
			Объект.СписокДверей.Очистить();
			
			Если ЗначениеЗаполнено(ТЗ_Структура.Двери) Тогда
				
				СтрокаДверей = Объект.СписокДверей.Добавить();
				СтрокаДверей.Двери = ТЗ_Структура.Двери;
				СтрокаДверей.ПоКаталогу = Истина;
				
			КонецЕсли;
			
		ИначеЕсли ТЗ_Структура.Свойство("Редактор3д") Тогда
			
			Модифицированность = Истина;
			
			Если ТЗ_Структура.Свойство("Детали") Тогда
				
				Объект.СписокМатериалы.Загрузить(ТЗ_Структура.Детали);
				
			КонецЕсли;
			
			Если ТЗ_Структура.Свойство("Ящики") Тогда
				
				Объект.СписокЯщики.Загрузить(ТЗ_Структура.Ящики);
				
			КонецЕсли;
			
		КонецЕсли;
		
		//Если ТЗ_Структура.Свойство("ПодставляемыеЗначенияИзРеквизита") Тогда
		//
		//	СтруктураПодбираемойПоЦветуНоменклатуры.Вставить("ШкафПоКаталогу", ТЗ_Структура.ПодставляемыеЗначенияИзРеквизита);
		//
		//КонецЕсли;
		
	КонецЕсли;
	
КонецПроцедуры

&НаКлиенте
Функция ОткрытьФормуПодбора(ИмяПодбора, ТаблицаДляФормы, СтрокаДанных, ВладелецПодобра, ПараметрыПодбора = Неопределено)
	
	АдресТаблицы = ВыгрузитьНужнуюТаблицуВХранилище(ТаблицаДляФормы);
	
	Если ПараметрыПодбора = Неопределено ИЛИ ТипЗнч(ПараметрыПодбора) <> Тип("Структура") Тогда
		ПараметрыПодбора = Новый Структура;
	КонецЕсли;
	
	ПараметрыПодбора.Вставить("АдресТаблицы", АдресТаблицы);
	ПараметрыПодбора.Вставить("Подразделение", Объект.Подразделение);
	ПараметрыПодбора.Вставить("Изделие", Объект.Изделие);
	
	Если ЗначениеЗаполнено(Объект.Ссылка) Тогда
		
		ПараметрыПодбора.Вставить("Спецификация", Объект.Ссылка);
		
	КонецЕсли;
	
	Если СтрокаДанных <> Неопределено Тогда
		
		ПараметрыПодбора.Вставить("Идентификатор", СтрокаДанных.НомерСтроки - 1);
		
	КонецЕсли;
	
	ОткрытьФорму("Документ.Спецификация.Форма." + ИмяПодбора, ПараметрыПодбора, ВладелецПодобра);
	
КонецФункции

&НаКлиенте
Функция Собрать()
	
	ИмяТекущейСтраницы = Элементы.ГруппаСтраницы.ТекущаяСтраница.Имя;
	ПараметрыФормыПодбора = Новый Структура;
	ПараметрыФормыПодбора.Вставить("ТолькоПросмотр", ТолькоПросмотр);
	
	Если ИмяТекущейСтраницы = "СтраницаМатериалы" Тогда
		
		ИмяПодбора = "ФормаДетали";
		ТаблицаДляФормы = Объект.СписокМатериалы;
		СтрокаДанных = Элементы.СписокМатериалы.ТекущиеДанные;
		ВладелецПодобра = Элементы.СписокМатериалы;
		ПараметрыФормыПодбора.Вставить("Строка3DРедактор", Объект.Строка3DРедактор);
		ПараметрыФормыПодбора.ТолькоПросмотр = ПараметрыФормыПодбора.ТолькоПросмотр ИЛИ Элементы.СтраницаМатериалы.ТолькоПросмотр;
		
	ИначеЕсли ИмяТекущейСтраницы = "СтраницаЯщики" Тогда
		
		ИмяПодбора = "ФормаЯщики";
		ТаблицаДляФормы = Объект.СписокЯщики;
		СтрокаДанных = Элементы.СписокЯщики.ТекущиеДанные;
		ВладелецПодобра = Элементы.СписокЯщики;
		ПараметрыФормыПодбора.ТолькоПросмотр = ПараметрыФормыПодбора.ТолькоПросмотр ИЛИ Элементы.СтраницаЯщики.ТолькоПросмотр;
		
	ИначеЕсли ИмяТекущейСтраницы = "СтраницаИзделияПоКаталогу" Тогда
		
		ИмяПодбора = ПолучитьФормуИзделияПоКаталогу(Объект.Изделие); //"ФормаИзделийПоКаталогу";
		
		Если ИмяПодбора = "ФормаИзделийПоКаталогу" Тогда
			
			ТаблицаДляФормы = Объект.СписокИзделийПоКаталогу;
			
		ИначеЕсли ИмяПодбора = "ФормаШкафПоКаталогу" Тогда
			
			ЗаписатьПустуюСпецификацию();
			
			ТаблицаДляФормы = Новый Структура;
			ТаблицаДляФормы.Вставить("Детали", Объект.СписокИзделийПоКаталогу);
			ТаблицаДляФормы.Вставить("Двери", Неопределено);
			СтрокаДверей = Объект.СписокДверей.НайтиСтроки(Новый Структура("ПоКаталогу", Истина));
			
			Если СтрокаДверей.Количество() = 1 Тогда
				ТаблицаДляФормы.Вставить("Двери", СтрокаДверей[0].Двери);
			КонецЕсли;
			
			//при открытии формы, спец модифицированна даже если в форме ничего не поменяют
			//иначе есть вероятность не сохранить измененную дверь
			Модифицированность = НЕ ТолькоПросмотр;
			//_____________________________________
			
		КонецЕсли;
		
		СтрокаДанных = Элементы.СписокИзделийПоКаталогу.ТекущиеДанные;
		ВладелецПодобра = Элементы.СписокИзделийПоКаталогу;
		
	КонецЕсли;
	
	ОткрытьФормуПодбора(ИмяПодбора, ТаблицаДляФормы, СтрокаДанных, ВладелецПодобра, ПараметрыФормыПодбора);
	
КонецФункции // Собрать()

&НаСервереБезКонтекста
Функция ПолучитьФормуИзделияПоКаталогу(Изделие)
	
	Если Изделие.ВидИзделия = Перечисления.ВидыИзделий.ШкафКупе Тогда
		Форма = "ФормаШкафПоКаталогу";
	Иначе
		Форма = "ФормаИзделийПоКаталогу";
	КонецЕсли;
	
	Возврат Форма;
	
КонецФункции

&НаСервере
Функция ПолучитьАдресТаблицы()
	
	ТЗ = Новый ТаблицаЗначений;
	ТЗ.Колонки.Добавить("Номенклатура", Новый ОписаниеТипов("СправочникСсылка.Номенклатура"));
	ТЗ.Колонки.Добавить("Количество", Новый ОписаниеТипов("Число"));
	ТЗ.Колонки.Добавить("ДлинаДетали", Новый ОписаниеТипов("Число"));
	ТЗ.Колонки.Добавить("Дробный", Новый ОписаниеТипов("Булево"));
	
	Для каждого Строка Из Объект.Комплектация Цикл
		
		НоменклатурнаяГруппа = Строка.Номенклатура.НоменклатурнаяГруппа;
		Дробный = Строка.Номенклатура.ЕдиницаИзмерения.Дробный;
		
		Если НоменклатурнаяГруппа = Справочники.НоменклатурныеГруппы.СотовыеПолки 
			или НоменклатурнаяГруппа = Справочники.НоменклатурныеГруппы.Корзины 
			или НоменклатурнаяГруппа = Справочники.НоменклатурныеГруппы.СотовыеЭлементы Тогда
			
			Если Дробный Тогда
				
				НоваяСтрока = ТЗ.Добавить();
				НоваяСтрока.Номенклатура = Строка.Номенклатура;
				НоваяСтрока.Количество = 1;
				НоваяСтрока.ДлинаДетали = Строка.Количество * 1000;
				НоваяСтрока.Дробный = Дробный;
				
			Иначе
				
				НоваяСтрока = ТЗ.Добавить();
				НоваяСтрока.Номенклатура = Строка.Номенклатура;
				НоваяСтрока.Количество = Строка.Количество;
				НоваяСтрока.ДлинаДетали = 0;
				НоваяСтрока.Дробный = Дробный;
				
			КонецЕсли;
			
		КонецЕсли;
		
	КонецЦикла;
	ТЗ.Свернуть("Номенклатура, ДлинаДетали, Дробный", "Количество");
	Возврат ПоместитьВоВременноеХранилище(ТЗ);
	
КонецФункции // ПолучитьАдресТаблицы()

&НаСервере
Процедура ДобавитьКантПоМесту(НоваяСтрока, Номенклатура, Площадь, НомерИзделия)
	
	Если НЕ Номенклатура = Справочники.Номенклатура.ПустаяСсылка() Тогда
		
		НоваяСтрока.Номенклатура 			= Номенклатура;
		НоваяСтрока.ЕдиницаИзмерения 	= НоваяСтрока.Номенклатура.ЕдиницаИзмерения;
		НоваяСтрока.Количество 			= Площадь;
		НоваяСтрока.НомерИзделия 		= НомерИзделия;
		
	Иначе
		
		Сообщение 			= Новый СообщениеПользователю;
		Сообщение.Текст 	= "Не заполнена номенклатура канта, устанавлевоемого по месту";
		Сообщение.Сообщить();
		
	КонецЕсли;
	
КонецПроцедуры // ДобавитьКантПоМесту()

&НаСервере
Функция ДобавитьСтроку(ТекущийОбъект, Номенклатура, Площадь, НомерИзделия, Ошибки = Неопределено, ВидНоменклатуры = "", Таблица = Неопределено, НомерСтроки = 0, ОтказОшибки = Ложь)
	
	Поле = Неопределено;
	
	Если Таблица <> Неопределено Тогда
		Если Таблица = "СписокДверей" Тогда
			Поле = "Объект." + Таблица + "[" + (НомерСтроки - 1) + "].Двери";
		Иначе
			Поле = "Объект." + Таблица + "[" + (НомерСтроки - 1) + "].Номенклатура";
		КонецЕсли;
	КонецЕсли;
	
	Если ЗначениеЗаполнено(Номенклатура) Тогда
		
		Если Площадь > 0 Тогда
			
			Если Номенклатура.ВидНоменклатуры = Перечисления.ВидыНоменклатуры.Комплект Тогда
				
				Для Каждого СтрокаСостав Из Номенклатура.Состав Цикл
					ЗаполнитьСтрокуСписокНоменклатуры(ТекущийОбъект, СтрокаСостав.Номенклатура, СтрокаСостав.Количество * Площадь, НомерИзделия);	
				КонецЦикла;
				
			Иначе
				ЗаполнитьСтрокуСписокНоменклатуры(ТекущийОбъект, Номенклатура, Площадь, НомерИзделия);
			КонецЕсли;
			
		Иначе
			
			Если НЕ ОтказОшибки Тогда
				ОбщегоНазначенияКлиентСервер.ДобавитьОшибкуПользователю(Ошибки, Поле, "Не верно количество (площадь) " + ВидНоменклатуры);
			КонецЕсли;
			
		КонецЕсли;
		
	Иначе
		
		Если НЕ ОтказОшибки Тогда
			ОбщегоНазначенияКлиентСервер.ДобавитьОшибкуПользователю(Ошибки, Поле, "Не заполнена номенклатура " + ВидНоменклатуры);
		КонецЕсли;
		
	КонецЕсли;
	
КонецФункции // ДобавитьСтроку()

&НаСервере
Функция ЗаполнитьСтрокуСписокНоменклатуры(ТекущийОбъект, Номенклатура, Площадь, НомерИзделия)
	
	ТЗНоменклатуры = СписокНоменклатурыДляЗаполненияРеквизита.ТЗНоменклатуры;
	ПредоставляетЗаказчик = ТЗНоменклатуры.Найти(Номенклатура, "Номенклатура") <> Неопределено;
	
	НоваяСтрока = ТекущийОбъект.СписокНоменклатуры.Добавить();
	НоваяСтрока.Номенклатура = Номенклатура;
	НоваяСтрока.ЕдиницаИзмерения = НоваяСтрока.Номенклатура.ЕдиницаИзмерения;
	НоваяСтрока.Количество = Площадь;
	НоваяСтрока.ПредоставитЗаказчик = ПредоставляетЗаказчик;
	НоваяСтрока.НомерИзделия = НомерИзделия;
	НоваяСтрока.ЧерезСклад = НЕ Номенклатура.МестоОбработки = Перечисления.МестоОбработки.Цех;
	
КонецФункции

&НаСервере
Функция ВместимостьНаЛисте(Номенклатура, ВысотаДетали, ШиринаДетали, Ошибки = Неопределено, ВидНоменклатуры = "", Таблица = Неопределено, НомерСтроки = 0);
	
	Поле = Неопределено;
	
	Если Таблица <> Неопределено Тогда
		Если Таблица = "СписокДверей" Тогда	
			Поле = "Объект." + Таблица + "[" + (НомерСтроки - 1) + "].Двери";
		Иначе
			Поле = "Объект." + Таблица + "[" + (НомерСтроки - 1) + "].Номенклатура";
		КонецЕсли;
	КонецЕсли;
	
	ДлинаЛиста = Номенклатура.ДлинаДетали;
	ШиринаЛиста = Номенклатура.ШиринаДетали;
	НаличиеТекстуры = Номенклатура.НаличиеТекстуры;
	
	Если НаличиеТекстуры Тогда
		Если (ВысотаДетали > ДлинаЛиста ИЛИ ШиринаДетали > ШиринаЛиста) Тогда	
			ОбщегоНазначенияКлиентСервер.ДобавитьОшибкуПользователю(Ошибки, Поле, "Большие размеры номенклатуры " + ВидНоменклатуры);
		КонецЕсли;
	Иначе
		Если (ВысотаДетали > ДлинаЛиста ИЛИ ШиринаДетали > ШиринаЛиста) И (ВысотаДетали > ШиринаЛиста ИЛИ ШиринаДетали > ДлинаЛиста) Тогда
			ОбщегоНазначенияКлиентСервер.ДобавитьОшибкуПользователю(Ошибки, Поле, "Большие размеры номенклатуры " + ВидНоменклатуры);
		КонецЕсли;	
	КонецЕсли;
	
КонецФункции

&НаСервереБезКонтекста
Функция ПолучитьУслугуКромления(НоменклатураМебельнаяКромка)
	
	НоменклатурныеГруппы = Справочники.НоменклатурныеГруппы;
	ГруппаКромки = НоменклатураМебельнаяКромка.НоменклатурнаяГруппа;
	
	Если ГруппаКромки = НоменклатурныеГруппы.Кромка2_42 или ГруппаКромки = НоменклатурныеГруппы.Кромка2_45 Тогда
		Услуга = Справочники.Номенклатура.КромлениеСтолешницыПристенка;
	ИначеЕсли ГруппаКромки = НоменклатурныеГруппы.КантАлюминиевый Тогда
		Услуга = Справочники.Номенклатура.ОкантовкаАлюминием;
	ИначеЕсли ГруппаКромки = НоменклатурныеГруппы.КантТ
		ИЛИ ГруппаКромки = НоменклатурныеГруппы.КантП Тогда
		Услуга = Справочники.Номенклатура.Окантовка;
	ИначеЕсли ГруппаКромки = НоменклатурныеГруппы.ТорцеваяРучка16мм или ГруппаКромки = НоменклатурныеГруппы.ТорцеваяРучка18мм Тогда
		Услуга = Справочники.Номенклатура.НаклейкаТорцевойРучки;
	Иначе
		Если НоменклатураМебельнаяКромка.ГлубинаДетали < 1 Тогда
			Услуга = Справочники.Номенклатура.КромлениеТонкойКромки;
		Иначе
			Услуга = Справочники.Номенклатура.КромлениеТолстойКромки;
		КонецЕсли;
	КонецЕсли;
	
	Возврат Услуга;
	
КонецФункции

&НаСервере
Функция РазложитьСтроку(Строка, Разделитель)
	
	Возврат  СтроковыеФункцииКлиентСервер.РазложитьСтрокуВМассивПодстрок(Строка, Разделитель);
	
КонецФункции

&НаСервере
Функция СобратьМассив(Массив, Разделитель)
	
	Возврат  СтроковыеФункцииКлиентСервер.ПолучитьСтрокуИзМассиваПодстрок(Массив, Разделитель);
	
КонецФункции

&НаСервере
Функция ПолучитьКромкуДляФлэшПоКаталогу(Кромка)
	
	Стр = Новый Структура;
	Стр.Вставить("Наименование", Кромка.КраткоеНаименование);
	Стр.Вставить("Код", Кромка.Код);
	
	Возврат Стр;
	
КонецФункции

&НаСервере
Процедура МасштабироватьИЗаполнитьПараметрыРедактированнойДетали(СтрокаФлэш, СтрокаТаблицы, СтрКромка)
	
	СтрокаТаблицы.ДетальРедактированная = Истина;
	
	МассивСимволов = РазложитьСтроку(СтрокаФлэш, "☻");
	СтрокаТаблицы.ДлинаКривогоПила = МассивСимволов[1];
	СтрокаТаблицы.Периметр = Число(МассивСимволов[0]); 
	
	Если НЕ МассивСимволов[2] = "0" Тогда
		СтрокаТаблицы.КривойПилСверху = 1;
	Иначе
		СтрокаТаблицы.КривойПилСверху = 0;
	КонецЕсли;
	
	Если НЕ МассивСимволов[3] = "0" Тогда
		СтрокаТаблицы.КривойПилСнизу = 1;
	Иначе
		СтрокаТаблицы.КривойПилСнизу = 0;
	КонецЕсли;
	
	Если НЕ МассивСимволов[4] = "0" Тогда
		СтрокаТаблицы.КривойПилСлева = 1;
	Иначе
		СтрокаТаблицы.КривойПилСлева = 0;
	КонецЕсли;
	
	Если НЕ МассивСимволов[5] = "0" Тогда
		СтрокаТаблицы.КривойПилСправа = 1;
	Иначе
		СтрокаТаблицы.КривойПилСправа = 0;
	КонецЕсли;
	
	Если Найти(ВРег(СтрокаТаблицы.Комментарий), "ЧЕРТЕЖ") = 0 Тогда
		СтрокаТаблицы.Комментарий = "[По чертежу] " + СтрокаТаблицы.Комментарий;
	КонецЕсли;
	
	СтруктураКромка = ПолучитьКромкуДляФлэшПоКаталогу(СтрКромка.Кромка);
	
	// Замена кромки
	
	СтрокаКромка = Лев(МассивСимволов[9], СтрДлина(МассивСимволов[9]) - 1);
	
	Если ЗначениеЗаполнено(СтрокаКромка) Тогда
		
		МассивКромок = РазложитьСтроку(СтрокаКромка,"|");
		Сч = 0;
		
		Пока Сч < МассивКромок.Количество() Цикл
			
			КромМассив = РазложитьСтроку(МассивКромок[Сч], "_");
			КромМассив[0] = СтруктураКромка.Код;
			Кром = СобратьМассив(КромМассив,"_");
			МассивКромок[Сч] = Кром;
			Сч = Сч + 1;
			
		КонецЦикла;
		
		СтрокаКромка = СобратьМассив(МассивКромок,"|");
		
		СтрокаТаблицы.КантыИзРедактора = ЗначениеВСтрокуВнутр(СтрокаКромка);
		
	КонецЕсли;
	
	// Масштабирование
	
	НовРазмерY = Число(СтрокаТаблицы.ВысотаДетали);
	НовРазмерX = Число(СтрокаТаблицы.ШиринаДетали);
	
	СтрокаДляМасштабирования = МассивСимволов[8];
	
	Мас = РазложитьСтроку(СтрокаДляМасштабирования, "^");
	
	МассивЭлементов = РазложитьСтроку(Мас[1],"#");
	
	Размеры = РазложитьСтроку(Мас[0], "_");
	
	РазмерY = Число(Размеры[0])*2;
	РазмерX = Число(Размеры[1])*2;
	
	ScaleX = НовРазмерX/РазмерX;
	ScaleY = НовРазмерY/РазмерY;		
	
	
	Размеры[0] = Формат(Число(НовРазмерY/2),"ЧДЦ=1; ЧРД=.; ЧГ=");
	Размеры[1] = Формат(Число(НовРазмерX/2),"ЧДЦ=1; ЧРД=.; ЧГ=");
	
	Мас[0] = СобратьМассив(Размеры,"_");
	
	
	МассивТочек = РазложитьСтроку(МассивЭлементов[0], "*");
	МассивЛиний = РазложитьСтроку(МассивЭлементов[1], "*");
	
	Сч = 0;
	Для каждого Точка Из МассивТочек Цикл
		Если Точка <> "" Тогда
			Координаты = РазложитьСтроку(Точка, "_");
			Координаты[0] = Формат(Окр(Число(Координаты[0])*ScaleX,2),"ЧДЦ=2; ЧРД=.; ЧГ=");
			Координаты[1] = Формат(Окр(Число(Координаты[1])*ScaleY,2),"ЧДЦ=2; ЧРД=.; ЧГ=");
			Точка = СобратьМассив(Координаты,"_");
			МассивТочек[Сч] = Точка;
		КонецЕсли;
		Сч=Сч+1;
	КонецЦикла;
	
	МассивЭлементов[0] = СобратьМассив(МассивТочек,"*");
	
	Сч = 0;
	Для каждого Линия Из МассивЛиний Цикл
		Если Линия <> "" Тогда
			Линия = РазложитьСтроку(Линия, "_");
			
			Если Число(Линия[0]) = 0 Тогда // прямая
				
				Если НЕ (Линия[3] = "") Тогда
					Линия[3] = СтруктураКромка.Наименование;
					Линия[4] = СтруктураКромка.Код;
				КонецЕсли;
				
			КонецЕсли;
			
			Если Число(Линия[0]) = 1 Тогда // безье
				
				Если НЕ (Линия[7] = "") Тогда
					Линия[7] = СтруктураКромка.Наименование;
					Линия[8] = СтруктураКромка.Код;
				КонецЕсли;
				
				Линия[3] = Формат(Окр(Число(Линия[3])*ScaleX,2),"ЧДЦ=2; ЧРД=.; ЧГ=");
				Линия[4] = Формат(Окр(Число(Линия[4])*ScaleY,2),"ЧДЦ=2; ЧРД=.; ЧГ=");
				Линия[5] = Формат(Окр(Число(Линия[5])*ScaleX,2),"ЧДЦ=2; ЧРД=.; ЧГ=");
				Линия[6] = Формат(Окр(Число(Линия[6])*ScaleY,2),"ЧДЦ=2; ЧРД=.; ЧГ=");
			КонецЕсли;
			
			Если Число(Линия[0]) = 2 Тогда // дуга
				
				Если НЕ (Линия[5] = "") Тогда
					Линия[5] = СтруктураКромка.Наименование;
					Линия[6] = СтруктураКромка.Код;
				КонецЕсли;
				
				Линия[3] = Формат(Окр(Число(Линия[3])*ScaleX,2),"ЧДЦ=2; ЧРД=.; ЧГ=");
				Линия[4] = Формат(Окр(Число(Линия[4])*ScaleY,2),"ЧДЦ=2; ЧРД=.; ЧГ=");
			КонецЕсли;
			
			Линия = СобратьМассив(Линия,"_");
			МассивЛиний[Сч] = Линия;
		КонецЕсли;
		Сч=Сч+1;
	КонецЦикла;
	
	МассивЭлементов[1] = СобратьМассив(МассивЛиний,"*");
	Мас[1] = СобратьМассив(МассивЭлементов,"#");
	СтрокаДляФлэш = СобратьМассив(Мас,"^");
	
	СтрокаТаблицы.СтрокаДляФлэш = СтрокаДляФлэш;
	
КонецПроцедуры

&НаСервере
Процедура ОбработкаИзделийПоКаталогу()
	
	//Определим вид изделия
	ИзделиеШкафКупе = Объект.Изделие.ВидИзделия = Перечисления.ВидыИзделий.ШкафКупе;
	КорпусныйШкафКупе = ИзделиеШкафКупе И Объект.Изделие = Справочники.Изделия.КорпусныйШкафКупеПоКаталогу;
	ИзделиеКухня = НЕ ИзделиеШкафКупе;			
	ВсеФормулы = НайтиВсеФормулы();
	ПрофильДвери = Неопределено;
	
	//Пока переменные для всех, чтоб небыло ошибок в формулах
	Раздвижная = Истина;	
	Распашная = Ложь;
	ВысотаПроема = 1;
	ШиринаПроема = 1;
	ВысотаПол = 1;
	ШиринаЛевый = 1;
	ШиринаПравый = 1;	
	ВысотаПотолок = 1;
	ВысотаПолИтог = 1;
	ШиринаЛевыйИтог = 1;
	ШиринаПравыйИтог = 1;	
	ПрипускСверху = 1;
	ПрипускСнизу = 1;
	ПрипускСлева = 1;
	ПрипускСправа = 1;
	ЗавалПол = 1;
	ЗавалЛевый = 1;
	ЗавалПравый = 1;
	ЗавалПотолок = 1;
	ЗавалСтенка = 1;
	Отсек1 = 0;
	Отсек2 = 0;
	Отсек3 = 0;
	Отсек4 = 0;
	Отсек5 = 0;
	Отсек6 = 0;
	РадиусЛ = 0;
	РадиусП = 0;
	КрышаЛ = 0;
	КрышаП = 0;
	
	ТаблицаИзделийПоКаталогу = Объект.СписокИзделийПоКаталогу.Выгрузить();
	
	Если ИзделиеШкафКупе Тогда 
		
		СписокДверей = Объект.СписокДверей;
		СтрокаПол = ТаблицаИзделийПоКаталогу.Найти(Справочники.ВидыИзделийПоКаталогу.Пол,"ВидИзделия");
		СтрокаЛевыйЭлемент = ТаблицаИзделийПоКаталогу.Найти(Справочники.ВидыИзделийПоКаталогу.ЛевыйБоковойЭлемент,"ВидИзделия");
		СтрокаПравыйЭлемент = ТаблицаИзделийПоКаталогу.Найти(Справочники.ВидыИзделийПоКаталогу.ПравыйБоковойЭлемент,"ВидИзделия");
		СтрокаПотолок = ТаблицаИзделийПоКаталогу.Найти(Справочники.ВидыИзделийПоКаталогу.Потолок,"ВидИзделия");
		СтрокаОсновной = ТаблицаИзделийПоКаталогу.Найти(Справочники.ВидыИзделийПоКаталогу.ОсновнойЭлемент,"ВидИзделия");
		
		ПолНеВлияет = СтрокаПол.Изделие.НеВлияетНаОсновной;
		ЛевыйНеВлияет = СтрокаЛевыйЭлемент.Изделие.НеВлияетНаОсновной;
		ПравыйНеВлияет = СтрокаПравыйЭлемент.Изделие.НеВлияетНаОсновной;
		ПотолокНеВлияет = СтрокаПотолок.Изделие.НеВлияетНаОсновной; 
		
		//определим переменные дверей 
		Если СписокДверей.Количество() = 1 Тогда
			НашаДверь = СписокДверей[0].Двери;
			ВысотаПроема = НашаДверь.ВысотаПроема;
			ШиринаПроема = НашаДверь.ШиринаПроема;
			Раздвижная = НашаДверь.ВидДвери = Перечисления.ВидыДверей.Раздвижная;	
			Распашная = НЕ Раздвижная;
			ПрофильДвери = НашаДверь.Профиль;
		Иначе
			ВысотаПроема = СтрокаОсновной.ВысотаИзделия - ?(ПолНеВлияет, СтрокаПол.ВысотаИзделия, 0) - ?(ПотолокНеВлияет, СтрокаПотолок.ВысотаИзделия, 0);
			ШиринаПроема = СтрокаОсновной.ШиринаИзделия - ?(ЛевыйНеВлияет, СтрокаЛевыйЭлемент.ШиринаИзделия, 0) - ?(ПравыйНеВлияет, СтрокаПравыйЭлемент.ШиринаИзделия, 0);			
		КонецЕсли;
		
		ВысотаПол = ?(ПолНеВлияет, СтрокаПол.ВысотаИзделия, 0);
		ШиринаЛевый = ?(ЛевыйНеВлияет, СтрокаЛевыйЭлемент.ШиринаИзделия, 0);
		ШиринаПравый = ?(ПравыйНеВлияет, СтрокаПравыйЭлемент.ШиринаИзделия, 0);
		ВысотаПотолок = ?(ПотолокНеВлияет, СтрокаПотолок.ВысотаИзделия, 0);
		
		ВысотаПолИтог = СтрокаПол.ВысотаИзделия;
		ШиринаЛевыйИтог = СтрокаЛевыйЭлемент.ШиринаИзделия;
		ШиринаПравыйИтог = СтрокаПравыйЭлемент.ШиринаИзделия;
		
		РадиусЛ = СтрокаЛевыйЭлемент.Изделие.РадиусЭлемента;
		РадиусП = СтрокаПравыйЭлемент.Изделие.РадиусЭлемента;
		
		КрышаЛ = СтрокаЛевыйЭлемент.Изделие.ШиринаКрыши;
		КрышаП = СтрокаПравыйЭлемент.Изделие.ШиринаКрыши;
		
		Если НЕ КорпусныйШкафКупе Тогда
			//Если рассчитываем шкаф купе не корпусный, определим завалы
			СтруктураЗавалов = Новый Структура;
			
			СтруктураЗавалов.Вставить("ЗавалПол", Число(СтрокаПол.Завал));
			СтруктураЗавалов.Вставить("ЗавалЛевый", Число(СтрокаЛевыйЭлемент.Завал));
			СтруктураЗавалов.Вставить("ЗавалПравый", Число(СтрокаПравыйЭлемент.Завал));
			СтруктураЗавалов.Вставить("ЗавалПотолок", Число(СтрокаПотолок.Завал));
			СтруктураЗавалов.Вставить("ЗавалСтенка", Число(СтрокаОсновной.Завал));
			
			СтруктураСтен = Новый Структура;
			
			СтруктураСтен.Вставить("ГипсСлева", СтрокаЛевыйЭлемент.ВидСтены = "Гипс");
			СтруктураСтен.Вставить("ГипсСправа", СтрокаПравыйЭлемент.ВидСтены = "Гипс");
			СтруктураСтен.Вставить("ГипсПотолок", СтрокаПотолок.ВидСтены = "Гипс");
			СтруктураСтен.Вставить("ГипсЗадняяСтенка", СтрокаОсновной.ВидСтены = "Гипс");
			СтруктураСтен.Вставить("НатяжнойПотолок", СтрокаПотолок.ВидСтены = "Натяжной");
			СтруктураСтен.Вставить("ЛаминатПол", СтрокаПол.ВидСтены = "Ламинат");
			
		КонецЕсли;
		
		СписокОтсеков = СтрокаОсновной.Изделие.СписокОтсеков;
		
		Если СписокОтсеков.Количество() > 0 Тогда
			
			Для Каждого Отсек Из СписокОтсеков Цикл
				
				Если Отсек.НомерСтроки = 1 Тогда
					Попытка
						Выполнить("Отсек1 = " + Отсек.КоэффициентОтсека);
					Исключение
						Текст = "Ошибка при формировании формул из справочника. Отсек1";
						ОбщегоНазначенияКлиентСервер.СообщитьПользователю(Текст);
					КонецПопытки;
				ИначеЕсли Отсек.НомерСтроки = 2 Тогда
					Попытка
						Выполнить("Отсек2 = " + Отсек.КоэффициентОтсека);
					Исключение
						Текст = "Ошибка при формировании формул из справочника. Отсек2";
						ОбщегоНазначенияКлиентСервер.СообщитьПользователю(Текст);
					КонецПопытки;
				ИначеЕсли Отсек.НомерСтроки = 3 Тогда
					Попытка
						Выполнить("Отсек3 = " + Отсек.КоэффициентОтсека);
					Исключение
						Текст = "Ошибка при формировании формул из справочника. Отсек3";
						ОбщегоНазначенияКлиентСервер.СообщитьПользователю(Текст);
					КонецПопытки;
				ИначеЕсли Отсек.НомерСтроки = 4 Тогда
					Попытка
						Выполнить("Отсек4 = " + Отсек.КоэффициентОтсека);
					Исключение
						Текст = "Ошибка при формировании формул из справочника. Отсек4";
						ОбщегоНазначенияКлиентСервер.СообщитьПользователю(Текст);
					КонецПопытки;
				ИначеЕсли Отсек.НомерСтроки = 5 Тогда
					Попытка
						Выполнить("Отсек5 = " + Отсек.КоэффициентОтсека);
					Исключение
						Текст = "Ошибка при формировании формул из справочника. Отсек5";
						ОбщегоНазначенияКлиентСервер.СообщитьПользователю(Текст);
					КонецПопытки;
				ИначеЕсли Отсек.НомерСтроки = 6 Тогда
					Попытка
						Выполнить("Отсек6 = " + Отсек.КоэффициентОтсека);
					Исключение
						Текст = "Ошибка при формировании формул из справочника. Отсек6";
						ОбщегоНазначенияКлиентСервер.СообщитьПользователю(Текст);
					КонецПопытки;
				КонецЕсли;
				
			КонецЦикла;
			
		КонецЕсли;
		
	КонецЕсли;
	
	Для Каждого Элемент Из ТаблицаИзделийПоКаталогу Цикл
		
		НашеИзделие = Элемент.Изделие;
		СтруктураПодбираемойПоЦветуНоменклатуры = ЛексСервер.ПолучитьСтруктуруПодставляемойНоменклатурыПоЦветуЛДСП(Элемент.НоменклатураЛДСП, Объект.Подразделение);
		
		Если ЗначениеЗаполнено(ПрофильДвери) Тогда
			СтруктураПодбираемойПоЦветуНоменклатурыКПрофилю = ЛексСервер.ПолучитьСтруктуруПодставляемойНоменклатурыПоЦветуЛДСП(ПрофильДвери, Объект.Подразделение);
		КонецЕсли;
		
		//Размеры изделия
		ШиринаИзделия = Элемент.ШиринаИзделия;
		ВысотаИзделия = Элемент.ВысотаИзделия;
		ГлубинаИзделия = Элемент.ГлубинаИзделия;
		Европаз = Элемент.Европаз;
		Столешница = Элемент.Столешница;
		ГлубинаМатериала = Элемент.НоменклатураЛДСП.ГлубинаДетали;
		ГлубинаМатериалаДоп = Элемент.НоменклатураЛДСПДоп.ГлубинаДетали;
		
		Если ИзделиеШкафКупе И НЕ КорпусныйШкафКупе Тогда   
			
			//Припуски, все равны одному припуску указанному в Каталоге изделия 
			//Припуски у ОсновногоЭлемента зависят от наличия других элементов с разных сторон
			
			Припуск = НашеИзделие.Припуск;
			
			ПрипускСверху = ?(Найти(Элемент.СтрокаПрипусков, "ПрипускСверху") <> 0, Припуск, 0);
			ПрипускСнизу = ?(Найти(Элемент.СтрокаПрипусков, "ПрипускСнизу") <> 0, Припуск, 0);
			ПрипускСлева = ?(Найти(Элемент.СтрокаПрипусков, "ПрипускСлева") <> 0, Припуск, 0);
			ПрипускСправа = ?(Найти(Элемент.СтрокаПрипусков, "ПрипускСправа") <> 0, Припуск, 0);
			
			ЗавалПол = ?(Найти(Элемент.СтрокаЗавалов, "ЗавалПол") <> 0, СтруктураЗавалов.ЗавалПол, 0);
			ЗавалЛевый = ?(Найти(Элемент.СтрокаЗавалов, "ЗавалЛевый") <> 0, СтруктураЗавалов.ЗавалЛевый, 0);
			ЗавалПравый = ?(Найти(Элемент.СтрокаЗавалов, "ЗавалПравый") <> 0, СтруктураЗавалов.ЗавалПравый, 0);
			ЗавалПотолок = ?(Найти(Элемент.СтрокаЗавалов, "ЗавалПотолок") <> 0, СтруктураЗавалов.ЗавалПотолок, 0);
			ЗавалСтенка = ?(Найти(Элемент.СтрокаЗавалов, "ЗавалСтенка") <> 0, СтруктураЗавалов.ЗавалСтенка, 0);
			
			ГипсСлева = СтруктураСтен.ГипсСлева; 
			ГипсСправа = СтруктураСтен.ГипсСправа; 
			ГипсПотолок = СтруктураСтен.ГипсПотолок;
			ГипсЗадняяСтенка = СтруктураСтен.ГипсЗадняяСтенка;
			НатяжнойПотолок = СтруктураСтен.НатяжнойПотолок;
			ЛаминатПол = СтруктураСтен.ЛаминатПол;
			
		КонецЕсли;
		
		//Расчет формул сосправочника
		Если ВсеФормулы.Количество() > 0 Тогда
			
			Фор = Новый Структура;
			
			Для Каждого ЭлементФормулы Из ВсеФормулы Цикл
				
				ЗначениФормулы = 0;
				
				Попытка
					Выполнить("ЗначениФормулы = " + ЭлементФормулы.Значение);
				Исключение
					Текст = "Ошибка при формировании формул из справочника. Наименование формулы - " + ЭлементФормулы.Ключ;
					ОбщегоНазначенияКлиентСервер.СообщитьПользователю(Текст);
				КонецПопытки;
				
				Фор.Вставить(ЭлементФормулы.Ключ, ЗначениФормулы);
				
			КонецЦикла;
			
		КонецЕсли;
		///////////////////////////////////////////////Список Номенклатуры////////////////////////////////////////////////////////////////////////
		//Список номенклатуры Каталога изделий в ТЧ Комплектация
		
		НоменклатураМатериала = Справочники.Номенклатура.ПустаяСсылка();
		
		# Область ДобавлениеКомплектацииИДопЭлементов
		СписокНоменклатурыИзделия = НашеИзделие.СписокНоменклатуры;
		Для Каждого Строка Из СписокНоменклатурыИзделия Цикл
			
			Количество = 0;
			Попытка
				Выполнить("Количество = " + Строка.Количество);
				
				Если Количество = 0 Тогда
					Продолжить;
				КонецЕсли;
				
				Если ТипЗнч(Строка.Номенклатура) = Тип("СправочникСсылка.Номенклатура") Тогда
					
					Номенклатура = Строка.Номенклатура;
					НоменклатурнаяГруппа = Номенклатура.НоменклатурнаяГруппа;
					
					Если НоменклатурнаяГруппа = Справочники.НоменклатурныеГруппы.МонтажныйУголок и ЗначениеЗаполнено(СтруктураПодбираемойПоЦветуНоменклатуры) Тогда
						
						Номенклатура = ?(ЗначениеЗаполнено(СтруктураПодбираемойПоЦветуНоменклатуры.ФурнитураКрепежная), СтруктураПодбираемойПоЦветуНоменклатуры.ФурнитураКрепежная, Номенклатура);
						
					ИначеЕсли НоменклатурнаяГруппа = Справочники.НоменклатурныеГруппы.Заглушка и ЗначениеЗаполнено(СтруктураПодбираемойПоЦветуНоменклатуры) Тогда
						
						Номенклатура = ?(ЗначениеЗаполнено(СтруктураПодбираемойПоЦветуНоменклатуры.Фурнитура), СтруктураПодбираемойПоЦветуНоменклатуры.Фурнитура, Номенклатура);
						
					КонецЕсли;
					
				ИначеЕсли ТипЗнч(Строка.Номенклатура) = Тип("СправочникСсылка.НоменклатурныеГруппы") Тогда
					
					Если Строка.Номенклатура = Справочники.НоменклатурныеГруппы.КухонныеНожки Тогда
						
						Номенклатура = Элемент.Ножки;
						
						Если ЗначениеЗаполнено(Номенклатура.ДополнительныйЭлемент) Тогда
							
							//Если ножки идут с доп элементом делим их пропорционально
							КоличествоДоп = Цел(Количество / 2);
							Количество = Количество - КоличествоДоп;
							//______________________________________
							ДобавитьКомплектацию(Номенклатура.ДополнительныйЭлемент, КоличествоДоп, Элемент.НомерСтроки);
							
						КонецЕсли;
						
					ИначеЕсли Строка.Номенклатура = Справочники.НоменклатурныеГруппы.Крючок Тогда	
						
						Номенклатура = Элемент.Крючки;
						
					ИначеЕсли Строка.Номенклатура = Справочники.НоменклатурныеГруппы.Профиль_П_образный Тогда	
						
						Если НЕ ЗначениеЗаполнено(ПрофильДвери) Тогда
							Продолжить;
						КонецЕсли;
						
						НоменклатурнаяГруппаСтрока = Справочники.НоменклатурныеГруппы.ПолучитьИмяПредопределенного(Строка.Номенклатура); 
						Номенклатура = ?(ЗначениеЗаполнено(СтруктураПодбираемойПоЦветуНоменклатурыКПрофилю[НоменклатурнаяГруппаСтрока]),
						СтруктураПодбираемойПоЦветуНоменклатурыКПрофилю[НоменклатурнаяГруппаСтрока], 
						?(ЗначениеЗаполнено(Строка.Номенклатура.ОсновнаяНоменклатура),
						Строка.Номенклатура.ОсновнаяНоменклатура,
						Неопределено));
						
					ИначеЕсли Строка.Номенклатура.ПринадлежитЭлементу(Справочники.НоменклатурныеГруппы.Саморезы) Тогда	
						
						Если НЕ ЗначениеЗаполнено(ПрофильДвери) Тогда
							Продолжить;
						КонецЕсли;
						
						НоменклатурнаяГруппаСтрока = Справочники.НоменклатурныеГруппы.ПолучитьИмяПредопределенного(Строка.Номенклатура); 
						Номенклатура = ?(ЗначениеЗаполнено(СтруктураПодбираемойПоЦветуНоменклатурыКПрофилю[НоменклатурнаяГруппаСтрока]),
						СтруктураПодбираемойПоЦветуНоменклатурыКПрофилю[НоменклатурнаяГруппаСтрока], 
						?(ЗначениеЗаполнено(Строка.Номенклатура.ОсновнаяНоменклатура),
						Строка.Номенклатура.ОсновнаяНоменклатура,
						Неопределено));
						
					Иначе
						
						НоменклатурнаяГруппаСтрока = Справочники.НоменклатурныеГруппы.ПолучитьИмяПредопределенного(Строка.Номенклатура); 
						Номенклатура = ?(ЗначениеЗаполнено(СтруктураПодбираемойПоЦветуНоменклатуры[НоменклатурнаяГруппаСтрока]), СтруктураПодбираемойПоЦветуНоменклатуры[НоменклатурнаяГруппаСтрока], Неопределено);
						
					КонецЕсли;
					
				КонецЕсли;
				
				ДобавитьКомплектацию(Номенклатура, Количество, Элемент.НомерСтроки);
				
			Исключение
				Текст = "Ошибка при формировании формул списка номенклатуры каталога изделий " + Элемент.Изделие;
				ОбщегоНазначенияКлиентСервер.СообщитьПользователю(Текст);
			КонецПопытки;
			
		КонецЦикла;
		
		Если ЗначениеЗаполнено(Элемент.Мойка) Тогда
			ДобавитьКомплектацию(Элемент.Мойка, 1, Элемент.НомерСтроки);
		КонецЕсли;
		
		Если ЗначениеЗаполнено(Элемент.Сушка) Тогда
			ДобавитьКомплектацию(Элемент.Сушка, 1, Элемент.НомерСтроки);
		КонецЕсли;
		
		#КонецОбласти
		
		Если ЗначениеЗаполнено(Элемент.СтрокаТаблицаФасадов) Тогда
			ПараметрыТаблицаФасадов = ЗначениеИзСтрокиВнутр(Элемент.СтрокаТаблицаФасадов);
		КонецЕсли;
		
		///////////////////////////////////////////////////////////////////Материалы//////////////////////////////////////////////////////////////////////////////////////
		
		# Область ДобавлениеМатериалов
		
		СписокМатериалыИзделия = НашеИзделие.СписокМатериалы;
		
		Для Каждого Строка Из СписокМатериалыИзделия Цикл
			
			ЭтоФасад = Ложь;
			
			Если ЗначениеЗаполнено(Элемент.СтрокаТаблицаФасадов) Тогда
				СтрокаФасада = ПараметрыТаблицаФасадов.Найти(Строка.НомерСтроки, "НомерДетали");
				Если ЗначениеЗаполнено(СтрокаФасада) Тогда
					Если СтрокаФасада.ВидЭлемента = "Фасад" Тогда
						Материал = СтрокаФасада.ВидФасада;
						НоменклатураФасад = СтрокаФасада.НоменклатураФасада;
						Кромка = СтрокаФасада.ОбрамлениеФасада;
						РучкаФасада = СтрокаФасада.НоменклатураРучки;
						Петли = СтрокаФасада.Петли;
						КоличествоПетель = СтрокаФасада.КоличествоПетель;
						
						РасположениеПазовИРучкиНаФасадах = СтрокаФасада.РасположениеПазовИРучкиНаФасадах;
						
						Если Элемент.Расположение = Перечисления.ВидыПрисоединенныхФайлов.КартинкаПравая Тогда
							
							РасположениеПазовИРучкиНаФасадах = РасположениеПазовИРучкиНаФасадах.ЗеркальноеПоложение;
							
						КонецЕсли;
						
						Если СтрокаФасада.ПовернутьФасад Тогда
							
							РасположениеПазовИРучкиНаФасадах = РасположениеПазовИРучкиНаФасадах.ПоворотВправо;
							
						КонецЕсли;
						
						ЭтоФасад = Истина;
						
						Если ЗначениеЗаполнено(СтрокаФасада.МеханизмФасада) Тогда
							ДобавитьКомплектацию(СтрокаФасада.МеханизмФасада, СтрокаФасада.КоличествоМеханизмФасада, Элемент.НомерСтроки);
						КонецЕсли;
						
						Если ЗначениеЗаполнено(СтрокаФасада.Демпфер) Тогда
							ДобавитьКомплектацию(СтрокаФасада.Демпфер, СтрокаФасада.КоличествоДемпфер, Элемент.НомерСтроки);
						КонецЕсли;
						
						Если ЗначениеЗаполнено(СтрокаФасада.ДопЭлемент) Тогда
							ДобавитьКомплектацию(СтрокаФасада.ДопЭлемент, 1, Элемент.НомерСтроки);
						КонецЕсли;
					КонецЕсли;
				КонецЕсли;
				
			ИначеЕсли ИзделиеШкафКупе И Строка.Материал = "ФасадЛДСП" Тогда
				
				ЭтоФасад = Истина;
				
				Материал = Строка.Материал;
				НоменклатураФасад = Элемент.НоменклатураЛДСП;
				Кромка = Элемент.КромкаЛДСП;
				РучкаФасада = Элемент.Ручка;
				Петли = Строка.Петли;
				КоличествоПетель = Строка.КоличествоПетель;
				
				РасположениеПазовИРучкиНаФасадах = Строка.РасположениеПазовИРучкиНаФасадах;
				
			КонецЕсли;
			
			Количество = 0;
			
			Попытка
				Выполнить("Количество = " + Строка.Количество);
			Исключение
				Текст = "Ошибка при формировании формул для Количество """ + Строка.ИмяДетали + """ каталога изделий " + Элемент.Изделие;
				ОбщегоНазначенияКлиентСервер.СообщитьПользователю(Текст);
			КонецПопытки;
			
			Если НЕ ЗначениеЗаполнено(Количество) Тогда
				Продолжить;
			КонецЕсли;
			
			НоваяСтрока = Объект.СписокМатериалы.Добавить();
			НоваяСтрока.Материал = ?(ЭтоФасад, Материал, Строка.Материал);
			
			НоваяСтрока.Количество = Количество;
			
			КромкаНоменклатуры = Неопределено;
			
			Если Строка.Материал = "10 ЛДСП" ИЛИ Строка.Материал = "16 ЛДСП" ИЛИ Строка.Материал = "10 ЛДСП+10 ЛДСП" 
				ИЛИ Строка.Материал = "16 ЛДСП+10 ЛДСП" ИЛИ Строка.Материал = "16 ЛДСП+16 ЛДСП" Тогда
				
				Если Строка.ВторойЦвет Тогда
					НоваяСтрока.Номенклатура = Элемент.НоменклатураЛДСПДоп;
					КромкаНоменклатуры = Элемент.КромкаЛДСПДоп;
				Иначе	
					НоваяСтрока.Номенклатура = Элемент.НоменклатураЛДСП;
					КромкаНоменклатуры = Элемент.КромкаЛДСП;
				КонецЕсли;
				
				Если Строка.Материал = "10 ЛДСП+10 ЛДСП" ИЛИ Строка.Материал = "16 ЛДСП+10 ЛДСП" ИЛИ Строка.Материал = "16 ЛДСП+16 ЛДСП" Тогда
					НоваяСтрока.НоменклатураДляСклеивания = Элемент.НоменклатураДляСклеивания;
				КонецЕсли;
			ИначеЕсли Строка.Материал = "ДВП" Тогда
				НоваяСтрока.Номенклатура = Элемент.НоменклатураДВП;
			ИначеЕсли Строка.Материал = "Стекло" Тогда
				НоваяСтрока.Номенклатура = Элемент.НоменклатураСтекло;
			ИначеЕсли Строка.Материал = "МДФ" Тогда
				НоваяСтрока.Номенклатура = Элемент.НоменклатураМДФ;
				КромкаНоменклатуры = Элемент.КромкаМДФ;
			ИначеЕсли ЭтоФасад Тогда
				НоваяСтрока.Номенклатура = НоменклатураФасад;
				КромкаНоменклатуры =  Кромка;
				
				ПетляДоступна = Ложь;
				Если ЗначениеЗаполнено(Петли) Тогда
					Если Материал = "ФасадСтеклянныйЗакругленный" Тогда
						ПетляДоступна = Петли.НоменклатурнаяГруппа = Справочники.НоменклатурныеГруппы.ПетлиПоворотные;
					ИначеЕсли Материал = "ФасадСтеклянный" Тогда
						ПетляДоступна = Петли.НоменклатурнаяГруппа = Справочники.НоменклатурныеГруппы.ПетлиДляСтеколБезДоводчика
						ИЛИ Петли.НоменклатурнаяГруппа = Справочники.НоменклатурныеГруппы.ПетлиДляСтеколСДоводчиком
						ИЛИ Петли.НоменклатурнаяГруппа = Справочники.НоменклатурныеГруппы.ПетлиПоворотные;
					Иначе
						ПетляДоступна = Петли.НоменклатурнаяГруппа = Справочники.НоменклатурныеГруппы.ПетлиБезДоводчика
						ИЛИ Петли.НоменклатурнаяГруппа = Справочники.НоменклатурныеГруппы.ПетлиСДоводчиком;
					КонецЕсли;
					
					СтруктураПоиска = Новый Структура;
					СтруктураПоиска.Вставить("Номенклатура", Петли);
					СтруктураПоиска.Вставить("Подразделение", Объект.Подразделение);
					Если ПетляДоступна Тогда
						ПетляДоступна = РегистрыСведений.НоменклатураПодразделений.Получить(СтруктураПоиска).Доступность;
					Иначе
						Текст = "Петли """ + Петли + """ недоступны для """ + Строка.ИмяДетали + """ каталога изделий " + Элемент.Изделие;
						ОбщегоНазначенияКлиентСервер.СообщитьПользователю(Текст);
					КонецЕсли;
				КонецЕсли;
				
				НоваяСтрока.Петли = ?(ПетляДоступна, Петли, Неопределено);
				НоваяСтрока.КоличествоПетель = ?(ПетляДоступна, КоличествоПетель, 0);
				НоваяСтрока.РасположениеПазовИРучкиНаФасадах = ?(ПетляДоступна, РасположениеПазовИРучкиНаФасадах, Неопределено);
				НоваяСтрока.ДиаметрПазов = Строка.ДиаметрПазов;
				НоваяСтрока.РасположениеФасада = Строка.РасположениеФасада;
				
				НоваяСтрока.РадиусФасада = "";
				
				Если ЗначениеЗаполнено(РучкаФасада) Тогда
					НоваяСтрока.НоменклатураДляСклеивания = РучкаФасада;
				КонецЕсли;
			КонецЕсли;
			
			НоменклатураМатериала = НоваяСтрока.Номенклатура;
			
			Если ЗначениеЗаполнено(Строка.ВысотаДетали) И ЗначениеЗаполнено(Строка.ШиринаДетали) Тогда
				Попытка
					Выполнить("НоваяСтрока.ВысотаДетали = " + Строка.ВысотаДетали);
					Выполнить("НоваяСтрока.ШиринаДетали = " + Строка.ШиринаДетали);
				Исключение
					Текст = "Ошибка при формировании формул для """ + Строка.ИмяДетали + """ каталога изделий " + Элемент.Изделие;
					ОбщегоНазначенияКлиентСервер.СообщитьПользователю(Текст);
				КонецПопытки;
				
				Если ЭтоФасад И ЗначениеЗаполнено(СтрокаФасада) Тогда
					Если СтрокаФасада.ПовернутьФасад Тогда
						ВременноеЗначение = НоваяСтрока.ВысотаДетали;
						НоваяСтрока.ВысотаДетали = НоваяСтрока.ШиринаДетали;
						НоваяСтрока.ШиринаДетали = ВременноеЗначение;
					КонецЕсли;
				Иначе
					
					//Рассчет коэффициента масштабирования криволинейной детали
					Если ЗначениеЗаполнено(Строка.СтрокаДляФлэш) Тогда
						
						МасштабироватьИЗаполнитьПараметрыРедактированнойДетали(Строка.СтрокаДляФлэш, НоваяСтрока, ОпределитьКромку(Строка.ВидКромкиРедактор, КромкаНоменклатуры));
						
					КонецЕсли;
				КонецЕсли;
			КонецЕсли;
			
			Если НЕ ЗначениеЗаполнено(НоваяСтрока.Номенклатура) И ЗначениеЗаполнено(Строка.Номенклатура) Тогда
				НоваяСтрока.Номенклатура = Строка.Номенклатура;
			КонецЕсли;
			
			НоваяСтрока.СоблюдениеТекстуры = НоваяСтрока.Номенклатура.НаличиеТекстуры;
			
			Если Строка.КромкаСверху Тогда
				СтруктураКромки = ОпределитьКромку(Строка.ВидКромкиСверху, КромкаНоменклатуры);
				НоваяСтрока.ПереключательКромкаСверху = СтруктураКромки.ПереключательКромка;
				НоваяСтрока.ВыборМебельнойКромкиСверху = СтруктураКромки.Кромка;
				ЗаполнитьКромки(НоваяСтрока, СтруктураКромки);
			КонецЕсли;
			
			Если Строка.КромкаСлева Тогда
				СтруктураКромки = ОпределитьКромку(Строка.ВидКромкиСлева, КромкаНоменклатуры);
				НоваяСтрока.ПереключательКромкаСлева = СтруктураКромки.ПереключательКромка;
				НоваяСтрока.ВыборМебельнойКромкиСлева = СтруктураКромки.Кромка;
				ЗаполнитьКромки(НоваяСтрока, СтруктураКромки);
			КонецЕсли;
			
			Если Строка.КромкаСнизу Тогда
				СтруктураКромки = ОпределитьКромку(Строка.ВидКромкиСнизу, КромкаНоменклатуры);
				НоваяСтрока.ПереключательКромкаСнизу = СтруктураКромки.ПереключательКромка;
				НоваяСтрока.ВыборМебельнойКромкиСнизу = СтруктураКромки.Кромка;
				ЗаполнитьКромки(НоваяСтрока, СтруктураКромки);
			КонецЕсли;
			
			Если Строка.КромкаСправа Тогда
				СтруктураКромки = ОпределитьКромку(Строка.ВидКромкиСправа, КромкаНоменклатуры);
				НоваяСтрока.ПереключательКромкаСправа = СтруктураКромки.ПереключательКромка;
				НоваяСтрока.ВыборМебельнойКромкиСправа = СтруктураКромки.Кромка;
				ЗаполнитьКромки(НоваяСтрока, СтруктураКромки);
			КонецЕсли;
			
			ТорцеваяЛента = Новый Структура;
			ТорцеваяЛента.Вставить("ТорцеваяЛентаСверху", НоваяСтрока.ВыборМебельнойКромкиСверху);
			ТорцеваяЛента.Вставить("ТорцеваяЛентаСнизу", НоваяСтрока.ВыборМебельнойКромкиСнизу);
			ТорцеваяЛента.Вставить("ТорцеваяЛентаСлева", НоваяСтрока.ВыборМебельнойКромкиСлева);
			ТорцеваяЛента.Вставить("ТорцеваяЛентаСправа", НоваяСтрока.ВыборМебельнойКромкиСправа);
			
			// Размеры с учетом кромки
			СтруктураРазмеров = Документы.Спецификация.ПолучитьРазмерыМатериалов(НоваяСтрока.Номенклатура, ТорцеваяЛента);
			ВысотаДеталиБезКромки = НоваяСтрока.ВысотаДетали -  СтруктураРазмеров.ВычитаемоеДляВысоты;
			ШиринаДеталиБезКромки = НоваяСтрока.ШиринаДетали - СтруктураРазмеров.ВычитаемоеДляШирины;
			
			НоваяСтрока.ВысотаДетали = ?(ВысотаДеталиБезКромки >= 0, ВысотаДеталиБезКромки, 0);
			НоваяСтрока.ШиринаДетали = ?(ШиринаДеталиБезКромки >= 0, ШиринаДеталиБезКромки, 0);
			
			Если ЗначениеЗаполнено(Строка.РадиусЛевоВерх)Тогда
				Попытка
					Выполнить("R1 = " + Строка.РадиусЛевоВерх);
				Исключение
					Текст = "Ошибка при формировании формул радиусов """ + Строка.ИмяДетали + """ каталога изделий " + Элемент.Изделие;
					ОбщегоНазначенияКлиентСервер.СообщитьПользователю(Текст);
				КонецПопытки;
			Иначе
				R1 = 0;
			КонецЕсли;
			
			Если ЗначениеЗаполнено(Строка.РадиусПравоВерх)Тогда
				Попытка
					Выполнить("R2 = " + Строка.РадиусПравоВерх);
				Исключение
					Текст = "Ошибка при формировании формул радиусов """ + Строка.ИмяДетали + """ каталога изделий " + Элемент.Изделие;
					ОбщегоНазначенияКлиентСервер.СообщитьПользователю(Текст);
				КонецПопытки;
			Иначе
				R2 = 0;
			КонецЕсли;
			
			Если ЗначениеЗаполнено(Строка.РадиусПравоНиз)Тогда
				Попытка
					Выполнить("R3 = " + Строка.РадиусПравоНиз);
				Исключение
					Текст = "Ошибка при формировании формул радиусов """ + Строка.ИмяДетали + """ каталога изделий " + Элемент.Изделие;
					ОбщегоНазначенияКлиентСервер.СообщитьПользователю(Текст);
				КонецПопытки;
			Иначе
				R3 = 0;
			КонецЕсли;
			
			Если ЗначениеЗаполнено(Строка.РадиусЛевоНиз)Тогда
				Попытка
					Выполнить("R4 = " + Строка.РадиусЛевоНиз);
				Исключение
					Текст = "Ошибка при формировании формул радиусов """ + Строка.ИмяДетали + """ каталога изделий " + Элемент.Изделие;
					ОбщегоНазначенияКлиентСервер.СообщитьПользователю(Текст);
				КонецПопытки;
			Иначе
				R4 = 0;
			КонецЕсли;
			
			НоваяСтрока.РадиусЛевоВерх = R1 - (R1 % 50);
			НоваяСтрока.РадиусПравоВерх = R2 - (R2 % 50);
			НоваяСтрока.РадиусПравоНиз = ?(Строка.Срез, R3, R3 - (R3 % 50));
			НоваяСтрока.РадиусЛевоНиз = R4 - (R4 % 50);
			НоваяСтрока.Срез = Строка.Срез;
			
			НоваяСтрока.СтруктураОтверстий = Строка.СтруктураОтверстий;
			
			Если НЕ ЗначениеЗаполнено(НоваяСтрока.СтрокаДляФлэш) Тогда 
				
				СтруктураПериметраИПила = ЛексКлиентСервер.ПосчитатьПериметрИКривойПил(НоваяСтрока.ВысотаДетали, НоваяСтрока.ШиринаДетали, R1 + R2 + R3 + R4);
				НоваяСтрока.Периметр = СтруктураПериметраИПила.Периметр;
				НоваяСтрока.ДлинаКривогоПила = СтруктураПериметраИПила.ДлинаКривогоПила;
				
			КонецЕсли;
			
			НоваяСтрока.Обтачивать = Строка.Обтачивать;
			НоваяСтрока.Идентификатор = Строка.Идентификатор;
			НоваяСтрока.НомерИзделия = Элемент.НомерСтроки;
			НоваяСтрока.НомерДеталиИзделия = Строка.НомерСтроки;
			
		КонецЦикла; // Строка Из СписокМатериалыИзделия
		
		#КонецОбласти
		
		///////////////////////////////////////////////////////////////////ЯЩИКИ//////////////////////////////////////////////////////////////////////////////////////
		
		# Область ДобавлениеЯщиков
		
		СписокЯщикиИзделия = НашеИзделие.СписокЯщики;
		
		Для Каждого Строка Из СписокЯщикиИзделия Цикл
			НоваяСтрока = Объект.СписокЯщики.Добавить();
			
			Попытка
				Выполнить("НоваяСтрока.ГлубинаЯщика = " + Строка.ГлубинаЯщика);
				Выполнить("НоваяСтрока.ПроемЯщика = " + Строка.ПроемЯщика);
				Выполнить("НоваяСтрока.ВысотаЯщика = " + Строка.ВысотаЯщика);
			Исключение
				Текст = "Ошибка при формировании формул для ящиков каталога изделий " + Элемент.Изделие;
				ОбщегоНазначенияКлиентСервер.СообщитьПользователю(Текст);
			КонецПопытки;
			
			Если ИзделиеШкафКупе Тогда
				
				НоваяСтрока.ВидЯщика = Перечисления.ВидыЯщика.Обычный;
				НоваяСтрока.НаправляющиеНоменклатура = НайтиНаправляющиеНоменклатура(Справочники.НоменклатурныеГруппы.НаправляющиеШариковые35, НоваяСтрока.ГлубинаЯщика);
				НоваяСтрока.ГлубинаЯщика = НоваяСтрока.НаправляющиеНоменклатура.ДлинаДетали;
				
				НоваяСтрока.Номенклатура = Элемент.НоменклатураЛДСП;
				
				Если ЗначениеЗаполнено(СтруктураПодбираемойПоЦветуНоменклатуры)
					И ЗначениеЗаполнено(СтруктураПодбираемойПоЦветуНоменклатуры.Кромка045_19) Тогда
					
					НоваяСтрока.КромкаНоменклатура = СтруктураПодбираемойПоЦветуНоменклатуры.Кромка045_19;
					
				ИначеЕсли Элемент.КромкаЛДСП.НоменклатурнаяГруппа = Справочники.НоменклатурныеГруппы.Кромка045_19 Тогда
					
					НоваяСтрока.КромкаНоменклатура = Элемент.КромкаЛДСП;
					
				Иначе	
					Текст = "Внимание! Кромка для ящика не найдена (" + НашеИзделие + ")";
					ОбщегоНазначенияКлиентСервер.СообщитьПользователю(Текст);	
				КонецЕсли;
				
			Иначе
				
				СтрокаПоиска = ПараметрыТаблицаФасадов.Получить(Строка.НомерСтроки - 1);//Строка.ИмяЯщика);
				Если ЗначениеЗаполнено(СтрокаПоиска) Тогда
					НоваяСтрока.ВидЯщика = СтрокаПоиска.ВыдвижнойЭлемент;
					НоваяСтрока.НаправляющиеНоменклатура = НайтиНаправляющиеНоменклатура(СтрокаПоиска.МеханизмЭлемента, НоваяСтрока.ГлубинаЯщика);
					Если НЕ ЗначениеЗаполнено(НоваяСтрока.НаправляющиеНоменклатура) Тогда
						Текст = "Внимание! Направляющая не найдена у " + НашеИзделие;
						ОбщегоНазначенияКлиентСервер.СообщитьПользователю(Текст);
					КонецЕсли;
					НоваяСтрока.ГлубинаЯщика = НоваяСтрока.НаправляющиеНоменклатура.ДлинаДетали;
					
					Если ЗначениеЗаполнено(СтрокаПоиска.ДопЭлемент) Тогда
						ДобавитьКомплектацию(СтрокаПоиска.ДопЭлемент, 1, Элемент.НомерСтроки);					
					КонецЕсли;
				КонецЕсли;
				
				НоваяСтрока.Номенклатура = СтрокаПоиска.НоменклатураЭлемента;
				НоваяСтрока.КромкаНоменклатура = СтрокаПоиска.ТорцовкаЭлемента;
				
			КонецЕсли;
			
			Документы.Спецификация.ПолучитьПараметрыЯщика(НоваяСтрока, Ложь);
			
			Если НоваяСтрока.ВидЯщика = Перечисления.ВидыЯщика.Обычный Тогда
				
				Если ЗначениеЗаполнено(Строка.ДноНоменклатура) Тогда
					
					НоваяСтрока.ДноНоменклатура = Строка.ДноНоменклатура;
					
				Иначе
					
					НоваяСтрока.ДноНоменклатура = Элемент.НоменклатураДВП;
					
				КонецЕсли;
				
			Иначе
				
				НоваяСтрока.ДноНоменклатура = Элемент.НоменклатураЛДСП;
				
			КонецЕсли;
			
			НоваяСтрока.ВидФасада = Строка.ВидФасада;
			Если НоваяСтрока.ВидФасада <> "Нет" Тогда
				Попытка
					ШиринаФасад = 0; 
					ВысотаФасад = 0;
					Выполнить("ШиринаФасад = " + Строка.ШиринаФасада);
					Выполнить("ВысотаФасад = " + Строка.ВысотаФасада);
					НоваяСтрока.ШиринаФасад = Окр(ШиринаФасад, 0, РежимОкругления.Окр15как10);
					НоваяСтрока.ВысотаФасад = Окр(ВысотаФасад, 0, РежимОкругления.Окр15как10);
				Исключение
					Текст = "Ошибка при формировании формул для фасадов ящика каталога изделий " + Элемент.Изделие;
					ОбщегоНазначенияКлиентСервер.СообщитьПользователю(Текст);
				КонецПопытки;
				
				НоваяСтрока.РасположениеФасада = Строка.РасположениеФасада;
				
				Если ИзделиеШкафКупе Тогда
					
					НоваяСтрока.ФасадНоменклатура = Элемент.НоменклатураЛДСП;
					НоваяСтрока.РучкаНоменклатура = Элемент.Ручка;
					НоваяСтрока.КоличествоРучек = 1;
					НоваяСтрока.КромкаФасадНоменклатура = Элемент.КромкаЛДСП;
					
					//Если ЗначениеЗаполнено(СтруктураПодбираемойПоЦветуНоменклатуры)
					//	И ЗначениеЗаполнено(СтруктураПодбираемойПоЦветуНоменклатуры.Кромка2_19) Тогда
					//	
					//	НоваяСтрока.КромкаФасадНоменклатура = СтруктураПодбираемойПоЦветуНоменклатуры.Кромка2_19;
					//	
					//Иначе
					//	
					//	НоваяСтрока.КромкаФасадНоменклатура = Элемент.КромкаЛДСП;
					//	
					//КонецЕсли;
					
				Иначе
					
					НоваяСтрока.ФасадНоменклатура = СтрокаПоиска.НоменклатураФасада;
					НоваяСтрока.РучкаНоменклатура = СтрокаПоиска.НоменклатураРучки;
					НоваяСтрока.КромкаФасадНоменклатура = СтрокаПоиска.ОбрамлениеФасада;
					
					КоличествоРучек = 0;
					Выполнить("КоличествоРучек = " + ?(ЗначениеЗаполнено(Строка.КоличествоРучек), Строка.КоличествоРучек, 0));
					НоваяСтрока.КоличествоРучек = Мин(Макс(КоличествоРучек, 1), 2);
					
					Если СтрокаПоиска.ПовернутьФасад Тогда
						ВременноеЗначение = НоваяСтрока.ШиринаФасад;
						НоваяСтрока.ШиринаФасад = НоваяСтрока.ВысотаФасад;
						НоваяСтрока.ВысотаФасад = ВременноеЗначение;
					КонецЕсли;
					
				КонецЕсли; // ИзделиеШкафКупе
				
			КонецЕсли;
			
			НоваяСтрока.НомерИзделия = Элемент.НомерСтроки;
			НоваяСтрока.КоличествоЯщиков =  Строка.КоличествоЯщиков;
			НоваяСтрока.НомерЯщикаИзделия = Строка.НомерСтроки;
			
		КонецЦикла; //Для Каждого Строка Из СписокЯщикиИзделия Цикл
		
		#КонецОбласти
		
	КонецЦикла;
	
КонецПроцедуры

&НаСервере
Процедура ДобавитьКомплектацию(Номенклатура, Количество, НомерИзделия)
	
	Если ЗначениеЗаполнено(Номенклатура) Тогда
		НоваяСтрока = Объект.Комплектация.Добавить();
		НоваяСтрока.Номенклатура = Номенклатура;
		НоваяСтрока.Количество = Количество;
		НоваяСтрока.ЕдиницаИзмерения = Номенклатура.ЕдиницаИзмерения;
		НоваяСтрока.НомерИзделия = НомерИзделия;
	КонецЕсли;
	
КонецПроцедуры

&НаСервере
Функция НайтиНаправляющиеНоменклатура(НоменклатурнаяГруппа, ГлубинаЯщика, ПоВозрастания = Ложь)
	
	// { Васильев Александр Леонидович [23.02.2015]
	// Костыль
	// } Васильев Александр Леонидович [23.02.2015]
	
	Запрос = Новый Запрос;
	Если ПоВозрастания Тогда
		
		Запрос.Текст =
		"ВЫБРАТЬ ПЕРВЫЕ 1
		|	спрНоменклатура.Ссылка
		|ИЗ
		|	Справочник.Номенклатура КАК спрНоменклатура
		|		ЛЕВОЕ СОЕДИНЕНИЕ РегистрСведений.НоменклатураПодразделений КАК НоменклатураПодразделений
		|		ПО (НоменклатураПодразделений.Номенклатура = спрНоменклатура.Ссылка)
		|ГДЕ
		|	спрНоменклатура.НоменклатурнаяГруппа = &НоменклатурнаяГруппа
		|	И спрНоменклатура.ДлинаДетали >= &ДлинаДетали
		|	И НоменклатураПодразделений.Подразделение = &Подразделение
		|	И НоменклатураПодразделений.Доступность
		|
		|УПОРЯДОЧИТЬ ПО
		|	спрНоменклатура.ДлинаДетали";
		
	Иначе
		
		Запрос.Текст = 
		"ВЫБРАТЬ ПЕРВЫЕ 1
		|	спрНоменклатура.Ссылка
		|ИЗ
		|	Справочник.Номенклатура КАК спрНоменклатура
		|		ЛЕВОЕ СОЕДИНЕНИЕ РегистрСведений.НоменклатураПодразделений КАК НоменклатураПодразделений
		|		ПО (НоменклатураПодразделений.Номенклатура = спрНоменклатура.Ссылка)
		|ГДЕ
		|	спрНоменклатура.НоменклатурнаяГруппа = &НоменклатурнаяГруппа
		|	И спрНоменклатура.ДлинаДетали <= &ДлинаДетали
		|	И НоменклатураПодразделений.Подразделение = &Подразделение
		|	И НоменклатураПодразделений.Доступность
		|
		|УПОРЯДОЧИТЬ ПО
		|	спрНоменклатура.ДлинаДетали УБЫВ";
		
	КонецЕсли;
	Запрос.УстановитьПараметр("НоменклатурнаяГруппа", НоменклатурнаяГруппа);
	Запрос.УстановитьПараметр("ДлинаДетали", ГлубинаЯщика);
	Запрос.УстановитьПараметр("Подразделение", Объект.Подразделение);
	Выборка = Запрос.Выполнить().Выгрузить();
	
	Если Выборка.Количество() > 0 Тогда
		Возврат Выборка[0].Ссылка;
	Иначе
		Возврат Неопределено;
	КонецЕсли;
	
КонецФункции

&НаСервере
Функция НайтиВсеФормулы() 
	
	ВсеФормулы = Новый Структура;
	
	Запрос = Новый Запрос;
	Запрос.Текст = 
	"ВЫБРАТЬ
	|	ФормулыКаталога.Наименование,
	|	ФормулыКаталога.РазвернутаяФормула
	|ИЗ
	|	Справочник.ФормулыКаталога КАК ФормулыКаталога
	|ГДЕ
	|	НЕ ФормулыКаталога.ПометкаУдаления
	|	И ФормулыКаталога.Активность";
	
	Выборка = Запрос.Выполнить().Выбрать();
	
	Пока Выборка.Следующий() Цикл
		
		ВсеФормулы.Вставить(Выборка.Наименование, Выборка.РазвернутаяФормула);
		
	КонецЦикла;
	
	Возврат ВсеФормулы;
	
КонецФункции

&НаСервере
Функция ОпределитьКромку(ВидКромкиПоУмолчанию, Кромка)
	
	ВидКромки = ВидКромкиПоУмолчанию;
	Структура = Новый Структура;
	Структура.Вставить("ПереключательКромка", "Нет");
	Структура.Вставить("Кромка", Кромка);
	
	Структура.Вставить("ЭтоКант", Ложь);
	Структура.Вставить("ЭтоКромка045", Ложь);
	Структура.Вставить("ЭтоКромка2", Ложь);
	Структура.Вставить("ЭтоУниверсальнаяКромка", Ложь);
	
	НоменклатурнаяГруппаКромки = Кромка.НоменклатурнаяГруппа;
	
	Если НЕ ЗначениеЗаполнено(ВидКромки) Тогда
		ВидКромки = НоменклатурнаяГруппаКромки;
	КонецЕсли;
	
	ЭтоКантП = ВидКромки = Справочники.НоменклатурныеГруппы.КантП;
	ЭтоКантТ = ВидКромки = Справочники.НоменклатурныеГруппы.КантТ;
	ЭтоКромка2_19 = ВидКромки = Справочники.НоменклатурныеГруппы.Кромка2_19;
	ЭтоКромка2_35 = ВидКромки = Справочники.НоменклатурныеГруппы.Кромка2_35; 
	ЭтоКромка045_19 = ВидКромки = Справочники.НоменклатурныеГруппы.Кромка045_19; 
	ЭтоУниверсальнаяКромка = ВидКромки = Справочники.НоменклатурныеГруппы.АГТПрофиль
	ИЛИ ВидКромки = Справочники.НоменклатурныеГруппы.КромкаМДФ
	ИЛИ ВидКромки = Справочники.НоменклатурныеГруппы.РамочныйАлюминий;
	
	Если ВидКромки <> НоменклатурнаяГруппаКромки Тогда
		
		Если ЭтоКантТ Тогда
			Структура.Вставить("Кромка", СтруктураПодбираемойПоЦветуНоменклатуры.КантТ);
			Структура.Вставить("ПереключательКромка", "Кант");
			Структура.Вставить("ЭтоКант", Истина);
		ИначеЕсли ЭтоКромка2_19 Тогда
			Структура.Вставить("Кромка", СтруктураПодбираемойПоЦветуНоменклатуры.Кромка2_19);
			Структура.Вставить("ПереключательКромка", "2");
			Структура.Вставить("ЭтоКромка2", Истина);
		ИначеЕсли ЭтоКромка2_35 Тогда
			Структура.Вставить("Кромка", СтруктураПодбираемойПоЦветуНоменклатуры.Кромка2_35);
			Структура.Вставить("ПереключательКромка", "2");
			Структура.Вставить("ЭтоКромка2", Истина);
		ИначеЕсли ЭтоКромка045_19 Тогда
			Структура.Вставить("Кромка", СтруктураПодбираемойПоЦветуНоменклатуры.Кромка045_19);
			Структура.Вставить("ПереключательКромка", "0.45");
			Структура.Вставить("ЭтоКромка045", Истина);
		КонецЕсли;
		
	Иначе
		
		Если ЭтоКантП ИЛИ ЭтоКантТ Тогда
			Структура.Вставить("ПереключательКромка", "Кант");
			Структура.Вставить("ЭтоКант", Истина);
		ИначеЕсли ЭтоКромка2_19 ИЛИ ЭтоКромка2_35 Тогда
			Структура.Вставить("ПереключательКромка", "2");
			Структура.Вставить("ЭтоКромка2", Истина);
		ИначеЕсли ЭтоКромка045_19 Тогда
			Структура.Вставить("ПереключательКромка", "0.45");
			Структура.Вставить("ЭтоКромка045", Истина);
		ИначеЕсли ЭтоУниверсальнаяКромка Тогда
			Структура.Вставить("ПереключательКромка", "УниверсальнаяКромка");
			Структура.Вставить("ЭтоУниверсальнаяКромка", Истина);
		КонецЕсли;
		
	КонецЕсли;
	
	Возврат Структура;
	
КонецФункции

&НаСервере
Процедура ЗаполнитьКромки(НоваяСтрока, СтруктураКромки)
	
	Если СтруктураКромки.ЭтоКант И НЕ ЗначениеЗаполнено(НоваяСтрока.Кант) Тогда
		
		НоваяСтрока.Кант = СтруктураКромки.Кромка;
		
	КонецЕсли;
	
	Если СтруктураКромки.ЭтоКромка045 И НЕ ЗначениеЗаполнено(НоваяСтрока.Кромка045мм) Тогда
		
		НоваяСтрока.Кромка045мм = СтруктураКромки.Кромка;
		
	КонецЕсли;
	
	Если СтруктураКромки.ЭтоКромка2 И НЕ ЗначениеЗаполнено(НоваяСтрока.Кромка2мм) Тогда
		
		НоваяСтрока.Кромка2мм = СтруктураКромки.Кромка;
		
	КонецЕсли;
	
	Если СтруктураКромки.ЭтоУниверсальнаяКромка И НЕ ЗначениеЗаполнено(НоваяСтрока.УниверсальнаяКромка) Тогда
		
		НоваяСтрока.УниверсальнаяКромка = СтруктураКромки.Кромка;
		
	КонецЕсли;
	
КонецПроцедуры

&НаКлиенте
Процедура ПерезаполнитьТаблицу(Таблица)
	
	Количество = Таблица.Количество();
	Если Количество > 0 Тогда
		Для Индекс = 1 По Количество Цикл
			Элемент = Таблица[Количество - Индекс];
			Если Элемент.НомерИзделия > 0 Тогда
				Таблица.Удалить(Элемент);
			КонецЕсли;
		КонецЦикла;
	КонецЕсли;
	
КонецПроцедуры

&НаСервереБезКонтекста
Функция ИзделиеПриИзмененииНаСервере(нИзделие, нКонтрагент)
	
	Структура = Новый Структура;
	Структура.Вставить("ЗапретРедактирования", нИзделие.ЗапретРедактирования);
	Структура.Вставить("Переделка", нИзделие = Справочники.Изделия.Переделка);
	Структура.Вставить("ПоказатьТелефон", (нИзделие = Справочники.Изделия.Детали И нКонтрагент = Справочники.Контрагенты.ЧастноеЛицо));
	
	Возврат Структура;
	
КонецФункции

#КонецОбласти

#Область Управление_внешним_видом

// Возвращает Строку для УведомлениеМатериалПодЗаказ в которой есть рабочий телефон Заведующего Складами Материалов из указанного подразделения
//
// Параметры:
//  Подразделение  - СправочникСсылка.Подразделение, подразделение, в котором ищем ЗаведующегоСкладамиМатериалов
//
// Возвращаемое значение:
//   ТекстУведомления   - Строка, телефон ЗаведующегоСкладамиМатериалов
&НаСервереБезКонтекста
Функция ПолучитьУведомлениеМатериалПодЗаказ(Подразделение)
	
	ФизЛицо = ЛексСервер.ПолучитьНастройкуПодразделения(Подразделение, Перечисления.ВидыНастроекПодразделений.ФизЛицоДляСогласованияМатериала);
	
	Если НЕ ЗначениеЗаполнено(ФизЛицо) Тогда
		
		Телефон = "8-962-285-73-98"; // телефон Гарбузова
		
	Иначе
		
		СвойстваФизлица = ЛексСервер.ЗначенияРеквизитовОбъекта(Физлицо, "ТелефонРабочий, Телефон");
		
		Если ЗначениеЗаполнено(СвойстваФизлица.ТелефонРабочий) Тогда
			Телефон = СвойстваФизлица.ТелефонРабочий;
		ИначеЕсли ЗначениеЗаполнено(СвойстваФизлица.Телефон) Тогда
			Телефон = СвойстваФизлица.Телефон;
		КонецЕсли;
		
	КонецЕсли;
	
	ТекстУведомления = "Согласуйте по тел. " + Телефон;
	
	Возврат ТекстУведомления;
	
КонецФункции // ПолучитьУведомлениеМатериалПодЗаказ()

&НаКлиентеНаСервереБезКонтекста
Функция ОбновитьЭлементыФормы(лФорма, лПараметры)
	
	Если ТипЗнч(лПараметры) <> Тип("Структура") Тогда
		Возврат Истина;
	КонецЕсли;
	
	Элементы = лФорма.Элементы;
	
	Если лПараметры.Свойство("ЕстьМатериалПодЗаказ") Тогда
		Элементы.УведомлениеМатериалПодЗаказ.Видимость = лПараметры.ЕстьМатериалПодЗаказ;
	КонецЕсли;
	
	Если лПараметры.Свойство("ЕстьМонтаж") Тогда
		
		Элементы.Монтажник.Доступность = лПараметры.ЕстьМонтаж;
		Доступность = лПараметры.ЕстьМонтаж;
		Элементы.ДатаОтгрузки.Доступность = НЕ лПараметры.ЕстьМонтаж;
		
	КонецЕсли;
	
	Если лПараметры.Свойство("Переделка") Тогда
		
		Элементы.ГруппаПеределка.Видимость = лПараметры.Переделка;
		Элементы.СтраницаВиновные.Доступность = лПараметры.Переделка;
		Элементы.СтраницаВиновные.Видимость = лПараметры.Переделка;
		
	КонецЕсли;
	
	Если лПараметры.Свойство("ПользовательАдминистратор") Тогда
		
		МассивЭлементовАдминистратора = Новый Массив;
		МассивЭлементовАдминистратора.Добавить(Элементы.СтраницаСписокНоменклатуры);
		МассивЭлементовАдминистратора.Добавить(Элементы.СтраницаСкладГотовойПродукции);
		МассивЭлементовАдминистратора.Добавить(Элементы.СтраницаСписокЛистовНоменклатуры);
		
		Если лПараметры.ПользовательАдминистратор Тогда
			Для каждого ЭлементовАдминистратора Из МассивЭлементовАдминистратора Цикл
				ЭлементовАдминистратора.Видимость = Истина;
			КонецЦикла;
		КонецЕсли;
		
	КонецЕсли;
	
	// дилерские элементы
	Если лПараметры.Свойство("Дилерский") Тогда
		
		НовыйМассив = Новый Массив;
		
		НовыйПараметр = Новый ПараметрВыбора("Отбор.Активность", Истина);
		НовыйМассив.Добавить(НовыйПараметр);
		
		Если лПараметры.Дилерский Тогда
			НовыйПараметр = Новый ПараметрВыбора("Отбор.ЗапрещеноДляДилеров", Ложь);
			НовыйМассив.Добавить(НовыйПараметр);
		КонецЕсли;
		
		НовыеПараметры = Новый ФиксированныйМассив(НовыйМассив);
		лФорма.Элементы.Изделие.ПараметрыВыбора = НовыеПараметры;
		
		МассивДилерскихЭлементов = Новый Массив;
		МассивДилерскихЭлементов.Добавить(Элементы.Офис);
		МассивДилерскихЭлементов.Добавить(Элементы.Телефон);
		МассивДилерскихЭлементов.Добавить(Элементы.Технолог);
		МассивДилерскихЭлементов.Добавить(Элементы.ГруппаОснование);
		МассивДилерскихЭлементов.Добавить(Элементы.Договор);
		МассивДилерскихЭлементов.Добавить(Элементы.ГруппаСкидкаДоговора);
		
		Если лПараметры.Дилерский Тогда
			Элементы.Контрагент.Доступность = Ложь;
			Элементы.Подразделение.Доступность = Ложь;
			Для каждого ДилерскийЭлемент Из МассивДилерскихЭлементов Цикл
				ДилерскийЭлемент.Видимость = Ложь;
			КонецЦикла;
		КонецЕсли;
		
	КонецЕсли;
	
	Если лПараметры.Свойство("ЗапретРедактирования") Тогда
		
		Элементы.СтраницаВиновные.ТолькоПросмотр = лПараметры.ЗапретРедактирования;
		Элементы.СтраницаМатериалы.ТолькоПросмотр = лПараметры.ЗапретРедактирования;
		Элементы.СтраницаЯщики.ТолькоПросмотр = лПараметры.ЗапретРедактирования;
		Элементы.СтраницаДвери.ТолькоПросмотр = лПараметры.ЗапретРедактирования;
		Элементы.СтраницаКомплектация.ТолькоПросмотр = лПараметры.ЗапретРедактирования;
		Элементы.КомплектацияПодбор.Доступность = НЕ лПараметры.ЗапретРедактирования;
		Элементы.КомплектацияФурнитура.Доступность = НЕ лПараметры.ЗапретРедактирования;
		Элементы.КомплектацияСотовыеЭлементы.Доступность = НЕ лПараметры.ЗапретРедактирования;
		Элементы.СписокДверейДобавитьДвери.Доступность = НЕ лПараметры.ЗапретРедактирования;
		Элементы.Двери.Доступность = НЕ лПараметры.ЗапретРедактирования;
		Элементы.Технолог.Видимость = НЕ лПараметры.ЗапретРедактирования;
		
	КонецЕсли;
	
	Если лПараметры.Свойство("ПоказатьТелефон") Тогда
		
		Элементы.Телефон.Доступность = лПараметры.ПоказатьТелефон;
		
	КонецЕсли;
	
	Если лПараметры.Свойство("СоздатьЗамер") Тогда
		
		Элементы.СоздатьЗамер.Видимость = лПараметры.СоздатьЗамер;
		
	КонецЕсли;
	
КонецФункции

&НаСервере
Функция ОбновитьДоступностьКоманд()
	
	Если ТолькоПросмотр Тогда
		
		Возврат Ложь;
		
	КонецЕсли;
	
	// { Васильев Александр Леонидович [05.06.2014]
	// ну нахуй ебучее говнище :(
	// } Васильев Александр Леонидович [05.06.2014]
	
	// категории пользователей:
	// 1 Администраторы -- можно всё и всегда
	// 2 Технологи -- редактируют до передачи в цех
	// 3 Дилеры -- только передают в производство
	// 4 Дизайнеры -- детали передают в производство, остальное передают на проверку
	// 5 Логисты -- ставят только проверен логистом
	
	Пользователь = ПользователиКлиентСервер.ТекущийПользователь();
	
	Дилер = УправлениеДоступомПереопределяемый.ЕстьДоступКПрофилюГруппДоступа(Пользователь, Справочники.ПрофилиГруппДоступа.Дилер);
	Дизайнер = УправлениеДоступомПереопределяемый.ЕстьДоступКПрофилюГруппДоступа(Пользователь, Справочники.ПрофилиГруппДоступа.ДизайнерКонсультант);
	Технолог = УправлениеДоступомПереопределяемый.ЕстьДоступКПрофилюГруппДоступа(Пользователь, Справочники.ПрофилиГруппДоступа.СтаршийДизайнер)
	ИЛИ УправлениеДоступомПереопределяемый.ЕстьДоступКПрофилюГруппДоступа(Пользователь, Справочники.ПрофилиГруппДоступа.ИнженерТехнолог);
	Администратор = УправлениеДоступомПереопределяемый.ЕстьДоступКПрофилюГруппДоступа(Пользователь, Справочники.ПрофилиГруппДоступа.Администратор);
	
	Переделка = Объект.Изделие = Справочники.Изделия.Переделка;
	
	Элементы.СтраницаПодЗаказ.Видимость = НЕ Дилер; // не здесь это должно быть, есть спец. функция для внешнего вида
	
	ДилерВПроизводство = Дилер И Объект.Изделие = Справочники.Изделия.Детали;
	
	ПроверенЛогистом = НЕ Объект.ЕстьМатериалПодЗаказ ИЛИ ЛексСервер.СпецификацияПроверенаЛогистом(СтатусСпецификации) ИЛИ ЗаполненыПоставщики(Объект.СписокМатериаловПодЗаказ, Объект.Дилерский) ;
	
	Технолог = Технолог И ПроверенЛогистом;
	Дизайнер = Дизайнер И ПроверенЛогистом;
	Дилер = Дилер И ПроверенЛогистом;
	Логист = РольДоступна("ПроверкаЛогистомСпецификации");
	
	ДоступныСтатусы = Администратор;
	
	ДизайнерВПроизводство = (Объект.Изделие = Справочники.Изделия.Детали ИЛИ Объект.Изделие = Справочники.Изделия.ДопСоглашение) И Дизайнер;
	ТехнологВПроизводство = Технолог И (СтатусСпецификации = Перечисления.СтатусыСпецификации.Рассчитывается ИЛИ Объект.Изделие = Справочники.Изделия.Переделка ИЛИ Объект.Изделие = Справочники.Изделия.ДопСоглашение);
	
	Ком = КоманднаяПанель.ПодчиненныеЭлементы.Статусы.ПодчиненныеЭлементы;
	
	// { Васильев Александр Леонидович [22.12.2014]
	// Часть ролями можно сделать.
	// Будем причесывть...
	// } Васильев Александр Леонидович [22.12.2014]
	
	//Ком.ФормаНаПроверку.Доступность = Администратор ИЛИ Дилер ИЛИ Дизайнер;
	
	// Пока попыткой, после переноса функционала в роли, можно будет удалить совсем.
	Попытка
		Ком.ФормаЕстьЗамечания.Доступность = Администратор ИЛИ Технолог;
	Исключение
	КонецПопытки;
	Попытка
		Ком.ФормаПроверенаЛогистом.Доступность = Объект.ЕстьМатериалПодЗаказ И (Администратор ИЛИ Логист);
	Исключение
	КонецПопытки;
	Попытка
		Ком.ФормаПроверена.Доступность = Администратор ИЛИ Технолог;
	Исключение
	КонецПопытки;
	
	Ком.ФормаПередатьВПроизводство.Доступность = Администратор ИЛИ ДизайнерВПроизводство ИЛИ ДилерВПроизводство ИЛИ ТехнологВПроизводство ИЛИ Переделка;
	Ком.ФормаНаРасчет.Доступность = Дилер И Объект.Изделие <> Справочники.Изделия.Детали;
	
	ТолькоПросмотр = НЕ ЛексСервер.ДоступностьСпецификации(Объект.Ссылка); // помойму не здесь это должно быть...
	Элементы.АдресМонтажа.Доступность = НЕ ТолькоПросмотр;
	
КонецФункции

#КонецОбласти

#Область СобытияФормы

&НаКлиенте
Процедура ПередЗаписью(Отказ, ПараметрыЗаписи)
	
	Заглушка = Истина;
	
	//ТекстСообщения = СтруктураПроверки.СтрокаСообщенияОКратности;
	//
	//Если ЗначениеЗаполнено(ТекстСообщения) Тогда
	//	// тут нужно вывести сообщения об измененном материале
	//	ПоказатьОповещениеПользователя("Изменено количество материала",, ТекстСообщения);
	//КонецЕсли;
	
КонецПроцедуры

&НаКлиенте
Процедура ПослеЗаписи(ПараметрыЗаписи)
	
	Если ПараметрыЗаписи.РежимЗаписи = РежимЗаписиДокумента.Проведение Тогда
		
		ЗаписатьРисункиРаскроя(ПараметрыЗаписи);
		
	КонецЕсли;
	
	ЗаписатьСтрокуРаскроя(ПараметрыЗаписи);
	
	ПересчитатьСуммы(); // СуммаДокумента обновляется только после записи объекта
	ОбновитьДоступностьКоманд();
	
КонецПроцедуры

&НаСервере
Процедура ПослеЗаписиНаСервере(ТекущийОбъект, ПараметрыЗаписи)
	
	Если ПараметрыЗаписи.Свойство("НовыйСтатус") Тогда
		Документы.Спецификация.УстановитьСтатусСпецификации(ТекущийОбъект.Ссылка, ПараметрыЗаписи.НовыйСтатус);
	КонецЕсли;
	
	СтруктураПараметров = Новый Структура;
	СтруктураПараметров.Вставить("ЕстьМатериалПодЗаказ", ТекущийОбъект.ЕстьМатериалПодЗаказ);
	СтруктураПараметров.Вставить("Подразделение", ТекущийОбъект.Подразделение);
	
	ОбновитьЭлементыФормы(ЭтаФорма, СтруктураПараметров);
	
КонецПроцедуры

&НаСервере
Процедура ПриЧтенииНаСервере(ТекущийОбъект)
	
	ДатыЗапретаИзменения.ОбъектПриЧтенииНаСервере(ЭтаФорма, ТекущийОбъект);
	СтатусСпецификации = Документы.Спецификация.ПолучитьСтатусСпецификации(Объект.Ссылка);
	
	// команды
	ОбновитьДоступностьКоманд();
	
КонецПроцедуры

&НаСервере
Процедура ПриСозданииНаСервере(Отказ, СтандартнаяОбработка)
	
	// СтандартныеПодсистемы.ВерсионированиеОбъектов
	ВерсионированиеОбъектов.ПриСозданииНаСервере(ЭтаФорма);
	// Конец СтандартныеПодсистемы.ВерсионированиеОбъектов
	
	//Если Параметры.Свойство("ПовторнаяПроверка") Тогда
	//	ПовторнаяПроверка = Параметры.ПовторнаяПроверка;
	//КонецЕсли;
	
	
	
	//RonEXI: Разделитель кода. Если истина то ящики считаются по новым правилам, если ложь то по старым.
	НовыеЯщики = Ложь;
	
	
	
	
	
	Если Параметры.Свойство("НомерСтроки") Тогда
		Элементы.СписокМатериалы.ТекущаяСтрока = Параметры.НомерСтроки - 1;
	КонецЕсли;
	
	//Договор
	Договор = Документы.Спецификация.ПолучитьДоговор(Объект.Ссылка);
	Если НЕ ЗначениеЗаполнено(Договор) Тогда
		Договор = "Введите договор";
	КонецЕсли;
	
	Пользователь = ПользователиКлиентСервер.ТекущийПользователь();
	ПользовательАдминистратор = УправлениеДоступомПереопределяемый.ЕстьДоступКПрофилюГруппДоступа(Пользователь, Справочники.ПрофилиГруппДоступа.Администратор);
	НовыеПараметры = ИзделиеПриИзмененииНаСервере(Объект.Изделие, Объект.Контрагент);
	
	СтруктураПараметров = Новый Структура;
	СтруктураПараметров.Вставить("Дилерский", Объект.Дилерский);
	СтруктураПараметров.Вставить("ЕстьМонтаж", Объект.ПакетУслуг = Перечисления.ПакетыУслуг.ДоставкаДоКлиентаИМонтаж);
	СтруктураПараметров.Вставить("Переделка", Объект.Изделие = Справочники.Изделия.Переделка);
	СтруктураПараметров.Вставить("ПользовательАдминистратор", ПользовательАдминистратор);
	СтруктураПараметров.Вставить("ЕстьМатериалПодЗаказ", Объект.ЕстьМатериалПодЗаказ);
	СтруктураПараметров.Вставить("СоздатьЗамер", НЕ ЗначениеЗаполнено(Объект.ДокументОснование) И НЕ Объект.Дилерский);
	СтруктураПараметров.Вставить("ЗапретРедактирования", НовыеПараметры.ЗапретРедактирования);
	СтруктураПараметров.Вставить("ПоказатьТелефон", НовыеПараметры.ПоказатьТелефон);
	ОбновитьЭлементыФормы(ЭтаФорма, СтруктураПараметров);
	
	УведомлениеМатериалПодЗаказ = ПолучитьУведомлениеМатериалПодЗаказ(Объект.Подразделение);
	ВидОплаты = Перечисления.ВидыОплатыДоговоров.ПолнаяПредоплата; // для расчета скидки
	
	СписокНоменклатурыЗаказчика = ПолучитьСписокНоменклатурыЗаказчика(Объект);
	Элементы.СписокМатериаловЗаказчикаНоменклатура.СписокВыбора.ЗагрузитьЗначения(СписокНоменклатурыЗаказчика.МассивНоменклатуры);
	
КонецПроцедуры

&НаСервере
Функция ПолучитьСписокНоменклатурыЗаказчика(ТекущийОбъект)
	
	СтруктураМассивов = Новый Структура;
	МассивНоменклатуры = Новый Массив;
	СправочникНоменклатурнаяГруппа = Справочники.НоменклатурныеГруппы;
	
	Для каждого Строка Из ТекущийОбъект.СписокНоменклатуры Цикл
		
		Номенклатура = Строка.Номенклатура;
		НоменклатурнаяГруппа = Номенклатура.НоменклатурнаяГруппа;
		
		Если Номенклатура.ВидНоменклатуры = Перечисления.ВидыНоменклатуры.Материал Тогда
			
			ПроверитьНаличиеВСпискеНоменклатуры = МассивНоменклатуры.Найти(Номенклатура);
			НужнаяГруппа = НоменклатурнаяГруппа.МожетПредоставитьЗаказчик;
			
			Если НужнаяГруппа и ПроверитьНаличиеВСпискеНоменклатуры = Неопределено И ЗначениеЗаполнено(Номенклатура) Тогда
				
				МассивНоменклатуры.Добавить(Номенклатура);
				
			КонецЕсли;
			
		КонецЕсли;
		
	КонецЦикла;
	
	Для каждого Строка Из ТекущийОбъект.СписокМатериаловЗаказчика Цикл
		
		Номенклатура = Строка.Номенклатура;
		
		Если Номенклатура.ВидНоменклатуры = Перечисления.ВидыНоменклатуры.Материал Тогда
			
			Индекс = МассивНоменклатуры.Найти(Номенклатура);
			
			Если Индекс <> Неопределено Тогда
				
				МассивНоменклатуры.Удалить(Индекс);
				
			КонецЕсли;
			
		КонецЕсли;
		
	КонецЦикла;
	
	СтруктураМассивов.Вставить("МассивНоменклатуры", МассивНоменклатуры);
	
	Возврат СтруктураМассивов;
	
КонецФункции

&НаКлиенте
Процедура КомплектацияНаменованиеПриИзменении(Элемент)
	
	ТекущиеДанные 								= Элементы.Комплектация.ТекущиеДанные;
	ТекущиеДанные.ЕдиницаИзмерения 	= ЛексСервер.ЗначениеРеквизитаОбъекта(ТекущиеДанные.Номенклатура, "ЕдиницаИзмерения");
	
КонецПроцедуры

&НаСервере
Процедура ПередЗаписьюНаСервере(Отказ, ТекущийОбъект, ПараметрыЗаписи)
	
	Перем Ошибки;
	
	ТекущийОбъект.ДваДняИзготовление = Ложь;
	
	СписокНоменклатурыДляЗаполненияРеквизита = Новый Структура;
	СписокНоменклатурыДляЗаполненияРеквизита.Вставить("ТЗНоменклатуры", ТекущийОбъект.СписокМатериаловЗаказчика.Выгрузить());
	
	ПараметрыЗаписи.Вставить("ДанныеДляРаскроя", "");
	ПараметрыЗаписи.Вставить("СтрокаКривогоПила", "");
	ПараметрыЗаписи.Вставить("ТаблицаДеталей", "");
	ПараметрыЗаписи.Вставить("ЗаписатьРаскрой", "");
	ПараметрыЗаписи.Вставить("РисунокКривогоПила", "");
	ПараметрыЗаписи.Вставить("РисунокРаскроя", "");
	ПараметрыЗаписи.Вставить("АлгоритмРаскроя", "");
	
	УбратьПроверкуПриМодифицированности();
	
	ТекущийОбъект.ЭтоКухня = Ложь;
	Для каждого ИзделиеПоКаталогу Из ТекущийОбъект.СписокИзделийПоКаталогу Цикл
		Если ИзделиеПоКаталогу.Изделие.ВидИзделияПоКаталогу = Справочники.ВидыИзделийПоКаталогу.КухняВерхний ИЛИ ИзделиеПоКаталогу.Изделие.ВидИзделияПоКаталогу = Справочники.ВидыИзделийПоКаталогу.КухняНижний Тогда
			ТекущийОбъект.ЭтоКухня = Истина;
			Прервать;
		КонецЕсли;
	КонецЦикла;
	
	ТекущийОбъект.Дата = ТекущаяДата();
	
	// RonEXI: Проверка даты отгрузки
	
	Если Объект.ДатаОтгрузки < НачалоДня(Объект.Дата) Тогда
		ТекстСообщения = "Укажите корректную дату отгузки";
		ОбщегоНазначенияКлиентСервер.ДобавитьОшибкуПользователю(Ошибки, "Объект.ДатаОтгрузки", ТекстСообщения);
	КонецЕсли;
	
	// { Васильев Александр Леонидович [27.01.2015]
	// Нет документа установки лимита -- все дни рабочие :)
	ДокументПлановыйЛимит = Документы.ПлановыйЛимит.ПолучитьДокументЗаПериод(ТекущийОбъект.Подразделение, ТекущийОбъект.ДатаОтгрузки, Истина);
	// } Васильев Александр Леонидович [27.01.2015]
	
	Если ЗначениеЗаполнено(ДокументПлановыйЛимит) Тогда
		
		Запрос = Новый Запрос;
		Запрос.УстановитьПараметр("ДатаОтгрузки", ТекущийОбъект.ДатаОтгрузки);
		Запрос.УстановитьПараметр("Подразделение", ТекущийОбъект.Подразделение);
		Запрос.Текст =
		"ВЫБРАТЬ
		|	ЦеховойЛимит.Период КАК Период
		|ИЗ
		|	РегистрНакопления.ЦеховойЛимит КАК ЦеховойЛимит
		|ГДЕ
		|	ЦеховойЛимит.СтоимостьУслуг > 0
		|	И ЦеховойЛимит.Период = &ДатаОтгрузки
		|	И ЦеховойЛимит.Подразделение = &Подразделение";
		
		ДатаОтгрузкиРабочийДень = Запрос.Выполнить().Выбрать().Количество();
		
		Если ДатаОтгрузкиРабочийДень = 0 Тогда
			
			ТекстСообщения = "В выходные изделия не отгружаем. Выберите другой день.";
			ОбщегоНазначенияКлиентСервер.ДобавитьОшибкуПользователю(Ошибки, "Объект.ДатаОтгрузки", ТекстСообщения);
			
		КонецЕсли;
		
	КонецЕсли;
	
	
	Если НовыеЯщики Тогда
		 ТаблицаДеталиЯщиков = Документы.Спецификация.РазложитьЯщикиНаДетали(ТекущийОбъект);
	КонецЕсли;
		
	СтруктураРаскроя = РегистрыСведений.РаскройДеталей.ПолучитьСтрокуРаскроя(ТекущийОбъект);
	
	ЗаполнитьМатериалы(ТекущийОбъект, Ошибки);
	ЗаполнитьУслуги(ТекущийОбъект, СтруктураРаскроя);
	ЗаполнитьФотопечать(ТекущийОбъект); // говно
	ЗаполнитьОсобыеУслуги(ТекущийОбъект);
	ЗаполнитьОсновныеЦвета(ТекущийОбъект);
	ЗаполнитьКоличествоКоробов(ТекущийОбъект);
	
	Если ТекущийОбъект.КоличествоКоробов > 0 Тогда
		ТекущийОбъект.ДваДняИзготовление = Истина;
	КонецЕсли;
	
	Для Каждого Строка Из ТекущийОбъект.СписокНоменклатуры Цикл
		
		Если Строка.Номенклатура.ДваДняИзготовление Тогда
			ТекущийОбъект.ДваДняИзготовление = Истина;
			Прервать;
		КонецЕсли;
		
	КонецЦикла;
	
	ЛексСервер.УстановитьДатуИзготовленияСпецификации(ТекущийОбъект);
	
	ОбщегоНазначенияКлиентСервер.СообщитьОшибкиПользователю(Ошибки, Отказ);
	
	// { Васильев Александр Леонидович [25.06.2014]
	// Перенести проверку в ОбработкаПроверкиЗаполнения
	Отказ = Отказ ИЛИ ПроверитьДоступностьПодразделениямНаСервере(ТекущийОбъект);//.СписокНоменклатуры, ТекущийОбъект.Подразделение);
	// } Васильев Александр Леонидович [25.06.2014]
	
	Если Отказ Тогда
		СписокНоменклатурыДляЗаполненияРеквизита = Неопределено;
		Возврат;
	КонецЕсли;
	
	Если ТипЗнч(СтруктураРаскроя) = Тип("Структура") Тогда
		
		ТекущийОбъект.СписокЛистовНоменклатуры.Загрузить(СтруктураРаскроя.ТаблицаЛистовНоменклатуры);
		
		ПараметрыЗаписи.Вставить("ДанныеДляРаскроя", СтруктураРаскроя.ДанныеДляРаскроя);
		ПараметрыЗаписи.Вставить("СтрокаКривогоПила", СтруктураРаскроя.СтрокаКривогоПила);
		ПараметрыЗаписи.Вставить("ТаблицаДеталей", СтруктураРаскроя.ТаблицаДеталей);
		ПараметрыЗаписи.Вставить("ЗаписатьРаскрой", Модифицированность);
		ПараметрыЗаписи.Вставить("РисунокКривогоПила", "");
		ПараметрыЗаписи.Вставить("РисунокРаскроя", "");
		ПараметрыЗаписи.Вставить("АлгоритмРаскроя", СтруктураРаскроя.АлгоритмРаскроя);
		
	Иначе
		
		Отказ = Истина;
		СписокНоменклатурыДляЗаполненияРеквизита = Неопределено;
		Сообщить(?(ЗначениеЗаполнено(СтруктураРаскроя), СтруктураРаскроя, "Ошибка раскроя - ошибка неопределена"), СтатусСообщения.ОченьВажное);
		Возврат;
		
	КонецЕсли;
	
	ПередатьВПроизводство = ПараметрыЗаписи.Свойство("ПередатьВПроизводство") И ПараметрыЗаписи.ПередатьВПроизводство;
	
	ТекущийОбъект.ДополнительныеСвойства.Вставить("ПередатьВПроизводство", ПередатьВПроизводство);
	
	СтруктураПроверки = ПроверитьЗаменитьКратность(ТекущийОбъект, Отказ); // Изменяем материал в комплектации по "Кратности"
	УвеличитьМатериалыДоЦелыхЛистов(ТекущийОбъект);
	
	УвеличитьКоличествоМатериаловНаПроцентОтхода(ТекущийОбъект);
	ОкруглитьКоличествоМатериалов(ТекущийОбъект);
	
	////////////////////////////////////////////////////////////////////
	ЗаполнитьСтоимость(ТекущийОбъект); // тут происходит группировка таблицы
	
	ЗаполнитьТаблицуСкладГотовойПродукции(ТекущийОбъект);
	СписокНоменклатурыЗаказчика = ПолучитьСписокНоменклатурыЗаказчика(ТекущийОбъект);
	Элементы.СписокМатериаловЗаказчикаНоменклатура.СписокВыбора.ЗагрузитьЗначения(СписокНоменклатурыЗаказчика.МассивНоменклатуры);
	
	ТекущийОбъект.ТребуетсяПриходМатериаловЗаказчика = Ложь;
	Если ТекущийОбъект.СписокМатериаловЗаказчика.Количество() > 0 Тогда
		ТекущийОбъект.ТребуетсяПриходМатериаловЗаказчика = Истина;
	КонецЕсли;
	
	СписокНоменклатурыДляЗаполненияРеквизита = Неопределено;
	
КонецПроцедуры

&НаКлиенте
Процедура ПриОткрытии(Отказ)
	
	Если Объект.Ссылка.Пустая() Тогда
		ОбновитьСкидки();
	Иначе
		ПоказатьТелефон = Объект.Контрагент = ПредопределенноеЗначение("Справочник.Контрагенты.ЧастноеЛицо") И Объект.Изделие = ПредопределенноеЗначение("Справочник.Изделия.Детали");
		
		СтруктураПараметров = Новый Структура;
		СтруктураПараметров.Вставить("ПоказатьТелефон", ПоказатьТелефон);
		
		ОбновитьЭлементыФормы(ЭтаФорма, СтруктураПараметров);
	КонецЕсли;
	
	ПересчитатьСуммы();
	
	//Если ПовторнаяПроверка Тогда
	//	ТолькоПросмотрФормы = ТолькоПросмотр ИЛИ Элементы.СтраницаМатериалы.ТолькоПросмотр;
	//	ТаблицаДляФормы = Объект.СписокМатериалы;
	//	ОткрытьФормуПодбора("ФормаДетали", ТаблицаДляФормы, Элементы.СписокМатериалы.ТекущиеДанные, Элементы.СписокМатериалы);
	//КонецЕсли;
	
КонецПроцедуры

&НаКлиенте
Процедура ОбработкаВыбора(ВыбранноеЗначение, ИсточникВыбора)
	
	// { Васильев Александр Леонидович [12.12.2014]
	// Растащить по разным обработкам выбора.
	// У каждого элемента есть, нехуй в одном месте держать их.
	// } Васильев Александр Леонидович [12.12.2014]
	
	Если ТипЗнч(ВыбранноеЗначение) = Тип("ДокументСсылка.Договор") Тогда
		
		Договор = ВыбранноеЗначение;
		
	ИначеЕсли ТипЗнч(ВыбранноеЗначение) = Тип("СправочникСсылка.Двери") Тогда
		
		СтрокиДверей = Объект.СписокДверей.НайтиСтроки(Новый Структура("Двери", ВыбранноеЗначение));
		Если СтрокиДверей.Количество() = 0 Тогда
			НоваяСтрока = Объект.СписокДверей.Добавить();
			НоваяСтрока.Двери = ОпределитьДверь(ВыбранноеЗначение, Объект.Ссылка);
		КонецЕсли;
		
		Модифицированность = Истина;
		
	ИначеЕсли ТипЗнч(ВыбранноеЗначение) = Тип("ДокументСсылка.Замер") Тогда
		
		Объект.ДокументОснование = ВыбранноеЗначение;
		
	ИначеЕсли ТипЗнч(ВыбранноеЗначение) = Тип("Структура") И ВыбранноеЗначение.Свойство("Монтажник") Тогда
		
		Модифицированность = Истина;
		Объект.Монтажник = ВыбранноеЗначение.Монтажник;
		Объект.ДатаМонтажа = ВыбранноеЗначение.ДатаМонтажа;
		Объект.ДатаОтгрузки = ЛексКлиентСервер.ПолучитьДатуОтгрузки(Объект.ДатаМонтажа);
		
	КонецЕсли;
	
КонецПроцедуры

#КонецОбласти

#Область Команды

&НаСервере
Функция ПоказатьМатериалПодЗаказ()
	
	ТабДок = Новый ТабличныйДокумент;
	ТабДок.ИмяПараметровПечати = "ПараметрыПечати_Заказ";
	ТабДок.АвтоМасштаб = Истина;
	ТабДок.ОтображатьСетку = Ложь;
	ТабДок.Защита = Истина;
	ТабДок.ТолькоПросмотр = Истина;
	ТабДок.ОтображатьЗаголовки = Ложь;
	
	Макет = Документы.Спецификация.ПолучитьМакет("МатериалПодЗаказ");
	ОбластьШапка = Макет.ПолучитьОбласть("Шапка");
	ОбластьШапкаНоменклатуры = Макет.ПолучитьОбласть("ШапкаНоменклатуры");
	ОбластьСтрока = Макет.ПолучитьОбласть("Строка");
	
	ОбластьШапка.Параметры.СпецификацияНомер = ПрефиксацияОбъектовКлиентСервер.ПолучитьНомерНаПечать(Объект.Номер);
	ТабДок.Вывести(ОбластьШапка);
	ТабДок.Вывести(ОбластьШапкаНоменклатуры);
	
	Запрос = Новый Запрос;
	Запрос.УстановитьПараметр("ТаблицаСпискаНоменклатуры", Объект.СписокНоменклатуры.Выгрузить());
	Запрос.УстановитьПараметр("Период", Объект.Дата);
	Запрос.УстановитьПараметр("Подразделение", Объект.Подразделение);
	
	Запрос.Текст =
	"ВЫБРАТЬ
	|	ВЫРАЗИТЬ(ТаблицаСпискаНоменклатуры.Номенклатура КАК Справочник.Номенклатура) КАК Номенклатура,
	|	ТаблицаСпискаНоменклатуры.Количество,
	|	ТаблицаСпискаНоменклатуры.ЕдиницаИзмерения,
	|	ТаблицаСпискаНоменклатуры.Цена,
	|	ТаблицаСпискаНоменклатуры.РозничнаяСтоимость КАК Стоимость,
	|	ТаблицаСпискаНоменклатуры.ПодЗаказ
	|ПОМЕСТИТЬ втНоменклатура
	|ИЗ
	|	&ТаблицаСпискаНоменклатуры КАК ТаблицаСпискаНоменклатуры
	|ГДЕ
	|	ТаблицаСпискаНоменклатуры.ПодЗаказ
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	втНоменклатура.Номенклатура,
	|	втНоменклатура.Количество,
	|	втНоменклатура.ЕдиницаИзмерения,
	|	втНоменклатура.Цена,
	|	втНоменклатура.Стоимость,
	|	ЦеныНоменклатурыСрезПоследних.Поставщик КАК Поставщик
	|ИЗ
	|	втНоменклатура КАК втНоменклатура
	|		ЛЕВОЕ СОЕДИНЕНИЕ РегистрСведений.ЦеныНоменклатурыПоПодразделениям.СрезПоследних(
	|				&Период,
	|				Подразделение = &Подразделение
	|					И Номенклатура В
	|						(ВЫБРАТЬ
	|							т.Номенклатура
	|						ИЗ
	|							втНоменклатура КАК т)) КАК ЦеныНоменклатурыСрезПоследних
	|		ПО втНоменклатура.Номенклатура = ЦеныНоменклатурыСрезПоследних.Номенклатура";
	
	РезультатЗапроса = Запрос.Выполнить();
	НомерСтроки = 1;
	
	Выборка = РезультатЗапроса.Выбрать();
	Пока Выборка.Следующий() Цикл
		ОбластьСтрока.Параметры.Заполнить(Выборка);
		ОбластьСтрока.Параметры.НомерСтроки = НомерСтроки;
		ТабДок.Вывести(ОбластьСтрока);
		НомерСтроки = 1 + НомерСтроки;
	КонецЦикла;
	
	Возврат ТабДок;
	
КонецФункции

&НаКлиенте
Процедура НаПроверкуИнженеру(Команда)
	
	Если Объект.ЕстьМатериалПодЗаказ И НЕ ЗаполненыПоставщикиНаКлиенте() И НЕ ЛексСервер.СпецификацияПроверенаЛогистом(СтатусСпецификации) Тогда
		НовыйСтатус = ПредопределенноеЗначение("Перечисление.СтатусыСпецификации.ПроверяетсяЛогистом");
	Иначе 
		НовыйСтатус = ПредопределенноеЗначение("Перечисление.СтатусыСпецификации.ПроверяетсяТехнологом");
	КонецЕсли;
	
	СохранитьИИзменитьСтатус(НовыйСтатус);
	
КонецПроцедуры

&НаКлиенте
Процедура НаРасчетНаСервере()
	
	НовыйСтатус = ПредопределенноеЗначение("Перечисление.СтатусыСпецификации.Рассчитывается");
	СохранитьИИзменитьСтатус(НовыйСтатус);
	
КонецПроцедуры

&НаКлиенте
Процедура ЕстьЗамечания(Команда)
	
	Если Объект.ЗамечанияИнженера = "" Тогда
		Текст = "Заполните замечания по спецификации";
		Поле = "Объект.ЗамечанияИнженера";
		ОбщегоНазначенияКлиентСервер.СообщитьПользователю(Текст, ,Поле);
	Иначе
		СохранитьИИзменитьСтатус(ПредопределенноеЗначение("Перечисление.СтатусыСпецификации.ЕстьОшибки"));
	КонецЕсли;
	
КонецПроцедуры

&НаКлиенте
Процедура ПередатьВПроизводство(Команда)
	
	// { Васильев Александр Леонидович [13.02.2014]
	// по идее, передача в производство
	// происходит вместе с проведением спецификации
	// тогда должна сработать ОбработкаПроверкиЗаполнения
	// } Васильев Александр Леонидович [13.02.2014]
	
	УбратьПроверкуПриМодифицированности();
	
	ПараметрыЗаписиДокумента = ПередатьВПроизводствоНаСервере();
	
	Если ПараметрыЗаписиДокумента <> Неопределено Тогда
		
		ПараметрыЗаписиДокумента = ЗаписатьРисункиРаскроя(ПараметрыЗаписиДокумента);
		ЗаписатьСтрокуРаскроя(ПараметрыЗаписиДокумента);
		
		Если Объект.Проведен Тогда
			
			Закрыть();
			
		КонецЕсли;
		
	КонецЕсли;
	
КонецПроцедуры

&НаСервере
Функция ПередатьВПроизводствоНаСервере()
	
	Если НЕ Объект.Дилерский И НЕ ЗначениеЗаполнено(Объект.Технолог) Тогда
		//Nrn. //Дилеры в производство передают сами. Тут и случается жопа
		Объект.Технолог = ПользователиКлиентСервер.ТекущийПользователь().ФизическоеЛицо;
	КонецЕсли; 
	
	СтатусСпецификации = Документы.Спецификация.ПолучитьСтатусСпецификации(Объект.Ссылка);
	
	Если Объект.Дилерский
		И Объект.ЕстьМатериалПодЗаказ
		И НЕ ЛексСервер.СпецификацияПроверенаЛогистом(СтатусСпецификации) Тогда
		ТекстСообщения = "В спецификации есть материал под заказ, согласуйте с логистом";
		ОбщегоНазначенияКлиентСервер.СообщитьПользователю(ТекстСообщения);
		Возврат Неопределено;
	КонецЕсли;
	
	НачатьТранзакцию();
	
	ПараметрыЗаписи = Новый Структура;
	ПараметрыЗаписи.Вставить("РежимЗаписи", РежимЗаписиДокумента.Проведение);
	ПараметрыЗаписи.Вставить("ПередатьВПроизводство", Истина);
	
	Записать(ПараметрыЗаписи);
	
	ЗафиксироватьТранзакцию();
	
	Возврат ПараметрыЗаписи;
	
КонецФункции

&НаКлиенте
Процедура ПроверенаТехнологом(Команда)
	
	СохранитьИИзменитьСтатус(ПредопределенноеЗначение("Перечисление.СтатусыСпецификации.ПроверенТехнологом"));
	
КонецПроцедуры

&НаКлиенте
Процедура ПроверенаЛогистом(Команда)
	
	НовыйСтаутс = ПредопределенноеЗначение("Перечисление.СтатусыСпецификации.ПроверенЛогистом");
	СохранитьИИзменитьСтатус(НовыйСтаутс);
	
КонецПроцедуры

&НаКлиенте
Процедура Подобрать(Команда)
	
	Собрать();
	
КонецПроцедуры

&НаКлиенте
Процедура Фурнитура(Команда)
	
	СчетчикЛДСП = 0;
	КоличествоНужныхРадиусов = 0;
	
	Для каждого Строка Из Объект.СписокМатериалы Цикл
		
		Материал = Строка.Материал;
		СуммаРадиусов = 0;
		ЛДСП = Найти(Материал, "ЛДСП") <> 0;
		СчетчикЛДСП = СчетчикЛДСП + Строка.Количество * ЛДСП;
		КоличествоНужныхРадиусов = ?(ЛДСП И (Строка.РадиусЛевоВерх >= 150 ИЛИ Строка.РадиусЛевоНиз >= 150 ИЛИ Строка.РадиусПравоВерх >= 150 ИЛИ Строка.РадиусПравоНиз >= 150), КоличествоНужныхРадиусов + Строка.Количество, КоличествоНужныхРадиусов);
		
	КонецЦикла;
	
	КоличествоЯщиков = 0;
	
	Для каждого Строка Из Объект.СписокЯщики Цикл
		
		КоличествоЯщиков = КоличествоЯщиков + Строка.КоличествоЯщиков;
		
	КонецЦикла;
	
	Строка = "";
	ПараметрыФурнитуры = ПосчитатьКоличествоКрепежа();
	
	ПараметрыФурнитуры.Вставить("КоличествоДеталейЛДСП", СчетчикЛДСП);
	ПараметрыФурнитуры.Вставить("КоличествоЯщиков", КоличествоЯщиков);
	ПараметрыФурнитуры.Вставить("Подразделение", Объект.Подразделение);
	ПараметрыФурнитуры.Вставить("КоличествоНужныхРадиусов", КоличествоНужныхРадиусов);
	
	ОткрытьФорму("Документ.Спецификация.Форма.ФормаФурнитура", ПараметрыФурнитуры, Элементы.Комплектация);
	
КонецПроцедуры

&НаСервере
Функция ПосчитатьКоличествоКрепежа()
	
	Шуруп16х35черный = 0;
	Шуруп40х35черный = 0;
	Дюбель6х40черный = 0;
	Шуруп30х35черный = 0;
	Шуруп16х35хром = 0;
	Шуруп40х35золото = 0;
	Шуруп16х35золото = 0;
	Шуруп40х35хром = 0;
	ФлянецХромированный = 0;
	Евровинт50 = 0;
	
	ТЗ = Объект.Комплектация.Выгрузить();
	ТЗ.Свернуть("Номенклатура", "Количество");
	
	Для каждого Строка Из ТЗ Цикл
		
		Номенклатура = Справочники.Номенклатура;
		Шуруп16х35черный = ?(Строка.Номенклатура = Номенклатура.Шуруп16х35черный, Строка.Количество, Шуруп16х35черный);
		Шуруп40х35черный = ?(Строка.Номенклатура = Номенклатура.Шуруп40х35черный, Строка.Количество, Шуруп40х35черный);
		Дюбель6х40черный = ?(Строка.Номенклатура = Номенклатура.Дюбель6х40черный, Строка.Количество, Дюбель6х40черный);
		Шуруп30х35черный = ?(Строка.Номенклатура = Номенклатура.Шуруп30х35черный, Строка.Количество, Шуруп30х35черный);
		Шуруп16х35хром = ?(Строка.Номенклатура = Номенклатура.Шуруп16х35хром, Строка.Количество, Шуруп16х35хром);
		Шуруп40х35золото = ?(Строка.Номенклатура = Номенклатура.Шуруп40х35золото, Строка.Количество, Шуруп40х35золото);
		Шуруп16х35золото = ?(Строка.Номенклатура = Номенклатура.Шуруп16х35золото, Строка.Количество, Шуруп16х35золото);
		Шуруп40х35хром = ?(Строка.Номенклатура = Номенклатура.Шуруп40х35хром, Строка.Количество, Шуруп40х35хром);
		Евровинт50 = ?(Строка.Номенклатура = Номенклатура.Евровинт50, Строка.Количество, Евровинт50);
		ФлянецХромированный = ?(Строка.Номенклатура = Номенклатура.ФлянецХромированный, Строка.Количество, ФлянецХромированный);
		
	КонецЦикла;
	
	ПараметрыФурнитуры = Новый Структура;
	
	ПараметрыФурнитуры.Вставить("Шуруп16х35черный", Шуруп16х35черный);
	ПараметрыФурнитуры.Вставить("Шуруп40х35черный", Шуруп40х35черный);
	ПараметрыФурнитуры.Вставить("Дюбель6х40черный", Дюбель6х40черный);
	ПараметрыФурнитуры.Вставить("Шуруп30х35черный", Шуруп30х35черный);
	ПараметрыФурнитуры.Вставить("Шуруп16х35хром", Шуруп16х35хром);
	ПараметрыФурнитуры.Вставить("Шуруп40х35золото", Шуруп40х35золото);
	ПараметрыФурнитуры.Вставить("Шуруп16х35золото", Шуруп16х35золото);
	ПараметрыФурнитуры.Вставить("Шуруп40х35хром", Шуруп40х35хром);
	ПараметрыФурнитуры.Вставить("Евровинт50", Евровинт50);
	ПараметрыФурнитуры.Вставить("ФлянецХромированный", ФлянецХромированный);
	
	Возврат ПараметрыФурнитуры;
	
КонецФункции // ПосчитатьКоличествоКрпежа()

&НаКлиенте
Процедура СотовыеЭлементы(Команда)
	
	АдресТаблицы 			= ПолучитьАдресТаблицы();
	ПараметрыПодбора 	= Новый Структура;
	ПараметрыПодбора.Вставить("АдресТаблицы", АдресТаблицы);
	ПараметрыПодбора.Вставить("Подразделение", Объект.Подразделение);
	ОткрытьФорму("Документ.Спецификация.Форма.ФормаСотовыеЭлементы", ПараметрыПодбора, Элементы.Комплектация);
	
КонецПроцедуры

&НаКлиенте
Процедура ЗаполнитьПоКаталогу(Команда = Неопределено)
	
	ПоказатьОповещениеПользователя("Табличные части изменены");
	
	//Очистка Табличных частей от данных полученных ранее
	ПерезаполнитьТаблицу(Объект.СписокМатериалы);
	ПерезаполнитьТаблицу(Объект.СписокЯщики);
	ПерезаполнитьТаблицу(Объект.Комплектация);
	
	Объект.СписокНоменклатуры.Очистить();
	ОбработкаИзделийПоКаталогу();
	
КонецПроцедуры

&НаКлиенте
Процедура СоздатьЗамер(Команда)
	
	ПараметрыФормы = Новый Структура;
	ПараметрыФормы.Вставить("ФормаСпецификации", "ФормаСпецификации");
	ПараметрыФормы.Вставить("АдресЗамера", Объект.АдресМонтажа);
	ПараметрыФормы.Вставить("Подразделение", Объект.Подразделение);
	ОткрытьФорму("Отчет.ЗамерыИВстречи.Форма.ФормаОтчета", ПараметрыФормы,ЭтаФорма);
	
КонецПроцедуры
#КонецОбласти

#Область События_реквизитов_шапки

&НаКлиенте
Процедура МонтажникОчистка(Элемент, СтандартнаяОбработка)
	
	Модифицированность = Истина;
	Объект.ДатаОтгрузки = Неопределено;
	Объект.ДатаМонтажа = Неопределено;
	
КонецПроцедуры

&НаКлиенте
Процедура ПакетУслугПриИзменении(Элемент)
	
	СтруктураПараметров = Новый Структура;
	ЕстьМонтаж = Объект.ПакетУслуг = ПредопределенноеЗначение("Перечисление.ПакетыУслуг.ДоставкаДоКлиентаИМонтаж");
	СтруктураПараметров.Вставить("ЕстьМонтаж", ЕстьМонтаж);
	ОбновитьЭлементыФормы(ЭтаФорма, СтруктураПараметров);
	
	Если НЕ ЕстьМонтаж Тогда
		
		Объект.Монтажник = Неопределено;
		Объект.ДатаМонтажа = Неопределено;
		
	КонецЕсли;
	
КонецПроцедуры

&НаКлиенте
Процедура ВидОплатыПриИзменении(Элемент)
	
	ПересчитатьСуммы();
	
КонецПроцедуры

&НаКлиенте
Процедура КонтрагентПриИзменении(Элемент)
	
	ПересчитатьСуммы();
	
КонецПроцедуры

&НаКлиенте
Процедура КонтрагентНачалоВыбора(Элемент, ДанныеВыбора, СтандартнаяОбработка)
	
	СтандартнаяОбработка = Ложь;
	ПараметрыФормы = Новый Структура;
	
	Если ЗначениеЗаполнено(Объект.Контрагент) Тогда
		ТекущаяСтрокаКонтрагент = Объект.Контрагент;
	Иначе
		ТекущаяСтрокаКонтрагент = ПредопределенноеЗначение("Справочник.Контрагенты.ЧастноеЛицо");
	КонецЕсли;
	
	ПараметрыФормы.Вставить("ТекущаяСтрока", ТекущаяСтрокаКонтрагент);
	
	ВыбранныйКонтрагент = ОткрытьФормуМодально("Справочник.Контрагенты.ФормаВыбора", ПараметрыФормы);
	Если ВыбранныйКонтрагент <> Неопределено Тогда
		Объект.Контрагент = ВыбранныйКонтрагент;
		
		ПоказатьТелефон = Объект.Контрагент = ПредопределенноеЗначение("Справочник.Контрагенты.ЧастноеЛицо") И Объект.Изделие = ПредопределенноеЗначение("Справочник.Изделия.Детали");
		СтруктураПараметров = Новый Структура;
		СтруктураПараметров.Вставить("ПоказатьТелефон", ПоказатьТелефон);
		ОбновитьЭлементыФормы(ЭтаФорма, СтруктураПараметров);
		ОбновитьСкидки();
		
	КонецЕсли;
	
КонецПроцедуры

&НаКлиенте
Процедура АдресМонтажаНажатие(Элемент, СтандартнаяОбработка)
	
	СтандартнаяОбработка = Ложь;
	
	Если НЕ ЗначениеЗаполнено(Объект.Подразделение) Тогда
		
		ТекстСообщения = "Выберите подразделение!";
		ОбщегоНазначенияКлиентСервер.СообщитьПользователю(ТекстСообщения,, "Подразделение", "Объект");
		
	Иначе
		
		ПараметрыАдреса = Новый Структура;
		ПараметрыАдреса.Вставить("Подразделение", Объект.Подразделение);
		ПараметрыАдреса.Вставить("Километраж", Объект.Километраж);
		
		Если Объект.АдресМонтажа = "Введите адрес" Тогда
			
			СтарыйАдрес = "";
			
		Иначе
			
			СтарыйАдрес = Объект.АдресМонтажа;
			
		КонецЕсли;
		
		ПараметрыАдреса.Вставить("Офис", Объект.Офис);
		ПараметрыАдреса.Вставить("СтарыйАдрес", СтарыйАдрес);
		
		СтруктураАдреса = ОткрытьФормуМодально("ОбщаяФорма.ФормаВводаАдреса", ПараметрыАдреса, ЭтаФорма);
		
		Если ТипЗнч(СтруктураАдреса) = Тип("Структура") Тогда
			
			Объект.АдресМонтажа = СтруктураАдреса.Адрес;
			Объект.Километраж = СтруктураАдреса.Километраж;
			
		КонецЕсли;
		
		Модифицированность = Истина;
		
	КонецЕсли;
	
КонецПроцедуры

&НаКлиенте
Процедура ДоговорНажатие(Элемент, СтандартнаяОбработка)
	
	Если Договор = "Введите договор" Тогда
		
		Записать();
		
		СтандартнаяОбработка = Ложь;
		ПараметрыЗаполнения = Новый Структура;
		ПараметрыЗаполнения.Вставить("Основание", Объект.Ссылка);
		ОткрытьФорму("Документ.Договор.Форма.ФормаДокумента",ПараметрыЗаполнения, ЭтаФорма);
		
	КонецЕсли;
	
КонецПроцедуры

&НаКлиенте
Процедура ПодразделениеПриИзменении(Элемент)
	
	ОбновитьСкидки();
	УведомлениеМатериалПодЗаказ = ПолучитьУведомлениеМатериалПодЗаказ(Объект.Подразделение);
	
КонецПроцедуры

&НаКлиенте
Процедура ОфисОбработкаВыбора(Элемент, ВыбранноеЗначение, СтандартнаяОбработка)
	
	ИзмененГород = ПроверитьГородОфисаНаСервере(ВыбранноеЗначение, Объект.Офис);
	
	Если ИзмененГород Тогда
		
		Объект.АдресМонтажа = "Введите адрес";
		
	КонецЕсли;
	
КонецПроцедуры

&НаСервереБезКонтекста
Функция ПроверитьГородОфисаНаСервере(Офис1, Офис2)
	
	Город1 = ОбщегоНазначения.ЗначениеРеквизитаОбъекта(Офис1, "Город");
	Город2 = ОбщегоНазначения.ЗначениеРеквизитаОбъекта(Офис2, "Город");
	
	Возврат Город1 <> Город2;
	
КонецФункции

&НаКлиенте
Процедура ИзделиеПриИзменении(Элемент)
	
	СтруктураИзделия = ИзделиеПриИзмененииНаСервере(Объект.Изделие, Объект.Контрагент);
	
	Если СтруктураИзделия.ЗапретРедактирования И (Объект.СписокМатериалы.Количество() > 0 ИЛИ Объект.СписокЯщики.Количество() > 0
		ИЛИ Объект.Комплектация.Количество() > 0 ИЛИ Объект.СписокДверей.Количество() > 0 ИЛИ Объект.СписокИзделийПоКаталогу.Количество() > 0) Тогда
		
		Режим = РежимДиалогаВопрос.ДаНет;
		Текст = "Табличные части будут очищены." + Символы.ПС + "Продолжить?" + Символы.ПС + "(В случае отказа Изделие будет - Детали)";
		
		Если Вопрос(Текст, Режим, 0) = КодВозвратаДиалога.Нет Тогда
			Объект.Изделие = ПредопределенноеЗначение("Справочник.Изделия.Детали");
		Иначе
			Объект.СписокМатериалы.Очистить();
			Объект.СписокЯщики.Очистить();
			Объект.Комплектация.Очистить();
			Объект.СписокДверей.Очистить();
			Объект.СписокИзделийПоКаталогу.Очистить();
		КонецЕсли;
	КонецЕсли;
	
	СтруктураПараметров = Новый Структура;
	СтруктураПараметров.Вставить("ЗапретРедактирования", СтруктураИзделия.ЗапретРедактирования);
	СтруктураПараметров.Вставить("Переделка", СтруктураИзделия.Переделка);
	СтруктураПараметров.Вставить("ПоказатьТелефон", СтруктураИзделия.ПоказатьТелефон);
	
	ОбновитьЭлементыФормы(ЭтаФорма, СтруктураПараметров);
	
КонецПроцедуры

&НаКлиенте
Процедура МонтажникНачалоВыбора(Элемент, ДанныеВыбора, СтандартнаяОбработка)
	
	СтандартнаяОбработка = Ложь;
	
	// RonEXI edit: У дилеров всеравно нет прав на РабочиеДниМонтажников, поэтому отключаю выбор монтажника.
	Если Объект.Дилерский Тогда
		Возврат;
	КонецЕсли;
	
	Если (НЕ Объект.Дилерский) И (НЕ ЗначениеЗаполнено(Объект.Офис)) Тогда
		Сообщить("Выберите офис");
		Возврат;	
	КонецЕсли;
	
	ПараметрыФормы = Новый Структура;
	ПараметрыФормы.Вставить("Спецификация",Объект.Ссылка);
	ПараметрыФормы.Вставить("Город",ЛексСервер.ЗначениеРеквизитаОбъекта(Объект.Офис, "Город"));
	
	Если ЗначениеЗаполнено(Объект.Монтажник) Тогда
		ПараметрыФормы.Вставить("Монтажник",Объект.Монтажник);
		ПараметрыФормы.Вставить("ДатаМонтажа",Объект.ДатаМонтажа);
	КонецЕсли;
	
	ОткрытьФорму("Документ.Спецификация.Форма.ФормаВыбораМонтажника", ПараметрыФормы, ЭтаФорма);
	
КонецПроцедуры

#КонецОбласти

#Область События_таблицы_Материалы

&НаКлиенте
Процедура СписокМатериалыОбработкаВыбора(Элемент, ВыбранноеЗначение, СтандартнаяОбработка)
	
	Если ТипЗнч(ВыбранноеЗначение) = Тип("Структура") Тогда
		Если ВыбранноеЗначение.Свойство("АдресХранилища") Тогда
			ЗагрузитьТабличнуюЧасть(ВыбранноеЗначение.АдресХранилища, Элемент.Имя);
		КонецЕсли;
		//Nrn Это не мое, если для чего то нужны - сотрите мой комментарий, если нет - удалить
		Если ВыбранноеЗначение.Свойство("Строка3DРедактор") Тогда
			Объект.Строка3DРедактор = ВыбранноеЗначение.Строка3DРедактор;
		КонецЕсли;
		// Nrn
		
	ИначеЕсли ТипЗнч(ВыбранноеЗначение) = Тип("Строка") Тогда
		
		ЗагрузитьТабличнуюЧасть(ВыбранноеЗначение, Элемент.Имя);
		
	КонецЕсли;
	
КонецПроцедуры

&НаКлиенте
Процедура СписокМатериалыВыбор(Элемент, ВыбраннаяСтрока, Поле, СтандартнаяОбработка)
	
	Собрать();
	
КонецПроцедуры

#КонецОбласти

#Область События_таблицы_Ящики

&НаКлиенте
Процедура СписокЯщикиОбработкаВыбора(Элемент, ВыбранноеЗначение, СтандартнаяОбработка)
	
	ЗагрузитьТабличнуюЧасть(ВыбранноеЗначение, Элемент.Имя);
	
КонецПроцедуры

&НаКлиенте
Процедура СписокЯщикиВыбор(Элемент, ВыбраннаяСтрока, Поле, СтандартнаяОбработка)
	
	Собрать();
	
КонецПроцедуры

#КонецОбласти

#Область События_таблицы_Двери

&НаКлиенте
Процедура ДобавитьНовуюДверь(Команда)
	
	ЗаписатьПустуюСпецификацию();
	
	ПараметрыФормы = Новый Структура("ЗначенияЗаполнения", Новый Структура("Спецификация", Объект.Ссылка));
	Форма = ПолучитьФорму("Справочник.Двери.Форма.ФормаЭлемента", ПараметрыФормы, ЭтаФорма);
	Форма.РежимОткрытияОкна = РежимОткрытияОкнаФормы.БлокироватьОкноВладельца;
	Форма.Открыть();
	
КонецПроцедуры

&НаКлиенте
Процедура ДобавитьДвериСоСпецификации(Команда)
	
	Форма = ПолучитьФорму("Справочник.Двери.Форма.ФормаВыбора", , ЭтаФорма);
	Форма.РежимОткрытияОкна = РежимОткрытияОкнаФормы.БлокироватьОкноВладельца;
	Форма.Открыть();
	
КонецПроцедуры

&НаКлиенте
Процедура СписокДверейВыбор(Элемент, ВыбраннаяСтрока, Поле, СтандартнаяОбработка)
	
	СтандартнаяОбработка = Ложь;
	СсылкаНаДверь = Элемент.ТекущиеДанные.Двери;
	ТолькоПросмотрФормы = ТолькоПросмотр ИЛИ Элементы.СтраницаДвери.ТолькоПросмотр;
	ПараметрыФормы = Новый Структура("Ключ", СсылкаНаДверь);
	ПараметрыФормы.Вставить("ТолькоПросмотр", ТолькоПросмотрФормы);
	ОткрытьФорму("Справочник.Двери.ФормаОбъекта", ПараметрыФормы, ЭтаФорма);
	
КонецПроцедуры

&НаСервереБезКонтекста
Функция ОпределитьДверь(Дверь, Спецификация)
	
	Если Дверь.Спецификация <> Спецификация Тогда
		
		ОбъектДвери = Дверь.ПолучитьОбъект();
		НашаДверь = ОбъектДвери.Скопировать();
		НашаДверь.Спецификация = Спецификация;
		НашаДверь.Записать();
		
		Дверь = НашаДверь.Ссылка;
		
	КонецЕсли;
	
	Возврат Дверь;
	
КонецФункции 

#КонецОбласти

#Область События_таблицы_ИзделияПоКаталогу

&НаКлиенте
Процедура ИзделияПоКаталогуВыбор(Элемент, ВыбраннаяСтрока, Поле, СтандартнаяОбработка)
	
	Собрать();
	
КонецПроцедуры

&НаКлиенте
Процедура ИзделияПоКаталогуОбработкаВыбора(Элемент, ВыбранноеЗначение, СтандартнаяОбработка)
	
	ЗагрузитьТабличнуюЧасть(ВыбранноеЗначение, Элемент.Имя);		
	ЗаполнитьПоКаталогу();
	
КонецПроцедуры

&НаКлиенте
Процедура КомплектацияОбработкаВыбора(Элемент, ВыбранноеЗначение, СтандартнаяОбработка)
	
	Модифицированность = Истина;
	ДобавитьТабЧасть(ВыбранноеЗначение.АдресТаблицы, ВыбранноеЗначение.Таблица);
	
КонецПроцедуры

&НаСервере
Функция ДобавитьТабЧасть(АдресТаблицы, Таблица)
	
	ТЗ = ПолучитьИзВременногоХранилища(АдресТаблицы);
	СправочникНоменклатуры = Справочники.Номенклатура;
	СправочникГрупп = Справочники.НоменклатурныеГруппы;
	МассивСтрок = Новый Массив;
	
	Если ТипЗнч(ТЗ) = Тип("ТаблицаЗначений") Тогда
		
		Для каждого Строка Из Объект.Комплектация Цикл
			
			НужнаяНоменклатурнаяГруппа = Ложь;
			Номенклатура = Строка.Номенклатура;
			Группа = Номенклатура.НоменклатурнаяГруппа;
			
			Если Таблица = "ПодборКомплектации" Тогда
				
				НужнаяНоменклатурнаяГруппа=Истина;
				Предопределенный=Истина;
				
			КонецЕсли;
			
			Если ЗначениеЗаполнено(Группа) Тогда
				
				Если Таблица = "СотовыеЭлементы" Тогда
					
					НужнаяНоменклатурнаяГруппа = Группа = СправочникГрупп.СотовыеПолки ИЛИ Группа = СправочникГрупп.СотовыеЭлементы 
					или Группа = СправочникГрупп.Корзины ИЛИ Группа.ПринадлежитЭлементу(СправочникГрупп.Направляющие);
					
				ИначеЕсли Таблица = "Фурнитура" Тогда
					
					//Можно будет внести уголки, подумаем
					
				КонецЕсли;
				
			КонецЕсли;
			
			Если Таблица = "СотовыеЭлементы" Тогда
				
				Предопределенный = Номенклатура = СправочникНоменклатуры.Прищепки ИЛИ Номенклатура = СправочникНоменклатуры.Наконечник 
				или Номенклатура = СправочникНоменклатуры.Клипсы ИЛИ Номенклатура = СправочникНоменклатуры.Карманы 
				или Номенклатура = СправочникНоменклатуры.КронштейнДляСотовойПолки;
				
			ИначеЕсли Таблица = "Фурнитура" Тогда
				
				Предопределенный = Номенклатура = СправочникНоменклатуры.Шуруп40х35золото ИЛИ Номенклатура = СправочникНоменклатуры.Шуруп16х35золото 
				или Номенклатура = СправочникНоменклатуры.Шуруп40х35хром ИЛИ Номенклатура = СправочникНоменклатуры.Шуруп16х35хром
				или Номенклатура = СправочникНоменклатуры.Евровинт50 ИЛИ Номенклатура = СправочникНоменклатуры.ФлянецХромированный
				или Номенклатура = СправочникНоменклатуры.Шуруп16х35черный ИЛИ Номенклатура = СправочникНоменклатуры.Шуруп30х35черный
				или Номенклатура = СправочникНоменклатуры.Шуруп30х35черный ИЛИ Номенклатура = СправочникНоменклатуры.Дюбель6х40черный;
				
			КонецЕсли;
			
			Если НужнаяНоменклатурнаяГруппа ИЛИ Предопределенный Тогда
				
				МассивСтрок.Добавить(Строка);
				
			КонецЕсли;
			
		КонецЦикла;
		
		Для каждого Элемент Из МассивСтрок Цикл
			
			Объект.Комплектация.Удалить(Элемент);
			
		КонецЦикла;
		
		Для каждого Строчка Из ТЗ Цикл
			
			НоваяСтрока = Объект.Комплектация.Добавить();
			НоваяСтрока.Номенклатура = Строчка.Номенклатура;
			НоваяСтрока.Количество = Строчка.Количество;
			НоваяСтрока.ЕдиницаИзмерения = Строчка.ЕдиницаИзмерения;
			
			Если Таблица = "ПодборКомплектации" Тогда
				
				НоваяСтрока.НомерИзделия=Строчка.НомерИзделия;
				
			КонецЕсли;
			
		КонецЦикла;
		
	КонецЕсли;
	
КонецФункции // ДобавитьТабЧасть()

&НаКлиенте
Процедура КомплектацияПередОкончаниемРедактирования(Элемент, НоваяСтрока, ОтменаРедактирования, Отказ)
	
	ТекущиеДанные = Элементы.Комплектация.ТекущиеДанные;
	
	Если ТекущиеДанные <> Неопределено Тогда
		
		Если ЗначениеЗаполнено(ТекущиеДанные.Номенклатура) Тогда
			
			
			//Дробный = ЛексСервер.ЗначениеРеквизитаОбъекта(ТекущиеДанные.ЕдиницаИзмерения, "Дробный");
			//
			//Если Дробный Тогда
			//	
			//	МаксимальныйРазмерДетали = ЛексСервер.ЗначениеРеквизитаОбъекта(ТекущиеДанные.Номенклатура, "ДлинаДетали");
			//	
			//	Если ТекущиеДанные.Количество > МаксимальныйРазмерДетали Тогда
			//		
			//		Элементы.Комплектация.ТекущиеДанные.Количество = МаксимальныйРазмерДетали;
			//		
			//	КонецЕсли;
			//	
			//КонецЕсли;
			
		КонецЕсли;
		
	КонецЕсли;
	
КонецПроцедуры

&НаСервере
Функция ПроверитьДоступностьПодразделениямНаСервере(ТекущийОбъект) //СписокНоменклатуры, фПодразделение)
	
	СписокМатериаловЗаказчика = Новый ТаблицаЗначений;
	
	// { Васильев Александр Леонидович [27.02.2015]
	Дилер = РольДоступна("ДилерскийДоступКСпецификации") или РольДоступна("ПолныеПрава");
	Отказ = Ложь;
	// Што это за хуйня?
	//А че не так то? Вместо дилера вполне и мы можем перепроводить спецуху
	// } Васильев Александр Леонидович [27.02.2015]
	
	Запрос = Новый Запрос;
	Запрос.УстановитьПараметр("Подразделение", ТекущийОбъект.Подразделение);
	Запрос.УстановитьПараметр("СписокНоменклатуры", ТекущийОбъект.СписокНоменклатуры.Выгрузить());
	Запрос.Текст =
	"ВЫБРАТЬ
	|	ВЫРАЗИТЬ(СписокНоменклатуры.Номенклатура КАК Справочник.Номенклатура) КАК Номенклатура,
	|	СписокНоменклатуры.Количество
	|ПОМЕСТИТЬ СписокНоменклатуры
	|ИЗ
	|	&СписокНоменклатуры КАК СписокНоменклатуры
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ РАЗЛИЧНЫЕ
	|	СписокНоменклатуры.Номенклатура,
	|	СписокНоменклатуры.Количество
	|ИЗ
	|	СписокНоменклатуры КАК СписокНоменклатуры
	|		ЛЕВОЕ СОЕДИНЕНИЕ РегистрСведений.НоменклатураПодразделений КАК НоменклатураПодразделений
	|		ПО (НоменклатураПодразделений.Подразделение = &Подразделение)
	|			И СписокНоменклатуры.Номенклатура = НоменклатураПодразделений.Номенклатура
	|ГДЕ
	|	НЕ ЕСТЬNULL(НоменклатураПодразделений.Доступность, ЛОЖЬ)
	|	И СписокНоменклатуры.Номенклатура.ВидНоменклатуры = ЗНАЧЕНИЕ(Перечисление.ВидыНоменклатуры.Материал)";
	
	РезультатЗапроса = Запрос.Выполнить();
	
	Если НЕ РезультатЗапроса.Пустой() Тогда
		
		СписокМатериаловЗаказчика = ТекущийОбъект.СписокМатериаловЗаказчика.Выгрузить();
		ТекущийОбъект.СписокМатериаловЗаказчика.Очистить();
		
	КонецЕсли;
	
	ВыборкаДетальныеЗаписи = РезультатЗапроса.Выбрать();
	
	Пока ВыборкаДетальныеЗаписи.Следующий() Цикл
		
		Если Дилер Тогда
			
			СтрокаНоменклатуры = СписокМатериаловЗаказчика.Найти(ВыборкаДетальныеЗаписи.Номенклатура, "Номенклатура");
			
			Если СтрокаНоменклатуры = Неопределено Тогда
				
				НоваяСтрока = СписокМатериаловЗаказчика.Добавить();
				НоваяСтрока.Номенклатура = ВыборкаДетальныеЗаписи.Номенклатура;
				
			КонецЕсли;
			
		Иначе
			
			// { Васильев Александр Леонидович [23.02.2015]
			// Переделать на СообщитьОшибкиПользователю
			// } Васильев Александр Леонидович [23.02.2015]	
			
			Сообщение = Новый СообщениеПользователю;
			Сообщение.Текст = "Номенклатура "+ ВыборкаДетальныеЗаписи.Номенклатура + " не доступна для подразделения " + ТекущийОбъект.Подразделение;
			Сообщение.Поле = "" + ВыборкаДетальныеЗаписи.Номенклатура;
			Сообщение.Сообщить();
			Отказ = Истина;
			
		КонецЕсли;
		
	КонецЦикла;
	
	Если СписокМатериаловЗаказчика.Количество() > 0 Тогда
		
		СписокМатериаловЗаказчика.Свернуть("Номенклатура", "Комментарий");
		
	КонецЕсли;
	
	Для каждого Строка Из СписокМатериаловЗаказчика Цикл
		
		НоваяСтрока = ТекущийОбъект.СписокМатериаловЗаказчика.Добавить();
		НоваяСтрока.Номенклатура = Строка.Номенклатура;
		
	КонецЦикла;
	
	//ТекущийОбъект.СписокМатериаловЗаказчика.Загрузить(СписокМатериаловЗаказчика);
	
	Возврат Отказ;
	
КонецФункции

#КонецОбласти

#Область Работа_с_3D_редатором

&НаКлиенте
Функция СформироватьXMLДляФлэш()
	
	Возврат Неопределено;
	
КонецФункции

&НаКлиенте
Процедура УведомлениеМатериалПодЗаказНажатие(Элемент, СтандартнаяОбработка)	
	
	СтандартнаяОбработка = Ложь;
	ТабДок = ПоказатьМатериалПодЗаказ();
	ТабДок.Показать("Материалы под заказ");
	
КонецПроцедуры

&НаКлиенте
Процедура Открыть3дРедактор(Команда)
	
	Заглушка = Истина;
	Записать();
	СпецификацияСсылка = Объект.Ссылка;
	
	Строка3дРедактора = ПолучитьСтроку3дРедактора(СпецификацияСсылка);
	
	Параметры3д = Новый Структура;
	Параметры3д.Вставить("ХранимыйФайл", "Редактор3д");
	Параметры3д.Вставить("Строка3дРедактора", Строка3дРедактора);
	Параметры3д.Вставить("Подразделение", Объект.Подразделение);
	Параметры3д.Вставить("Спецификация", СпецификацияСсылка);
	ОткрытьФорму("Документ.Спецификация.Форма.ФормаФлэш", Параметры3д, Элементы.СписокМатериалы)
	
КонецПроцедуры

&НаСервереБезКонтекста
Функция ПолучитьСтроку3дРедактора(СпецификацияСсылка)
	
	Строка3дРедактора = "";
	Запрос = Новый Запрос;
	Запрос.Текст = 
	"ВЫБРАТЬ
	|	РаскройДеталей.Строка3дРедактора
	|ИЗ
	|	РегистрСведений.РаскройДеталей КАК РаскройДеталей
	|ГДЕ
	|	РаскройДеталей.Объект.Ссылка = &Ссылка";
	
	Запрос.УстановитьПараметр("Ссылка", СпецификацияСсылка);
	
	РезультатЗапроса = Запрос.Выполнить();
	
	ВыборкаДетальныеЗаписи = РезультатЗапроса.Выбрать();
	
	Пока ВыборкаДетальныеЗаписи.Следующий() Цикл
		
		Строка3дРедактора = ВыборкаДетальныеЗаписи.Строка3дРедактора;
		
	КонецЦикла;
	
	Возврат Строка3дРедактора;
	
КонецФункции

&НаКлиенте
Процедура Подбор(Команда)
	
	Пар = Новый Структура();
	Пар.Вставить("Подразделение", Объект.Подразделение);
	Пар.Вставить("Комплектация", УпаковатьКомплектацию());
	ОткрытьФорму("Справочник.Номенклатура.Форма.ФормаПодбора", Пар, Элементы.Комплектация);
	
КонецПроцедуры

&НаСервере
Функция УпаковатьКомплектацию()
	
	АдресТаблицы = ПоместитьВоВременноеХранилище(Объект.Комплектация.Выгрузить());
	Пар = Новый Структура;
	Пар.Вставить("АдресТаблицы", АдресТаблицы);
	
	Возврат Пар;
	
КонецФункции

&НаКлиенте
Процедура ДокументОснованиеПриИзменении(Элемент)
	
	СтруктураПараметров = Новый Структура;
	СтруктураПараметров.Вставить("СоздатьЗамер", НЕ ЗначениеЗаполнено(Объект.ДокументОснование) И НЕ Объект.Дилерский);
	ОбновитьЭлементыФормы(ЭтаФорма, СтруктураПараметров);
	
КонецПроцедуры

&НаКлиенте
Процедура СписокМатериаловПоЗаказПоставщикНачалоВыбора(Элемент, ДанныеВыбора, СтандартнаяОбработка)
	
	Город = ЛексСервер.ЗначениеРеквизитаОбъекта(Объект.Подразделение, "Город");
	
	МассивОтбора = Новый Массив;
	МассивОтбора.Добавить(Новый ПараметрВыбора("Отбор.Поставщик", Истина));
	//МассивОтбора.Добавить(Новый ПараметрВыбора("Отбор.Город", Город));
	МассивОтбора.Добавить(Новый ПараметрВыбора("Отбор.Подразделение", Объект.Подразделение));
	
	Элемент.ПараметрыВыбора = Новый ФиксированныйМассив(МассивОтбора);
	
КонецПроцедуры

&НаКлиенте
Процедура НаРасчет(Команда)
	
	НаРасчетНаСервере();
	
КонецПроцедуры

&НаКлиенте
Процедура СписокМатериаловЗаказчикаНоменклатураОбработкаВыбора(Элемент, ВыбранноеЗначение, СтандартнаяОбработка)
	
	//КоличествоНоменклатуры = 0;
	
	Если ЗначениеЗаполнено(ВыбранноеЗначение) Тогда
		
		//Для каждого Строка Из Объект.СписокНоменклатуры Цикл
		//	
		//	Если Строка.Номенклатура = ВыбранноеЗначение Тогда
		//		
		//		КоличествоНоменклатуры = КоличествоНоменклатуры + Строка.Количество;
		//		
		//	КонецЕсли;
		//	
		//КонецЦикла;
		
		//Элементы.СписокМатериаловЗаказчика.ТекущиеДанные.Количество = КоличествоНоменклатуры;
		МассивНоменклатуры = СписокНоменклатурыЗаказчика.МассивНоменклатуры;
		МассивНоменклатуры.Удалить(МассивНоменклатуры.Найти(ВыбранноеЗначение));
		Элементы.СписокМатериаловЗаказчикаНоменклатура.СписокВыбора.ЗагрузитьЗначения(СписокНоменклатурыЗаказчика.МассивНоменклатуры);
		
	КонецЕсли;
	
КонецПроцедуры

&НаКлиенте
Процедура ДатаОтгрузкиОбработкаВыбора(Элемент, ВыбранноеЗначение, СтандартнаяОбработка)
	
	Если НачалоДня(Объект.Дата) > НачалоДня(ВыбранноеЗначение) Тогда
		
		Предупреждение("Дата отгрузки должна быть больше даты размещения");
		СтандартнаяОбработка = Ложь;
		
	КонецЕсли;
	
КонецПроцедуры

&НаКлиенте
Процедура СписокМатериаловЗаказчикаПередНачаломДобавления(Элемент, Отказ, Копирование, Родитель, Группа, Параметр)
	
	Если Копирование Тогда
		Отказ = Истина;
	КонецЕсли;
	
КонецПроцедуры

&НаКлиенте
Процедура СписокМатериаловЗаказчикаПослеУдаления(Элемент)
	СписокМатериаловЗаказчикаПослеУдаленияНаСервере();
КонецПроцедуры

&НаСервере
Процедура СписокМатериаловЗаказчикаПослеУдаленияНаСервере()
	
	СписокНоменклатурыЗаказчика = ПолучитьСписокНоменклатурыЗаказчика(Объект);
	Элементы.СписокМатериаловЗаказчикаНоменклатура.СписокВыбора.ЗагрузитьЗначения(СписокНоменклатурыЗаказчика.МассивНоменклатуры);
	
КонецПроцедуры

#КонецОбласти