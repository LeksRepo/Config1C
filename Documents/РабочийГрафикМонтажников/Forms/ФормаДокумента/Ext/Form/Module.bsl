
&НаКлиенте
Процедура ЗаполнитьТабель(Команда)
	
	ЗаполнитьТабельНаСервере();
	ОбновитьКоличествоМонтажей();
	
КонецПроцедуры

&НаСервере
Функция ЗаполнитьТабельНаСервере()

	Объект.Табель.Очистить();
	
	ДокОбъект = РеквизитФормыВЗначение("Объект");
	ДокОбъект.ЗаполнитьТабель(Объект.Дата);
	
	ЗначениеВРеквизитФормы(ДокОбъект, "Объект");
    
	
КонецФункции // ЗаполнитьТабель()

&НаКлиенте
Процедура ТабельПередНачаломДобавления(Элемент, Отказ, Копирование, Родитель, Группа)
	
	Отказ = Истина;
	
КонецПроцедуры

&НаКлиенте
Процедура ТабельПередУдалением(Элемент, Отказ)
	
	Отказ = Истина;
	
КонецПроцедуры

&НаСервере
Функция ОбновитьКоличествоМонтажей()
	
	УстановитьПривилегированныйРежим(Истина);
	Результат = "";
	Запрос = Новый Запрос;
	Запрос.УстановитьПараметр("НачалоПериода",НачалоМесяца(Объект.Дата) );
	Запрос.УстановитьПараметр("КонецПериода",КонецМесяца(Объект.Дата));
	Запрос.УстановитьПараметр("Город",Объект.Город);
	Запрос.Текст = 
	"ВЫБРАТЬ
	|	СвободныеМонтажникиОбороты.Период КАК Дата,
	|	СвободныеМонтажникиОбороты.КоличествоМонтажейОборот КАК КоличествоМонтажей
	|ИЗ
	|	РегистрНакопления.СвободныеМонтажники.Обороты(&НачалоПериода, &КонецПериода, День, Город = &Город) КАК СвободныеМонтажникиОбороты
	|
	|УПОРЯДОЧИТЬ ПО
	|	СвободныеМонтажникиОбороты.Период
	|ИТОГИ
	|	СУММА(КоличествоМонтажей)
	|ПО
	|	Дата ПЕРИОДАМИ(ДЕНЬ, &НачалоПериода, &КонецПериода)";
	Выборка = Запрос.Выполнить().Выбрать(ОбходРезультатаЗапроса.ПоГруппировкам,"Дата", "ВСЕ");
	
	Для каждого Строка Из Объект.Табель Цикл
		
		Выборка.Следующий();
		
		Строка.КоличествоМонтажей = Выборка.КоличествоМонтажей; 
		
	КонецЦикла;
	
КонецФункции // ОбновитьСостояниеМонтажей()

&НаКлиенте
Процедура ПриОткрытии(Отказ)
	
	 ОбновитьКоличествоМонтажей();
	
КонецПроцедуры

&НаСервере
Процедура ПриЧтенииНаСервере(ТекущийОбъект)
	ДатыЗапретаИзменения.ОбъектПриЧтенииНаСервере(ЭтаФорма, ТекущийОбъект);
КонецПроцедуры

&НаКлиенте
Процедура Заполнить(Команда)
	
	ЗаполнитьГрафикНаСервере();
	
КонецПроцедуры

&НаСервере
Процедура ЗаполнитьГрафикНаСервере()
	Объект.РабочиеДни.Очистить();
	Дата = Объект.Дата;	
	ДнейВМесяце = (КонецМесяца(Дата) - НачалоМесяца(Дата) + 1)/60/60/24;
	ДеньМесяцаПервоеВоскресенье = (ДеньНедели(НачалоМесяца(Дата)) - 8)*-1;
	Дни = Новый Массив;
	Для Счетчик = 1 По 31 Цикл
		Если Счетчик = ДеньМесяцаПервоеВоскресенье 
			ИЛИ Счетчик = ДеньМесяцаПервоеВоскресенье + 7
			ИЛИ Счетчик = ДеньМесяцаПервоеВоскресенье + 14
			ИЛИ Счетчик = ДеньМесяцаПервоеВоскресенье + 21
			ИЛИ Счетчик = ДеньМесяцаПервоеВоскресенье + 28
			ИЛИ Счетчик > ДнейВМесяце Тогда
			Дни.Вставить(Счетчик, Ложь);
		Иначе
			Дни.Вставить(Счетчик, Истина);
		КонецЕсли;
	КонецЦикла;
	                    	
	Запрос = Новый Запрос;
	Запрос.УстановитьПараметр("Должность", Справочники.Должности.Монтажник);
	Запрос.Текст = 
		"ВЫБРАТЬ
		|	ФизическиеЛица.Ссылка
		|ИЗ
		|	Справочник.ФизическиеЛица КАК ФизическиеЛица
		|ГДЕ
		|	ФизическиеЛица.Должность = &Должность";

	РезультатЗапроса = Запрос.Выполнить();
	Выборка = РезультатЗапроса.Выбрать();
	
	Пока Выборка.Следующий() Цикл	
		НоваяСтрока = Объект.РабочиеДни.Добавить();
		НоваяСтрока.Монтажник = Выборка.Ссылка;
		Для Счетчик = 1 По 31 Цикл
			НоваяСтрока["День"+Счетчик] = Дни.Получить(Счетчик);
		КонецЦикла;		
	КонецЦикла;		
КонецПроцедуры

