
&НаКлиенте
Процедура ОбработкаКоманды(ПараметрКоманды, ПараметрыВыполненияКоманды)
	
	Если ЛексСервер.ПроверитьПодразделение(ПараметрКоманды) Тогда
		ОбщегоНазначенияКлиентСервер.СообщитьПользователю("Выбраны документы разных подразделений.");
		Возврат;
	КонецЕсли;
	
	МассивМакетов = ОпределитьМакеты(ПараметрКоманды);
	
	Если ЗначениеЗаполнено(МассивМакетов) Тогда
		УправлениеПечатьюКлиент.ВыполнитьКомандуПечати("Документ.НарядЗадание", СтроковыеФункцииКлиентСервер.ПолучитьСтрокуИзМассиваПодстрок(МассивМакетов), ПараметрКоманды, ПараметрыВыполненияКоманды, Неопределено);
	Иначе
		Предупреждение("Документы на печать отсутствуют!");
	КонецЕсли;
	
	Для Каждого Наряд Из ПараметрКоманды Цикл 
		ВыгрузитьФайлыPTX(Наряд);
	КонецЦикла;
	
	Для Каждого Наряд Из ПараметрКоманды Цикл 
		ВыгрузитьФайлыDXF(Наряд);
	КонецЦикла;
	
КонецПроцедуры

&НаСервере
Функция ОпределитьМакеты(Документы)
	
	МассивМакетов = Новый Массив;
	МассивМакетов.Добавить("ПечатьХлыстовойМатериал");
	МассивМакетов.Добавить("ПечатьХлыстМатСклад");
	МассивМакетов.Добавить("ПечатьПоследовательностьВыпуска");
	
	Возврат МассивМакетов;
	
КонецФункции

&НаКлиенте
Функция ВыгрузитьФайлыPTX(Документ) Экспорт
	
	Стр = ВыгрузитьСтрокуPTX(Документ);
	
	СтрокаPTX = Стр.СтрокаPTX;
	Подразделение = Стр.Подразделение;
	АдресКомпьютераФРС = Стр.АдресКомпьютераФРС;
	ДатаИзготовления = Стр.ДатаИзготовления;
	НомерНаряда = Стр.НомерНаряда;
	
	Если ЗначениеЗаполнено(Документ)
		И ЗначениеЗаполнено(Подразделение)
		И ЗначениеЗаполнено(АдресКомпьютераФРС) Тогда
		
		Каталог = АдресКомпьютераФРС;
		
		НомерНаряда = СтроковыеФункцииКлиентСервер.УдалитьПовторяющиесяСимволы(НомерНаряда, "0", "Слева");
		ДатаИзготовления = Формат(ДатаИзготовления, "ДЛФ=D");
		ИмяФайла = ДатаИзготовления + "_№" + НомерНаряда+".ptx";
		
		УдалитьФайлы(Каталог + ИмяФайла);
		
		Если СтрокаPTX <> "" Тогда
			
			Попытка
				
				Файл = Новый ЗаписьТекста(Каталог + ИмяФайла, КодировкаТекста.ANSI);
				Файл.Записать(СтрокаPTX);
				Файл.Закрыть();
				
			Исключение
				
				Сообщить("Не удалось выгрузить чертежи для ФРС. Включите компьютер в цеху.");
				КаталогСоздан = Ложь;
				
			КонецПопытки;
			
		КонецЕсли;
		
	КонецЕсли;
	
КонецФункции

&НаКлиенте
Функция ВыгрузитьФайлыDXF(Документ) Экспорт
	
	Стр = ВыгрузитьСтрокиDXF(Документ);
	
	МассивСтрок = Стр.МассивСтрок;
	Подразделение = Стр.Подразделение;
	АдресКомпьютераЧПУ = Стр.АдресКомпьютераЧПУ;
	ДатаИзготовления = Стр.ДатаИзготовления;
	НомерНаряда = Стр.НомерНаряда;
	
	Если ЗначениеЗаполнено(Документ)
		И ЗначениеЗаполнено(Подразделение)
		И ЗначениеЗаполнено(АдресКомпьютераЧПУ) Тогда
		
		Каталог = АдресКомпьютераЧПУ;
		
		НомерНаряда = СтроковыеФункцииКлиентСервер.УдалитьПовторяющиесяСимволы(НомерНаряда, "0", "Слева");
		ДатаИзготовления = Формат(ДатаИзготовления, "ДЛФ=D");
		ИмяПапкиНаряд = ДатаИзготовления + "_№" + НомерНаряда+"\";
		
		УдалитьФайлы(Каталог + ИмяПапкиНаряд);
		
		Если МассивСтрок.Количество()>0 Тогда
			
			Попытка
				
				СоздатьКаталог(Каталог + ИмяПапкиНаряд);
				КаталогСоздан = Истина;
				
			Исключение
				
				Сообщить("Не удалось выгрузить чертежи для ЧПУ. Включите компьютер в цеху.");
				КаталогСоздан = Ложь;
				
			КонецПопытки;
			
			Если КаталогСоздан Тогда
				
				Для Каждого Строка ИЗ МассивСтрок Цикл
					
					СтрокаDXF = Строка.СтрокаDXF;
					НомерСпец = СтроковыеФункцииКлиентСервер.УдалитьПовторяющиесяСимволы(Строка.Номер, "0", "Слева");
					НомерСтроки = Строка.НомерСтроки;
					Файл = Новый ЗаписьТекста(Каталог + ИмяПапкиНаряд + НомерСпец + "_" + НомерСтроки + ".dxf", КодировкаТекста.ANSI);
					Файл.Записать(СтрокаDXF);
					Файл.Закрыть();
					
				КонецЦикла;
				
			КонецЕсли;
			
		КонецЕсли;
		
	КонецЕсли;
	
КонецФункции

&НаСервере
Функция ВыгрузитьСтрокиDXF(Документ) Экспорт
	
	МассивСтрок = Новый Массив();
	
	Если ЗначениеЗаполнено(Документ) 
		И ЗначениеЗаполнено(Документ.Подразделение) 
		И ЗначениеЗаполнено(Документ.Подразделение.АдресКомпьютераЧПУ) Тогда
		
		Запрос = Новый Запрос;
		Запрос.УстановитьПараметр("Наряд", Документ);
		Запрос.Текст =
		"ВЫБРАТЬ
		|	Список.СтрокаDXF,
		|	Список.НомерСтроки КАК НомерСтроки,
		|	Список.Ссылка.Номер КАК Номер,
		|	Список.Ссылка
		|ИЗ
		|	Документ.Спецификация.СписокДеталей КАК Список
		|ГДЕ
		|	Список.Ссылка В
		|			(ВЫБРАТЬ
		|				Список.Спецификация
		|			ИЗ
		|				Документ.НарядЗадание.СписокСпецификаций КАК Список
		|			ГДЕ
		|				Список.Ссылка В (&Наряд))
		|	И Список.ДетальРедактированная
		|
		|УПОРЯДОЧИТЬ ПО
		|	Номер,
		|	НомерСтроки";
		
		Результат = Запрос.Выполнить();
		
		Если НЕ Результат.Пустой() Тогда
			
			Выборка = Результат.Выбрать();
			
			Пока Выборка.Следующий() Цикл
				
				Если ЗначениеЗаполнено(Выборка.СтрокаDXF) Тогда
					
					Стр = Новый Структура();
					Стр.Вставить("Номер", Выборка.Номер);
					Стр.Вставить("НомерСтроки", Выборка.НомерСтроки);
					Стр.Вставить("СтрокаDXF", Выборка.СтрокаDXF);
					
					МассивСтрок.Добавить(Стр);
					
				КонецЕсли;
				
			КонецЦикла;
			
		КонецЕсли;
		
	КонецЕсли;
	
	Стр = Новый Структура();
	
	Стр.Вставить("МассивСтрок", МассивСтрок);
	Стр.Вставить("Подразделение", Документ.Подразделение);
	Стр.Вставить("АдресКомпьютераЧПУ", Документ.Подразделение.АдресКомпьютераЧПУ);
	Стр.Вставить("ДатаИзготовления", Документ.ДатаИзготовления);
	Стр.Вставить("НомерНаряда", Документ.Номер);
	
	Возврат Стр;
	
КонецФункции

&НаСервере
Функция ВыгрузитьСтрокуPTX(Документ) Экспорт
	
	СтрокаPTX = "";
	
	Если ЗначениеЗаполнено(Документ) 
		И ЗначениеЗаполнено(Документ.Подразделение) 
		И ЗначениеЗаполнено(Документ.Подразделение.АдресКомпьютераФРС) Тогда
		
		Запрос = Новый Запрос;
		Запрос.УстановитьПараметр("Наряд", Документ);
		Запрос.Текст =
		"ВЫБРАТЬ
		|	РаскройДеталей.СтрокаPTX КАК СтрокаPTX
		|ИЗ
		|	РегистрСведений.РаскройДеталей КАК РаскройДеталей
		|ГДЕ
		|	РаскройДеталей.Объект = &Наряд";
		
		Результат = Запрос.Выполнить();
		
		Если НЕ Результат.Пустой() Тогда
			
			Выборка = Результат.Выбрать();
			
			Пока Выборка.Следующий() Цикл
				
				Если ЗначениеЗаполнено(Выборка.СтрокаPTX) Тогда
					
					СтрокаPTX = Выборка.СтрокаPTX;
					
				КонецЕсли;
				
			КонецЦикла;
			
		КонецЕсли;
		
	КонецЕсли;
	
	Стр = Новый Структура();
	
	Стр.Вставить("СтрокаPTX", СтрокаPTX);
	Стр.Вставить("Подразделение", Документ.Подразделение);
	Стр.Вставить("АдресКомпьютераФРС", Документ.Подразделение.АдресКомпьютераФРС);
	Стр.Вставить("ДатаИзготовления", Документ.ДатаИзготовления);
	Стр.Вставить("НомерНаряда", Документ.Номер);
	
	Возврат Стр;
	
КонецФункции
